
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>V∆∞·ªùn C√¢y H·∫°nh Ph√∫c - Thu Ho·∫°ch & Th√°ch Th·ª©c!</title> <!-- Thay ƒë·ªïi ti√™u ƒë·ªÅ -->
	<link rel="stylesheet" href="style-plotlocked-popup.css">
	<link rel="stylesheet" href="style-menu-button.css"> 
	 <link rel="stylesheet" href="style-confirm-sell-all.css"> 
	 <link rel="stylesheet" href="style-progressbar-thoitiet.css">
    <style>
	
	  @keyframes shake {
          0%, 100% { transform: translate(0, 0) rotate(0); }
          10%, 30%, 50%, 70%, 90% { transform: translate(-2px, -1px) rotate(-1deg); }
          20%, 40%, 60%, 80% { transform: translate(2px, 1px) rotate(1deg); }
        }

        @keyframes flash {
            0%, 100% { opacity: 1; transform: translateX(-50%) scale(1.6); }
            50% { opacity: 0.6; transform: translateX(-50%) scale(1.5); }
        }

        .plot.thunderstruck {
          /* <<<< THAY ƒê·ªîI animation-duration th√†nh 2s <<<< */
          animation: shake 2s cubic-bezier(.36,.07,.19,.97) both;
          position: relative;
          z-index: 2;
        }

        /* Icon S·∫•m S√©t (d√πng ::after) */
        .plot::after {
           content: '‚ö°';
           position: absolute;
           top: -8px; /* ƒêi·ªÅu ch·ªânh v·ªã tr√≠ l√™n tr√™n */
           left: 50%;
           transform: translateX(-50%);
           font-size: 1.8rem; /* C·ª° ch·ªØ icon */
           color: #f1c40f; /* M√†u v√†ng */
           text-shadow: 0 0 6px rgba(255, 255, 255, 0.8), 0 0 3px rgba(0,0,0,0.3);
           z-index: 10; /* Ph·∫£i cao h∆°n n·ªôi dung √¥ */
           pointer-events: none; /* Kh√¥ng ch·∫∑n click */
           display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
           opacity: 0; /* B·∫Øt ƒë·∫ßu trong su·ªët */
           transition: opacity 0.2s ease-out; /* Hi·ªáu ·ª©ng m·ªù d·∫ßn khi ·∫©n */
        }

        .plot.thunderstruck::after {
           display: block; /* Hi·ªán icon */
           opacity: 1; /* L√†m icon hi·ªán r√µ */
           animation: flash 0.6s ease-out; /* √Åp d·ª•ng animation flash */
        }
	
	
	
	
		/* --- [M·ªöI] Ki·ªÉu cho √¥ ƒë·∫•t b·ªã kh√¥ --- */
.plot.dry-soil-effect {
    border-style: dashed !important; /* D√πng !important ƒë·ªÉ ghi ƒë√® vi·ªÅn infested n·∫øu c·∫ßn */
    border-color: #e67e22 !important; /* M√†u cam ƒë·∫•t */
    background-color: rgba(210, 180, 140, 0.3); /* M√†u n·ªÅn h∆°i n√¢u nh·∫°t, b√°n trong su·ªët */
    box-shadow: inset 0 0 10px rgba(165, 42, 42, 0.3); /* B√≥ng ƒë·ªï m√†u n√¢u b√™n trong */
}
/* Hover tr√™n √¥ b·ªã kh√¥ */
.plot.dry-soil-effect:not(.locked):hover {
    border-color: #d35400 !important; /* Cam ƒë·∫≠m h∆°n khi hover */
    background-color: rgba(210, 180, 140, 0.4);
}
/* ∆Øu ti√™n m√†u vi·ªÅn infested n·∫øu c·∫£ hai c√πng active */
.plot.infested.dry-soil-effect {
     border-color: #e53935 !important; /* Gi·ªØ m√†u vi·ªÅn ƒë·ªè c·ªßa infested */
}
	
	
	
        /* --- Reset & Ki·ªÉu C∆° B·∫£n --- */
		/* --- [M·ªöI] Ki·ªÉu n√∫t T∆∞·ªõi N∆∞·ªõc --- */
#modal-content-Tuoinuoc {
    background-color: #64b5f6; /* M√†u xanh da tr·ªùi nh·∫°t (Material Blue 300) */
    /* Th√™m hi·ªáu ·ª©ng hover n·∫øu mu·ªën */
}
#modal-content-Tuoinuoc:hover:not(:disabled) {
   background-color: #42a5f5; /* Xanh ƒë·∫≠m h∆°n ch√∫t khi hover */
   opacity: 0.95;
}
/* Ki·ªÉu khi b·ªã disable (gi·ªëng c√°c n√∫t action kh√°c) */
#modal-content-Tuoinuoc:disabled {
    background-color: #bdbdbd;
    cursor: not-allowed;
    transform: none;
    opacity: 0.7;
}
		
		
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px; /* C·ª° ch·ªØ c∆° b·∫£n */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f8ff; /* AliceBlue */
            color: #333;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overscroll-behavior: none; /* Ch·∫∑n k√©o ƒë·ªÉ l√†m m·ªõi tr√™n mobile */
            touch-action: manipulation; /* C·∫£i thi·ªán ph·∫£n h·ªìi ch·∫°m */
            -webkit-tap-highlight-color: transparent; /* B·ªè highlight khi ch·∫°m tr√™n mobile */
        }

        /* --- B·ªë C·ª•c --- */
        #game-container {
            max-width: 900px;
            margin: 10px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }

        #header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px dashed #90ee90;
        }

        #header h1 {
            color: #2e8b57; /* SeaGreen */
            font-size: 2rem;
            margin-bottom: 8px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        #stats-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: #e6f5e6;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1rem;
            flex-wrap: wrap;
            gap: 15px;
            border: 1px solid #c8e6c9;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
            min-width: 120px;
            justify-content: center;
        }

        .stat-item span {
            font-weight: bold;
            color: #3b7554; /* Xanh ƒë·∫≠m h∆°n */
            font-size: 1.05em;
        }

        /* --- Khu V∆∞·ªùn --- */
        #garden {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* L∆∞·ªõi linh ho·∫°t */
            gap: 20px;
            padding: 20px;
            background-color: #d2b48c; /* Tan - t∆∞·ª£ng tr∆∞ng cho ƒë·∫•t */
            border: 6px solid #8b4513; /* SaddleBrown - vi·ªÅn d√†y h∆°n */
            border-radius: 12px;
            margin-bottom: 20px;
            flex-grow: 1;
            min-height: 250px;
            align-content: start;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23a0522d' fill-opacity='0.2' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E"); /* H·ªça ti·∫øt ƒë·∫•t tinh t·∫ø */
        }

        .plot {
            background-color: #a0522d; /* Sienna - ƒë·∫•t t·ªëi h∆°n */
            border: 3px solid #8b4513; /* SaddleBrown */
            border-radius: 10px;
            height: 115px; /* TƒÉng chi·ªÅu cao cho thanh m√°u/ph√¨ nhi√™u */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.25);
            padding-top: 5px;
        }

        /* Hover √¥ ch∆∞a kh√≥a & KH√îNG c·∫±n 0% */
        .plot:not(.locked):not(.barren-soil):hover {
            background-color: #8f5a33;
            transform: scale(1.04);
            border-color: #a0522d;
        }
        /* Hover √¥ c·∫±n 0% */
        .plot.barren-soil:not(.locked):hover {
             background-color: #9d9d9d !important; /* M√†u x√°m hover */
             transform: scale(1.03);
             border-color: #666 !important;
        }

        /* Ch·ªâ ƒë·ªïi m√†u n·ªÅn t·ªëi h∆°n n·∫øu ƒë√£ tr·ªìng v√† ƒë·∫•t KH√îNG c·∫±n 0% */
        .plot.planted:not(.barren-soil) {
            background-color: #5f4c3a;
        }

        /* Ki·ªÉu cho ƒë·∫•t c·∫±n (th√™m l·ªõp .barren-soil) */
        .plot.barren-soil {
            background-color: #a9a9a9 !important; /* DarkGray - Quan tr·ªçng: m√†u ƒë·∫•t 0% */
            border-color: #777 !important; /* Vi·ªÅn x√°m t·ªëi */
        }


        .plot.infested {
             /* D√πng !important ƒë·ªÉ ghi ƒë√® vi·ªÅn kh√°c (k·ªÉ c·∫£ vi·ªÅn barren) */
             border-color: #e53935 !important;
             animation: infestedPulse 1.2s infinite alternate ease-in-out;
        }
        @keyframes infestedPulse {
            from { box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2), 0 0 4px #e53935; }
            to   { box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.3), 0 0 10px #ff6f60; }
        }

        /* --- √î ƒê·∫•t B·ªã Kh√≥a --- */
        .plot.locked {
            /* !important ƒë·ªÉ ch·∫Øc ch·∫Øn ghi ƒë√® barren n·∫øu c√≥ l·ªói */
            background-color: #b0b0b0 !important;
            border-color: #777 !important;
            cursor: not-allowed; /* ƒê·ªïi con tr·ªè */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }
        .plot.locked .plant-visual-container,
        .plot.locked .bars-container, /* ·∫®n thanh bar tr√™n √¥ kh√≥a */
        .plot.locked .plot-info {
            opacity: 0.3; /* L√†m m·ªù n·ªôi dung b√™n trong */
        }
        .plot.locked:hover { /* Hover √¥ b·ªã kh√≥a */
            background-color: #a0a0a0 !important;
            transform: scale(1.02);
            cursor: pointer; /* ƒê·ªïi th√†nh pointer khi c√≥ th·ªÉ mua */
        }
        /* Icon kh√≥a (T√πy ch·ªçn) */
        .plot.locked::before {
            content: 'üîí';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            color: rgba(0, 0, 0, 0.4);
            z-index: 5;
            pointer-events: none; /* Kh√¥ng ch·∫∑n click v√†o √¥ */
        }


        .plant-visual-container {
             position: relative;
             width: 100%;
             height: 55%; /* ƒêi·ªÅu ch·ªânh chi·ªÅu cao */
             display: flex;
             justify-content: center;
             align-items: center;
        }

        .plant-visual {
            /* Container ch·ª©a h√¨nh ·∫£nh */
            line-height: 1;
            text-align: center;
            user-select: none;
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.5s ease, filter 0.5s ease; /* Th√™m filter v√†o transition */
            opacity: 0;
            transform: scale(0.5) rotate(-15deg);
            z-index: 1;
            display: flex; /* D√πng flex ƒë·ªÉ cƒÉn gi·ªØa ·∫£nh */
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .plant-visual img {
            max-width: 70%; /* ƒêi·ªÅu ch·ªânh d·ª±a tr√™n t·ªâ l·ªá ·∫£nh */
            max-height: 70%; /* ƒêi·ªÅu ch·ªânh d·ª±a tr√™n t·ªâ l·ªá ·∫£nh */
            object-fit: contain; /* Scale ·∫£nh ƒë·∫πp */
            transition: filter 0.5s ease; /* Th√™m transition cho filter c·ªßa ·∫£nh */
        }

        .plant-visual.visible {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        .pest-icon {
            position: absolute;
            font-size: 1.1rem;
            color: #dc143c;
            z-index: 2;
            top: 3px;
            right: 3px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            padding: 2px;
            line-height: 1;
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
            animation: wiggle 0.4s infinite ease-in-out;
            text-shadow: 0 0 2px white;
        }

        .plot.infested .pest-icon {
            display: block; /* Hi·ªán khi c√≥ class infested */
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(-8deg) scale(1); }
            50% { transform: rotate(8deg) scale(1.1); }
        }

        /* C√°c Giai ƒêo·∫°n C√¢y (Class c√≥ th·ªÉ √°p d·ª•ng n·∫øu c·∫ßn, nh∆∞ng ch·ªß y·∫øu l√† thay ƒë·ªïi src ·∫£nh) */
        .stage-0 { /* Giai ƒëo·∫°n m·∫ßm n·∫øu c·∫ßn style ri√™ng */ }
        .stage-dead { /* H√¨nh ·∫£nh khi ch·∫øt */
            filter: grayscale(80%) brightness(0.7); /* L√†m ·∫£nh x√°m v√† t·ªëi ƒëi */
        }
        .stage-dead.pest-death img {
            /* C√≥ th·ªÉ th√™m hi·ªáu ·ª©ng ƒë·∫∑c bi·ªát cho ·∫£nh ch·∫øt do s√¢u n·∫øu d√πng chung <img> */
            /* V√≠ d·ª•: filter: grayscale(100%) sepia(30%) brightness(0.6); */
        }

        /* --- Thanh M√°u & Ph√¨ Nhi√™u --- */
         .bars-container {
            width: 85%;
            margin: 3px auto 3px;
            display: flex; /* <<< QUAN TR·ªåNG: Lu√¥n l√† flex ƒë·ªÉ ch·ª©a c√°c thanh b√™n trong */
            flex-direction: column;
            gap: 2px; /* Kho·∫£ng c√°ch gi·ªØa c√°c thanh */
        }

        .bar-wrapper { /* Wrapper cho m·ªói thanh (c·∫£ m√°u v√† ph√¨ nhi√™u) */
             width: 100%;
             height: 6px; /* Chi·ªÅu cao thanh ri√™ng l·∫ª */
             background-color: #555; /* N·ªÅn t·ªëi */
             border-radius: 3px;
             overflow: hidden; /* Gi·ªØ ph·∫ßn fill b√™n trong */
             border: 1px solid #333;
             position: relative; /* Cho nh√£n ti·ªÅm nƒÉng */
        }

        /* <<< QUAN TR·ªåNG: Quy t·∫Øc n√†y ·∫©n THANH M√ÅU khi √¥ ƒë·∫•t KH√îNG c√≥ class .planted */
        .plot:not(.planted) .health-bar-wrapper {
            display: none;
        }
        /* <<< L∆ØU √ù: Kh√¥ng c√≥ quy t·∫Øc t∆∞∆°ng t·ª± cho .fertility-bar-wrapper => Thanh ph√¨ nhi√™u LU√îN ƒë∆∞·ª£c hi·ªÉn th·ªã b·ªüi CSS (n·∫øu cha n√≥ hi·ªÉn th·ªã) */


        .bar-fill { /* Ki·ªÉu fill chung */
            height: 100%;
            width: 100%; /* M·∫∑c ƒë·ªãnh ƒë·∫ßy, JS s·∫Ω ch·ªânh width */
            border-radius: 2px;
            transition: width 0.5s ease-out, background-color 0.5s ease;
            box-shadow: inset 0 -1px 1px rgba(0, 0, 0, 0.2);
        }

         /* Chi ti·∫øt Thanh M√°u */
        .health-bar-fill {
            background-color: #4CAF50; /* Xanh l√° */
        }
        .health-bar-fill.medium-health {
            background-color: #ffeb3b; /* V√†ng */
        }
        .health-bar-fill.low-health {
            background-color: #f44336; /* ƒê·ªè */
        }

         /* Chi ti·∫øt Thanh Ph√¨ Nhi√™u */
        .fertility-bar-fill {
            background-color: #8B4513; /* SaddleBrown */
        }
        .fertility-bar-fill.medium-fertility {
             background-color: #b8860b; /* DarkGoldenrod */
         }
        .fertility-bar-fill.low-fertility {
             background-color: #a9a9a9; /* DarkGray */
         }
         /* Th√™m m√†u cho ƒë·∫•t c·∫±n 0% */
         .fertility-bar-fill.barren {
             background-color: #666 !important; /* M√†u x√°m r·∫•t t·ªëi */
         }


        .plot-info {
            font-size: 0.65rem;
            color: #f5f5f5;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 2px 5px;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            border-radius: 4px;
            width: 95%;
            margin: 0 auto 5px;
            line-height: 1.3;
            min-height: 2.6em; /* Cho ph√©p kho·∫£ng 2 d√≤ng */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Ch·ªâ √°p d·ª•ng khi low nh∆∞ng ch∆∞a barren */
        .plot.low-fertility:not(.barren-soil) .plot-info {
             /* C√≥ th·ªÉ ƒë·ªïi m√†u nh·∫π n·∫øu mu·ªën */
         }
         /* ƒê·ªïi m√†u n·ªÅn/ch·ªØ info khi ƒë·∫•t c·∫±n 0% */
         .plot.barren-soil .plot-info {
             background-color: rgba(40, 40, 40, 0.7) !important;
             color: #bbb !important;
             font-style: italic;
         }

        /* Ghi ƒë√® style c·ªßa barren n·∫øu ƒëang b·ªã s√¢u */
        .plot.infested .plot-info {
            background-color: rgba(180, 0, 0, 0.6) !important;
            color: white !important;
            font-style: normal !important; /* Ghi ƒë√® italic c·ªßa barren n·∫øu ƒëang b·ªã s√¢u */
        }
        /* Text th√¥ng tin cho √¥ c·∫ßn ph√≠ d·ªçn d·∫πp (s√¢u ch·∫øt) */
        .plot-info.needs-cleanup-fee {
             color: #fff !important;
             background-color: rgba(100, 0, 0, 0.7) !important;
             font-weight: bold;
             font-style: normal !important;
         }
         /* Style cho √¥ ƒëang click d·ªçn mi·ªÖn ph√≠ */
         .plot-info.free-cleanup-progress {
            color: #ffe0b2 !important; /* V√†ng nh·∫°t */
            background-color: rgba(60, 60, 0, 0.8) !important;
            font-weight: bold;
            font-style: normal !important;
         }
        /* Text th√¥ng tin cho √¥ b·ªã kh√≥a */
        .plot.locked .plot-info {
            background-color: rgba(50, 50, 50, 0.6);
            color: #ccc;
            font-weight: bold;
            font-style: normal !important;
        }


        /* --- B·∫£ng ƒêi·ªÅu Khi·ªÉn UI --- */
        #ui-panel {
            display: flex;
            justify-content: space-around;
            margin-top: auto;
            padding: 15px 10px;
            background-color: #e6f5e6;
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 15px;
            border-top: 1px solid #c8e6c9;
        }

        .ui-button {
            background-color: #4CAF50; /* Xanh l√° */
            border: none;
            color: white;
            padding: 12px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.2s ease;
            flex-grow: 1;
            min-width: 110px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            font-weight: 500;
        }

        .ui-button:hover:not(:disabled) {
            background-color: #45a049;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }

        .ui-button:active:not(:disabled) {
            background-color: #367c39;
            transform: scale(0.98) translateY(0px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        .ui-button:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            color: #757575;
        }

        /* --- Modals --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.4s ease;
            backdrop-filter: blur(3px);
        }

        @keyframes fadeIn {
            from { opacity: 0; backdrop-filter: blur(0px);}
            to { opacity: 1; backdrop-filter: blur(3px); }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 8% auto;
            padding: 30px;
            border: 1px solid #ccc;
            width: 90%;
            max-width: 480px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
            position: relative;
            animation: slideIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            flex-direction: column;
        }

        @keyframes slideIn {
            from { transform: translateY(-40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }


        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .modal-header h2 {
            color: #2e8b57;
            font-size: 1.6rem;
        }

        .close-button {
            color: #999;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            transform: rotate(90deg);
        }

        /* --- Tab C·ª≠a H√†ng / Kho ƒê·ªì --- */
        .tabs-container { /* Container chung cho c√°c tab */
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }

        .tab-button { /* Ki·ªÉu n√∫t tab chung */
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: #f1f1f1;
            border-bottom: 3px solid transparent;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
            color: #555;
            flex-grow: 1;
            text-align: center;
            border-radius: 6px 6px 0 0;
            margin-right: 2px;
        }

        .tab-button:last-child {
            margin-right: 0;
        }

        .tab-button:hover {
            background-color: #e9e9e9;
        }

        .tab-button.active {
            background-color: #fff;
            border-color: #4CAF50; /* Xanh l√° */
            color: #2e8b57; /* SeaGreen */
        }

        /* --- V·∫≠t Ph·∫©m C·ª≠a H√†ng & Kho --- */
        .item-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* L∆∞·ªõi linh ho·∫°t cho v·∫≠t ph·∫©m */
            gap: 20px;
            max-height: 60vh; /* Gi·ªõi h·∫°n chi·ªÅu cao v√† cho ph√©p cu·ªôn */
            overflow-y: auto;
            padding: 15px 5px 10px 5px;
            scrollbar-width: thin;
            scrollbar-color: #aaa #eee;
            flex-grow: 1;
        }
        /* Chrome/Edge/Safari */
        .item-list::-webkit-scrollbar { width: 8px; }
        .item-list::-webkit-scrollbar-track { background: #eee; border-radius: 4px; }
        .item-list::-webkit-scrollbar-thumb { background-color: #aaa; border-radius: 4px; border: 2px solid #eee; }

        /* ·∫®n danh s√°ch v·∫≠t ph·∫©m kh√¥ng ho·∫°t ƒë·ªông */
        .item-list:not(.active-list) {
            display: none;
        }

        .item-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            background-color: #fff;
            transition: box-shadow 0.3s ease, transform 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .item-card:hover:not(.no-hover) {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }

        .item-icon {
            /* Container cho ·∫£nh icon */
            height: 50px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh cho khu v·ª±c icon */
            margin-bottom: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .item-icon img {
             max-width: 100%;
             max-height: 100%;
             object-fit: contain; /* Scale ·∫£nh ƒë·∫πp */
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1rem;
            color: #444;
            flex-grow: 1; /* Cho ph√©p t√™n chi·∫øm kh√¥ng gian */
            min-height: 2.4em; /* ƒê·∫£m b·∫£o kh√¥ng gian cho hai d√≤ng */
            display: flex; /* CƒÉn gi·ªØa d·ªçc n·∫øu ng·∫Øn */
            align-items: center;
            justify-content: center;
        }

        .item-details {
            font-size: 0.78rem; /* H∆°i nh·ªè h∆°n */
            color: #666; /* X√°m h∆°i t·ªëi h∆°n */
            margin-bottom: 8px;
            line-height: 1.3;
            text-align: left; /* CƒÉn tr√°i chi ti·∫øt */
            padding: 0 5px; /* Th√™m padding ngang */
        }
        .item-details div { /* Th√™m kho·∫£ng c√°ch gi·ªØa c√°c d√≤ng chi ti·∫øt */
           margin-bottom: 3px;
        }
        .item-details div:last-child {
           margin-bottom: 0;
        }

        .item-price, .item-quantity {
            font-size: 0.9rem;
            font-weight: bold;
            color: #3b7554; /* Xanh l√° m·∫∑c ƒë·ªãnh */
            margin-bottom: 12px;
            text-align: center; /* CƒÉn gi·ªØa gi√°/s·ªë l∆∞·ª£ng */
        }
        /* M√†u lo·∫°i v·∫≠t ph·∫©m c·ª• th·ªÉ (c√≥ th·ªÉ t√πy ch·ªânh) */
        .item-price.pesticide, .item-quantity.pesticide { color: #c0392b; }
        .item-price.fertilizer, .item-quantity.fertilizer { color: #8B4513; }

        /* [C·∫¨P NH·∫¨T] Ki·ªÉu hi·ªÉn th·ªã gi√° tr·ªã cho v·∫≠t ph·∫©m thu ho·∫°ch */
        .item-harvest-value {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 6px;
        }
        .item-harvest-value span {
            font-weight: bold;
            color: #d4af37; /* M√†u v√†ng gold */
        }

        /* [C·∫¨P NH·∫¨T] Container b√°n trong kho ƒë·ªì */
        .sell-container {
            display: flex;
            flex-direction: column; /* X·∫øp ch·ªìng l√™n nhau */
            gap: 8px;
            margin-top: 10px;
            align-items: center; /* CƒÉn gi·ªØa */
        }
        .sell-quantity-selector {
            display: flex;
            align-items: center;
            gap: 5px;
            width: 100%;
            justify-content: center;
        }
        .sell-quantity-selector label {
            font-size: 0.75rem;
            color: #555;
            margin-right: 3px;
        }
        .sell-quantity-selector input[type="number"] {
            width: 55px; /* R·ªông h∆°n ch√∫t */
            padding: 4px 6px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.85rem;
            -moz-appearance: textfield;
        }
        .sell-quantity-selector input::-webkit-outer-spin-button,
        .sell-quantity-selector input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .sell-button { /* N√∫t B√°n ch√≠nh */
            background-color: #2ecc71; /* Xanh ng·ªçc */
            border: none;
            color: white;
            padding: 8px 15px; /* To h∆°n m·ªôt ch√∫t */
            text-align: center;
            font-size: 0.8rem; /* To h∆°n m·ªôt ch√∫t */
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            width: 80%; /* Chi·∫øm ph·∫ßn l·ªõn chi·ªÅu r·ªông */
            max-width: 120px; /* Gi·ªõi h·∫°n */
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sell-button:hover:not(:disabled) {
            background-color: #27ae60; /* Xanh ƒë·∫≠m h∆°n */
            transform: scale(1.03);
        }
        .sell-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }


        /* *** Ki·ªÉu S·ªë L∆∞·ª£ng H·∫°t Gi·ªëng *** */
        .seed-quantity-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-bottom: 8px;
        }
        .seed-quantity-selector input[type="number"] {
            width: 50px;
            padding: 4px 6px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
            -moz-appearance: textfield;
        }
        .seed-quantity-selector input::-webkit-outer-spin-button,
        .seed-quantity-selector input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .total-seed-cost {
            font-size: 0.85rem;
            color: #555;
            font-weight: normal;
            display: block;
            margin-bottom: 8px;
            min-height: 1.2em;
        }
        /* *** K·∫øt th√∫c Ki·ªÉu S·ªë L∆∞·ª£ng H·∫°t Gi·ªëng *** */

        .buy-button, .plant-button, .use-button, .action-button {
            background-color: #ff9800; /* Cam - Mua M·∫∑c ƒë·ªãnh */
            border: none;
            color: white;
            padding: 8px 12px;
            text-align: center;
            font-size: 0.85rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            width: 100%;
            margin-top: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .buy-button:hover:not(:disabled), .action-button:hover:not(:disabled), .use-button:hover:not(:disabled) {
            background-color: #f57c00; /* Cam ƒë·∫≠m h∆°n */
            transform: scale(1.02);
        }

        /* M√†u n√∫t h√†nh ƒë·ªông c·ª• th·ªÉ */
        .action-button.treat-pest { background-color: #e74c3c; } /* ƒê·ªè cho thu·ªëc tr·ª´ s√¢u */
        .action-button.treat-pest:hover:not(:disabled) { background-color: #c0392b; }
        .action-button.select-fertilizer { background-color: #8B4513; } /* N√¢u cho ph√¢n b√≥n */
        .action-button.select-fertilizer:hover:not(:disabled) { background-color: #7a3d10; }
        .action-button.clear-plant { background-color: #7f8c8d; } /* X√°m cho d·ªçn d·∫πp */
        .action-button.clear-plant:hover:not(:disabled) { background-color: #6c7a7b; }
        .action-button.clear-plant.costly { background-color: #c0392b; } /* ƒê·ªè nh·∫π cho d·ªçn d·∫πp t·ªën ph√≠ */
        .action-button.clear-plant.costly:hover:not(:disabled) { background-color: #a93226; }
        /* [M·ªöI] M√†u n√∫t B√°n Ngay */
        .action-button.sell-now { background-color: #ffb300; color:#333; font-weight: bold;} /* V√†ng cam */
        .action-button.sell-now:hover:not(:disabled) { background-color: #ffa000; }

        .buy-button:disabled, .plant-button:disabled, .use-button:disabled, .action-button:disabled {
             background-color: #bdbdbd;
             cursor: not-allowed;
             transform: none;
             opacity: 0.7;
         }

        .plant-button {
             background-color: #4CAF50; /* Xanh l√° cho tr·ªìng */
         }
        .plant-button:hover:not(:disabled) {
             background-color: #45a049;
             transform: scale(1.02);
         }
        .use-button { /* Ki·ªÉu cho n√∫t 'S·ª≠ d·ª•ng' trong modal ch·ªçn */
            background-color: #2196F3; /* Xanh d∆∞∆°ng */
        }
        .use-button:hover:not(:disabled) {
            background-color: #1976D2; /* Xanh d∆∞∆°ng ƒë·∫≠m h∆°n */
        }


         /* --- Ki·ªÉu C·ª• Th·ªÉ Modal H√†nh ƒê·ªông C√¢y Tr·ªìng --- */
        #plant-action-modal .modal-content {
            max-width: 450px;
            margin: 15% auto;
        }

        #plant-action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Gi·ªØ nguy√™n 2 c·ªôt */
            gap: 15px;
        }

        /* [C·∫¨P NH·∫¨T] N√∫t Thu Ho·∫°ch v√† B√°n Ngay s·∫Ω chi·∫øm 2 c·ªôt */
        #plant-action-buttons #action-harvest-plant,
        #plant-action-buttons #action-sell-now {
            grid-column: 1 / -1; /* Chi·∫øm t·ª´ c·ªôt 1 ƒë·∫øn h·∫øt */
        }

        .action-button { /* √Åp d·ª•ng cho t·∫•t c·∫£ c√°c n√∫t trong modal h√†nh ƒë·ªông */
            padding: 12px 15px;
            font-size: 0.9rem;
        }

        /* --- Ki·ªÉu C·ª• Th·ªÉ Modal H√†nh ƒê·ªông √î ƒê·∫•t Tr·ªëng --- */
        #empty-plot-action-modal .modal-content {
            max-width: 400px; /* Nh·ªè h∆°n m·ªôt ch√∫t */
            margin: 15% auto;
        }
        #empty-plot-action-buttons {
            display: grid;
            grid-template-columns: 1fr; /* N√∫t x·∫øp ch·ªìng l√™n nhau */
            gap: 10px; /* Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
            margin-top: 10px;
        }
        #empty-plot-action-buttons .action-button {
            padding: 10px 15px; /* Padding n√∫t */
            font-size: 0.95rem;
            text-transform: none; /* Kh√¥ng vi·∫øt hoa */
            letter-spacing: normal;
            background-color: #4CAF50; /* Xanh l√° m·∫∑c ƒë·ªãnh */
        }
         #empty-plot-action-buttons .action-button.fertilize { background-color: #8B4513; } /* N√¢u */
         #empty-plot-action-buttons .action-button.shop { background-color: #ff9800; } /* Cam */

        #empty-plot-action-buttons .action-button:hover:not(:disabled) {
            opacity: 0.9;
            transform: scale(1.01);
        }


        /* --- Khu V·ª±c Tin Nh·∫Øn --- */
        #message-area {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1rem;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.5s ease, bottom 0.5s ease, transform 0.5s ease;
            pointer-events: none;
            white-space: normal; /* M·∫∑c ƒë·ªãnh */
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            max-width: 80%;
        }
        /* Style cho message nhi·ªÅu d√≤ng */
        #message-area.multiline {
             white-space: pre-line; /* Gi·ªØ l·∫°i c√°c d·∫•u xu·ªëng d√≤ng */
        }


        #message-area.show {
            opacity: 1;
            bottom: 30px;
            transform: translateX(-50%) scale(1);
        }
        #message-area:not(.show) {
            transform: translateX(-50%) scale(0.9);
        }

        #message-area.success { background-color: rgba(46, 139, 87, 0.85); color: #fff; }
        #message-area.error { background-color: rgba(220, 20, 60, 0.85); color: #fff; }
        #message-area.warning { background-color: rgba(243, 156, 18, 0.9); color: #333; font-weight: 500; }
        #message-area.info { background-color: rgba(0, 0, 0, 0.75); color: white; }
         /* [M·ªöI] Style cho pest event */
         #message-area.pest-event { background-color: rgba(180, 0, 0, 0.88); color: white; font-weight: bold; }


        /* --- Ch·ªâ B√°o T·∫£i --- */
        #loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.85);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            color: #444;
            backdrop-filter: blur(4px);
            flex-direction: column;
            gap: 15px;
            font-weight: 500;
        }
         /* Animation spinner ƒë∆°n gi·∫£n */
         #loading-indicator::before {
             content: '';
             display: block;
             width: 40px;
             height: 40px;
             border: 4px solid #ccc;
             border-top-color: #2e8b57;
             border-radius: 50%;
             animation: spin 1s linear infinite;
         }
         @keyframes spin {
             to { transform: rotate(360deg); }
         }


        /* --- Tooltip --- */
        .tooltip {
          position: fixed;
          background-color: rgba(0, 0, 0, 0.8);
          color: #fff;
          padding: 8px 12px;
          border-radius: 6px;
          font-size: 0.8rem;
          white-space: pre-line; /* Cho ph√©p xu·ªëng d√≤ng b·∫±ng \n */
          max-width: 200px;   /* Gi·ªõi h·∫°n chi·ªÅu r·ªông */
          z-index: 1001;
          opacity: 0;
          transition: opacity 0.2s ease, top 0.2s ease, left 0.2s ease;
          pointer-events: none;
          left: -9999px;
          top: -9999px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
          line-height: 1.4;
          text-align: center; /* CƒÉn gi·ªØa text tooltip */
        }

        .tooltip.visible {
            opacity: 1;
        }

        /* --- ƒêi·ªÅu Ch·ªânh Responsive --- */
        @media (max-width: 768px) { /* Tablet */
             #garden {
                 grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
                 gap: 15px;
             }
             .plot { height: 105px; }
             .plot.locked::before { font-size: 2rem; }
             .plant-visual img { max-height: 65%; max-width: 65%; }
             .pest-icon { font-size: 1rem; }
             .bar-wrapper { height: 5px; } /* Chi·ªÅu cao thanh bar cho tablet */
             .plot-info { font-size: 0.6rem; min-height: 2.8em; }
        }

        @media (max-width: 600px) { /* Mobile L·ªõn */
            html { font-size: 14px; }
            #game-container { margin: 5px; padding: 15px; border-radius: 10px; }
            #header h1 { font-size: 1.8rem; }
            #stats-bar { font-size: 0.9rem; padding: 8px 10px; gap: 8px; }
            .stat-item { padding: 6px 10px; min-width: 100px; }
            #garden { gap: 12px; padding: 12px; grid-template-columns: repeat(auto-fit, minmax(85px, 1fr)); }
            .plot { height: 100px; border-width: 2px; }
            .plot.locked::before { font-size: 1.8rem; }
            .plant-visual img { max-height: 60%; max-width: 60%; }
             .pest-icon { font-size: 0.9rem; top: 2px; right: 2px; padding: 1px; }
             .bars-container { width: 90%; }
             .bar-wrapper { height: 4px; } /* Chi·ªÅu cao thanh bar cho mobile l·ªõn */
             .plot-info { font-size: 0.55rem; min-height: 3em; width: 95%; padding: 1px 3px; }
            .ui-button { padding: 10px 15px; font-size: 0.9rem; min-width: 95px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
            .modal-content { width: 92%; margin: 12% auto; padding: 20px; }
            #plant-action-modal .modal-content,
            #empty-plot-action-modal .modal-content { margin: 20% auto; width: 85%; }
            .modal-header h2 { font-size: 1.4rem; }
             .tabs-container { margin-bottom: 10px; } /* √Åp d·ª•ng cho c·∫£ shop v√† inventory tabs */
             .tab-button { padding: 8px 15px; font-size: 0.9rem; }
             .item-list { grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 15px; }
             .item-card { padding: 10px; }
             .item-icon { height: 45px; }
             .item-name { font-size: 0.9rem; min-height: 2.2em;}
             .item-details { font-size: 0.75rem; }
             .sell-button { font-size: 0.75rem; padding: 6px 10px; } /* C·∫≠p nh·∫≠t sell-button */
             .sell-quantity-selector input[type="number"] { width: 45px; font-size: 0.8rem;}
             .seed-quantity-selector input[type="number"] { width: 40px; font-size: 0.8rem;}
             .total-seed-cost { font-size: 0.8rem; }
             .buy-button, .plant-button, .action-button, .use-button { font-size: 0.8rem; padding: 6px 10px;}
             #message-area { font-size: 0.9rem; padding: 10px 20px; width: auto; max-width: 90%; bottom: 10px; }
             #message-area.show { bottom: 20px; }
             .tooltip { max-width: 180px; font-size: 0.75rem; }
        }

        @media (max-width: 420px) { /* Mobile Nh·ªè */
             #stats-bar { gap: 5px; }
             .stat-item { padding: 5px 8px; gap: 5px; font-size: 0.85rem; min-width: 90px; }
             .stat-item span { font-size: 1em; }
             #garden { grid-template-columns: repeat(auto-fit, minmax(75px, 1fr)); gap: 10px; padding: 10px; }
             .plot { height: 95px; }
             .plot.locked::before { font-size: 1.6rem; }
             .plant-visual img { max-height: 55%; max-width: 55%; }
             .pest-icon { font-size: 0.8rem; }
             #ui-panel { gap: 8px; padding: 10px 5px; }
             .ui-button { padding: 8px 10px; font-size: 0.8rem; min-width: 80px; }
             .modal-content { margin: 15% auto; padding: 15px; width: 95%; }
             #plant-action-modal .modal-content,
             #empty-plot-action-modal .modal-content { margin: 25% auto; width: 90%; }
             #plant-action-buttons { grid-template-columns: 1fr; } /* X·∫øp ch·ªìng n√∫t */
             /* [C·∫¨P NH·∫¨T] ƒê·∫£m b·∫£o n√∫t harvest/sell now c≈©ng x·∫øp ch·ªìng */
             #plant-action-buttons #action-harvest-plant,
             #plant-action-buttons #action-sell-now {
                 grid-column: 1 / -1; /* Gi·ªØ nguy√™n n·∫øu ƒë√£ ch·ªìng */
             }
             .modal-header h2 { font-size: 1.2rem; }
             .modal-header { padding-bottom: 10px; margin-bottom: 15px; }
             .tabs-container { margin-bottom: 8px; }
             .tab-button { padding: 6px 10px; font-size: 0.8rem; }
             .item-list { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; } /* ƒêi·ªÅu ch·ªânh minmax */
             .item-card { padding: 8px; }
             .item-icon { height: 40px; }
             .item-name { font-size: 0.85rem; min-height: 2em; }
             .item-details { font-size: 0.7rem; }
             .item-harvest-value { font-size: 0.7rem;}
             .sell-button { font-size: 0.7rem; padding: 5px 8px; } /* C·∫≠p nh·∫≠t sell-button */
             .sell-quantity-selector input[type="number"] { width: 40px; font-size: 0.75rem;}
             .sell-quantity-selector label { font-size: 0.7rem; }
             .plot-info { font-size: 0.5rem; min-height: 3.2em; }
              .seed-quantity-selector { gap: 3px; }
              .seed-quantity-selector input[type="number"] { width: 35px; font-size: 0.75rem;}
              .total-seed-cost { font-size: 0.75rem; }
              .buy-button, .plant-button, .action-button, .use-button { font-size: 0.75rem; padding: 5px 8px;}
              .tooltip { max-width: 150px; font-size: 0.7rem;}
        }

        /* --- L·ªõp Ti·ªán √çch --- */
        .hidden {
            display: none;
        }
		/* --- [M·ªöI] Ki·ªÉu n√∫t B√°n H·∫øt --- */
        .sell-button.sell-all-button {
            background-color: #e74c3c; /* M√†u ƒë·ªè */
        }
        .sell-button.sell-all-button:hover:not(:disabled) {
            background-color: #c0392b; /* M√†u ƒë·ªè ƒë·∫≠m h∆°n khi hover */
        }
        .sell-button.sell-all-button:disabled {
            background-color: #f5b7b1; /* M√†u ƒë·ªè nh·∫°t khi b·ªã v√¥ hi·ªáu h√≥a */
             opacity: 0.6;
        }
    </style>
</head>
<body>

    <!-- Ch·ªâ B√°o T·∫£i -->
    <div id="loading-indicator">ƒêang t·∫£i khu v∆∞·ªùn... üå±</div>

    <!-- Container Game Ch√≠nh -->
    <div id="game-container" class="hidden"> <!-- B·∫Øt ƒë·∫ßu ·∫©n, hi·ªán sau khi t·∫£i -->

        <!-- Header -->
        <div id="header">
            <h1>V∆∞·ªùn C√¢y H·∫°nh Ph√∫c</h1>
        </div>
		 <!-- ====== KHU V·ª∞C HI·ªÇN TH·ªä TH·ªúI TI·∫æT (M·ªöI) ====== -->
        <div id="weather-section">
             <div id="weather-info">
                 <span id="weather-icon" title="Th·ªùi ti·∫øt hi·ªán t·∫°i">‚ùì</span>
				 <span id="weather-name">---</span>
                 <span id="weather-timer" title="Th·ªùi gian c√≤n l·∫°i ƒë·∫øn khi ƒë·ªïi th·ªùi ti·∫øt">--:--</span>
             </div>
             <div id="weather-progress-container" class="weather-progress-container"> <!-- Container cho CSS -->
                 <div id="weather-progress-bar" class="weather-progress-bar-fill"></div> <!-- Thanh fill s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t -->
             </div>
        </div>
        <!-- =============================================== -->

        <!-- Thanh Ch·ªâ S·ªë -->
        <div id="stats-bar">
            <div class="stat-item">üí∞ Ti·ªÅn: <span id="currency">0</span></div>
            <div class="stat-item">‚è∞ Gi·ªù: <span id="game-time">--:--</span></div>
            <div class="stat-item">üèûÔ∏è √î ƒë·∫•t: <span id="plot-count">0</span></div> <!-- Ch·ªâ hi·ªÉn th·ªã s·ªë √¥ ƒë√£ m·ªü -->
        </div>
		


        <!-- Khu V∆∞·ªùn -->
        <div id="garden">
            <!-- C√°c √¥ ƒë·∫•t s·∫Ω ƒë∆∞·ª£c t·∫°o v√† c·∫≠p nh·∫≠t b·ªüi JavaScript -->
            <!-- M·ªói √¥ ƒë·∫•t (.plot) s·∫Ω ch·ª©a: -->
            <!-- .plant-visual-container -> .plant-visual (ch·ª©a img), .pest-icon -->
            <!-- .bars-container -> .health-bar-wrapper (ch·ª©a .health-bar-fill), .fertility-bar-wrapper (ch·ª©a .fertility-bar-fill) -->
            <!-- .plot-info -->
        </div>

         <!-- Ph·∫ßn T·ª≠ Tooltip -->
        <div id="tooltip" class="tooltip">N·ªôi dung tooltip</div>

        <!-- B·∫£ng ƒêi·ªÅu Khi·ªÉn UI (N√∫t C·ª≠a H√†ng, Kho) -->
        <div id="ui-panel">
            <button id="open-shop-btn" class="ui-button">üõí C·ª≠a H√†ng</button>
            <button id="open-inventory-btn" class="ui-button">üéí T√∫i ƒê·ªì</button>
          <!-- <button id="save-game-btn" class="ui-button">üíæ L∆∞u Game</button> -->
		  <button id="open-menu-btn" class="ui-button">‚ò∞ Menu</button>
        </div>

    </div> <!-- K·∫øt th√∫c Container Game -->

    <!-- Modal C·ª≠a H√†ng -->
    <div id="shop-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üõí C·ª≠a H√†ng V·∫≠t Ph·∫©m</h2>
                <span class="close-button" onclick="closeModal('shop-modal')">√ó</span>
            </div>
            <!-- Tab C·ª≠a H√†ng -->
            <div id="shop-tabs" class="tabs-container"> <!-- S·ª≠ d·ª•ng class chung -->
                <button class="tab-button shop-tab-button active" data-tab="seeds">H·∫°t gi·ªëng üå±</button>
                <button class="tab-button shop-tab-button" data-tab="tools">Ph√¢n B√≥n & Thu·ªëc üíä</button>
            </div>
            <!-- Danh s√°ch V·∫≠t Ph·∫©m (H·∫°t gi·ªëng) -->
            <div id="shop-seed-list" class="item-list active-list">
                <p id="shop-seeds-empty-message" class="hidden" style="text-align: center; color: #888; grid-column: 1 / -1; padding: 20px 0;">Kh√¥ng c√≥ h·∫°t gi·ªëng n√†o.</p>
            </div>
             <!-- Danh s√°ch V·∫≠t Ph·∫©m (C√¥ng c·ª• - Gi·ªù l√† Ph√¢n B√≥n & Thu·ªëc tr·ª´ s√¢u) -->
            <div id="shop-tool-list" class="item-list">
                 <p id="shop-tools-empty-message" class="hidden" style="text-align: center; color: #888; grid-column: 1 / -1; padding: 20px 0;">Kh√¥ng c√≥ v·∫≠t ph·∫©m n√†o.</p>
            </div>
        </div>
    </div>

    <!-- Modal Kho ƒê·ªì -->
    <div id="inventory-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üéí T√∫i ƒê·ªì C·ªßa B·∫°n</h2>
                <span class="close-button" onclick="closeModal('inventory-modal')">√ó</span>
            </div>
            <!-- Tab Kho ƒê·ªì -->
            <div id="inventory-tabs" class="tabs-container">
                <button class="tab-button inventory-tab-button active" data-tab="harvested">ƒê√£ Thu Ho·∫°ch üß∫</button>
                <button class="tab-button inventory-tab-button" data-tab="purchased">ƒê√£ Mua üõí</button>
            </div>
            <!-- Danh s√°ch V·∫≠t Ph·∫©m ƒê√£ Thu Ho·∫°ch -->
            <div id="inventory-harvested-list" class="item-list active-list">
                <p id="inventory-harvested-empty-message" style="text-align: center; color: #888; grid-column: 1 / -1; padding: 20px 0;">Ch∆∞a thu ho·∫°ch ƒë∆∞·ª£c g√¨...</p>
            </div>
            <!-- Danh s√°ch V·∫≠t Ph·∫©m ƒê√£ Mua -->
            <div id="inventory-purchased-list" class="item-list">
                 <p id="inventory-purchased-empty-message" style="text-align: center; color: #888; grid-column: 1 / -1; padding: 20px 0;">Ch∆∞a mua v·∫≠t ph·∫©m n√†o...</p>
            </div>
        </div>
    </div>

     <!-- Modal Ch·ªçn H·∫°t Gi·ªëng -->
    <div id="seed-selection-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üå± Ch·ªçn H·∫°t Gi·ªëng ƒê·ªÉ Tr·ªìng</h2>
                 <span class="close-button" onclick="closeModal('seed-selection-modal'); currentPlantingPlotId = null;">√ó</span>
            </div>
            <div id="seed-selection-list" class="item-list active-list">
                <p id="seed-selection-empty-message" style="text-align: center; color: #888; grid-column: 1 / -1; padding: 20px 0;">B·∫°n kh√¥ng c√≥ h·∫°t gi·ªëng n√†o (trong kho ƒë·ªì ƒë√£ mua) ƒë·ªÉ tr·ªìng.</p>
            </div>
        </div>
    </div>

    <!-- Modal Ch·ªçn Ph√¢n B√≥n -->
    <div id="fertilizer-selection-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí© Ch·ªçn Ph√¢n B√≥n ƒê·ªÉ S·ª≠ D·ª•ng</h2>
                 <span class="close-button" onclick="closeModal('fertilizer-selection-modal'); currentActionPlotId = null;">√ó</span>
            </div>
            <div id="fertilizer-selection-list" class="item-list active-list">
                <p id="fertilizer-selection-empty-message" style="text-align: center; color: #888; grid-column: 1 / -1; padding: 20px 0;">B·∫°n kh√¥ng c√≥ ph√¢n b√≥n n√†o (trong kho ƒë·ªì ƒë√£ mua).</p>
            </div>
        </div>
    </div>

    <!-- Modal H√†nh ƒê·ªông C√¢y Tr·ªìng -->
    <div id="plant-action-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="plant-action-title">ChƒÉm S√≥c C√¢y Tr·ªìng</h2>
                 <span class="close-button" onclick="closeModal('plant-action-modal'); currentActionPlotId = null;">√ó</span>
            </div>
            <div id="plant-action-buttons">
                <!-- C√°c n√∫t ƒë∆∞·ª£c th√™m ƒë·ªông ho·∫∑c c·∫≠p nh·∫≠t -->
                <!-- N√∫t thu ho·∫°ch & B√°n ngay ƒë∆∞·ª£c th√™m ƒë·ªông L√äN TR√äN n·∫øu c√≥ -->
                <button id="action-treat-pest" class="action-button treat-pest">üíä Tr·ª´ S√¢u</button>
                <button id="action-select-fertilizer" class="action-button select-fertilizer">üí© B√≥n Ph√¢n</button>
                <button id="action-clear-plant" class="action-button clear-plant">‚õèÔ∏è X·ªõi ƒê·∫•t (B·ªè)</button>
            </div>
            <p id="plant-action-info" style="text-align: center; color: #666; margin-top: 15px; font-size: 0.85rem;"></p>
        </div>
    </div>

    <!-- Modal H√†nh ƒê·ªông √î ƒê·∫•t Tr·ªëng -->
    <div id="empty-plot-action-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="empty-plot-action-title">√î ƒê·∫•t Tr·ªëng</h2>
                 <span class="close-button" onclick="closeModal('empty-plot-action-modal'); currentActionPlotId = null;">√ó</span>
            </div>
            <div id="empty-plot-action-buttons">
                <!-- C√°c n√∫t h√†nh ƒë·ªông cho √¥ tr·ªëng s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JS -->
            </div>
             <p id="empty-plot-action-info" style="text-align: center; color: #666; margin-top: 15px; font-size: 0.85rem;"></p>
        </div>
    </div>


    <!-- Khu V·ª±c Tin Nh·∫Øn -->
    <div id="message-area">Tin nh·∫Øn m·∫´u</div>
	<div id="locked-plot-popup" class="modal" style="display: none;"> <!-- Th√™m class modal ƒë·ªÉ c√≥ th·ªÉ ƒë√≥ng b·∫±ng Escape -->
        <div class="popup-content">
            <button class="close-popup-btn" aria-label="ƒê√≥ng">√ó</button>
            <h2>M·ªü Kh√≥a √î ƒê·∫•t</h2>
            <p id="locked-plot-message">B·∫°n c√≥ ch·∫Øc mu·ªën m·ªü kh√≥a √¥ ƒë·∫•t n√†y v·ªõi gi√° ...üí∞?</p>
            <div class="popup-buttons">
                <button id="cancel-buy-plot-btn">H·ªßy B·ªè</button>
                <button id="confirm-buy-plot-btn">Mua Ngay</button>
            </div>
        </div>
    </div>
	
	<div id="confirm-sell-all-modal" class="modal confirm-sell-all-modal" style="display: none;"> <!-- Th√™m class t√πy ch·ªânh -->
        <div class="modal-content confirm-sell-all-content"> <!-- Th√™m class t√πy ch·ªânh -->
            <div class="modal-header">
                <h2>X√°c Nh·∫≠n B√°n H·∫øt</h2>
                <span class="close-button" onclick="closeConfirmSellAllModal()">√ó</span>
            </div>
            <div id="confirm-sell-all-details" style="margin-bottom: 20px; line-height: 1.6;">
                <p>B·∫°n c√≥ ch·∫Øc mu·ªën b√°n h·∫øt <strong id="confirm-sell-item-name"></strong>?</p>
                <p>S·ªë l∆∞·ª£ng: <span id="confirm-sell-quantity"></span></p>
                <p>T·ªïng ti·ªÅn nh·∫≠n ƒë∆∞·ª£c: <strong id="confirm-sell-total-value" style="color: #d4af37;"></strong>üí∞</p>
            </div>
            <div class="popup-buttons" style="display: flex; justify-content: flex-end; gap: 10px;"> <!-- T√°i s·ª≠ d·ª•ng class ho·∫∑c t·∫°o class m·ªõi -->
                <button id="cancel-sell-all-btn" class="ui-button" style="background-color: #7f8c8d;">H·ªßy B·ªè</button>
                <button id="confirm-sell-all-btn" class="ui-button" style="background-color: #e74c3c;">X√°c Nh·∫≠n B√°n</button>
            </div>
        </div>
    </div>
	
	
	
	
	 <!-- Popup Menu Ch√≠nh -->
    <div id="menu-popup" class="modal" style="display: none;"> <!-- D√πng class modal ƒë·ªÉ k·∫ø th·ª´a logic ƒë√≥ng -->
        <div class="menu-popup-content"> <!-- Class ri√™ng cho CSS t√πy ch·ªânh -->
            <span class="close-button" onclick="closeMenuPopup()">√ó</span> <!-- N√∫t ƒë√≥ng ri√™ng -->
            <h2>Menu Ch√≠nh</h2>
            <div class="menu-buttons">
                <button id="planting-history-btn" class="menu-action-button">üìú L·ªãch s·ª≠ tr·ªìng c√¢y</button>
                
                <!-- Th√™m c√°c n√∫t menu kh√°c v√†o ƒë√¢y n·∫øu c·∫ßn -->
            </div>
        </div>
    </div>
	


	 <!-- <<< TH√äM TH·∫∫ AUDIO T·∫†I ƒê√ÇY >>> -->
    <audio id="background-music" loop preload="auto">
        <source src="nhacnen.mp3" type="audio/mpeg">
        Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph√°t √¢m thanh.
    </audio>
    <!-- <<< K·∫æT TH√öC TH·∫∫ AUDIO >>> -->



    <!-- JavaScript -->
    <script>
      // --- H·∫±ng S·ªë v√† C·∫•u H√¨nh ---
	          const DRY_HEALTH_DRAIN_PER_TICK = 0.3; // L∆∞·ª£ng m√°u c√¢y m·∫•t m·ªói gi√¢y khi kh√¥ (c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh)
        const DRY_FERTILITY_DRAIN_PER_TICK = 0.02; // L∆∞·ª£ng % ph√¨ nhi√™u ƒë·∫•t tr·ªëng m·∫•t m·ªói gi√¢y khi kh√¥ (0.02% = 1.2%/ph√∫t)
		// C·∫•u h√¨nh S√©t ƒê√°nh (Thunderstorm - C√ì S√ÅT TH∆Ø∆†NG)
const THUNDERSTORM_STRIKE_CHANCE_PER_TICK = 0.03; // 3% m·ªói gi√¢y KHI C√ì M∆ØA S√âT
const STRIKE_DURATION_MS = 2000;   // 2 gi√¢y hi·ªáu ·ª©ng
const PLANT_HEALTH_DAMAGE = 40;    // S√°t th∆∞∆°ng m√°u c√¢y (Thunderstorm)
const SOIL_FERTILITY_DAMAGE = 20;  // S√°t th∆∞∆°ng ƒë·ªô ph√¨ ƒë·∫•t tr·ªëng (Thunderstorm)
	  // [M·ªöI] C·∫•u h√¨nh S√©t ƒê√°nh H√¨nh ·∫¢nh (Lightning - KH√îNG S√ÅT TH∆Ø∆†NG)
const LIGHTNING_VISUAL_STRIKE_CHANCE_PER_TICK = 0.025; // 2.5% m·ªói gi√¢y KHI CH·ªà C√ì S√âT (c√≥ th·ªÉ ch·ªânh)
        // ============================
		
		
		
		// ƒê·ªãnh nghƒ©a d·ªØ li·ªáu th·ªùi ti·∫øt v·ªõi ID, icon v√† t√™n
const WEATHER_DATA = [
    { id: 'sunny',       icon: '‚òÄÔ∏è', name: 'N·∫Øng g·∫Øt' },
    { id: 'rainy',       icon: 'üåßÔ∏è', name: 'C√≥ m∆∞a' },
    { id: 'thunderstorm',icon: '‚õàÔ∏è', name: 'M∆∞a v√† s·∫•m s√©t' },
    { id: 'rainy_sunny', icon: 'üå¶Ô∏è', name: 'C√≥ m∆∞a v√† n·∫Øng' },
    { id: 'lightning',   icon: 'üå©Ô∏è', name: 'C√≥ s·∫•m s√©t' },
    { id: 'cloudy',      icon: '‚òÅÔ∏è', name: 'C√≥ m√¢y' },
    { id: 'windy',       icon: 'üå™Ô∏è', name: 'C√≥ gi√≥ l·ªëc' } // Gi·∫£ s·ª≠ icon cu·ªëi l√† gi√≥ l·ªëc/tornado
];
		
		
		 const WEATHER_CHANGE_INTERVAL_MS = 5 * 60 * 1000; // 5 ph√∫t (300,000 ms)
       const WEATHER_ICONS = ['‚òÄÔ∏è N·∫Øng g·∫Øt', 'üåßÔ∏è C√≥ m∆∞a', '‚õàÔ∏è M∆∞a v√† s·∫•m s√©t', 'üå¶Ô∏è C√≥ m∆∞a v√† n·∫Øng', 'üå©Ô∏è C√≥ s·∫•m s√©t', '‚òÅÔ∏è C√≥ m√¢y', 'üå™Ô∏è']; // [PHI√äN B·∫¢N C·∫¨P NH·∫¨T V9.3 - Random Pest Per Plot (Online/Offline)]
        console.log("ƒêang t·∫£i Script V∆∞·ªùn C√¢y (v9.3 - Random Pest)...");

        // C·∫•u h√¨nh Game
        const INITIAL_PLOT_COUNT = 6;       // S·ªë √¥ b·∫Øt ƒë·∫ßu
        const INITIAL_CURRENCY = 10;        // Ti·ªÅn kh·ªüi ƒëi·ªÉm
        const BASE_PLOT_COST = 300;         // Gi√° √¥ ƒë·∫•t th·ª© 7 (index 6)
        const PLOT_COST_MULTIPLIER = 2;     // H·ªá s·ªë nh√¢n gi√° √¥ ƒë·∫•t ti·∫øp theo (G·∫§P ƒê√îI)
        const INITIAL_PESTICIDE = 1;        // S·ªë thu·ªëc tr·ª´ s√¢u ban ƒë·∫ßu
        const INITIAL_PLANT_HEALTH = 100;   // M√°u c√¢y t·ªëi ƒëa
        const BASE_FERTILITY = 100;         // ƒê·ªô ph√¨ nhi√™u ƒë·∫•t t·ªëi ƒëa %
        const LOW_FERTILITY_THRESHOLD = 25; // D∆∞·ªõi m·ª©c n√†y, hi·ªán c·∫£nh b√°o UI (thanh bar)
        const BARREN_HARVEST_PENALTY_MULTIPLIER = 1.3; // H·ªá s·ªë nh√¢n th·ªùi gian khi thu ho·∫°ch tr√™n ƒë·∫•t c·∫±n
        const GAME_SAVE_KEY = 'vuonCayHanhPhuc_v9.3_RandomPest'; // <<< KH√ìA L∆ØU M·ªöI
        const TICK_INTERVAL = 1000;         // 1 gi√¢y m·ªôt tick (1000ms)
        const PLANT_GROWTH_STAGES = 4;      // S·ªë giai ƒëo·∫°n h√¨nh ·∫£nh c√¢y
        const MESSAGE_DISPLAY_TIME = 3800;  // Th·ªùi gian hi·ªÉn th·ªã tin nh·∫Øn (ms)
        const TOOLTIP_DELAY = 350;          // ƒê·ªô tr·ªÖ hi·ªÉn th·ªã tooltip (ms)
        const AUTO_SAVE_INTERVAL_TICKS = 60;// T·ª± ƒë·ªông l∆∞u m·ªói 60 tick (60 gi√¢y)
        const HEALTH_REGEN_PER_TICK = 0.2;  // L∆∞·ª£ng m√°u h·ªìi m·ªói tick
        const DEAD_PEST_CLEANUP_COST = 50;  // Ph√≠ d·ªçn c√¢y ch·∫øt do s√¢u
        const DEAD_PEST_FREE_CLEANUP_CLICKS = 20; // S·ªë l·∫ßn click ƒë·ªÉ d·ªçn mi·ªÖn ph√≠
        const PEST_DAMAGE_PER_TICK = 0.5;   // S√°t th∆∞∆°ng s√¢u m·ªói tick (cho c√¢y ƒëang l·ªõn)
        const PEST_DAMAGE_MATURE_REDUCTION_FACTOR = 0.5; // H·ªá s·ªë gi·∫£m s√°t th∆∞∆°ng s√¢u cho c√¢y tr∆∞·ªüng th√†nh
        const HISTORY_SAVE_KEY = 'vuonCayHanhPhuc_v9.3_History'; // C·∫≠p nh·∫≠t c·∫£ kh√≥a l·ªãch s·ª≠ n·∫øu mu·ªën t√°ch bi·ªát
		const MAX_HISTORY_ENTRIES = 150; // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng m·ª•c l·ªãch s·ª≠

        // --- [M·ªöI Req - Random Pest] C·∫•u h√¨nh S√¢u B·ªánh Ng·∫´u Nhi√™n ---
        const PEST_APPEARANCE_CHANCE_PER_TICK_PER_PLOT = 0.0002; // T·ªâ l·ªá s√¢u xu·∫•t hi·ªán m·ªói gi√¢y TR√äN M·ªñI √î ƒê·∫§T H·ª¢P L·ªÜ (0.02%) - C·∫ßn ƒëi·ªÅu ch·ªânh!
        // --- K·∫æT TH√öC C·∫•u h√¨nh S√¢u B·ªánh Ng·∫´u Nhi√™n ---


        // --- D·ªØ Li·ªáu V·∫≠t Ph·∫©m (H·∫°t Gi·ªëng & Ph√¢n B√≥n) ---
        // =======================================================================
        // (Gi·ªØ nguy√™n nh∆∞ v9.2, kh√¥ng c·∫ßn thay ƒë·ªïi ITEM_DATA cho y√™u c·∫ßu n√†y)
        const ITEM_DATA = {
            // H·∫°t gi·ªëng (id, type, name, imageFolder, price, harvestYield(GI√Å TR·ªä B√ÅN M·ªñI ƒê∆†N V·ªä!), growthTime(gi√¢y!), fertilityCost(0-1!))
            'hanhla':   { id: 'hanhla', type: 'seed', name: 'H√†nh l√°', imageFolder: 'Hanhla', price: 1, harvestYield: 2, growthTime: 60, fertilityCost: 0.05 }, // 1p, gi·∫£m 5% ph√¨
            'namrom':   { id: 'namrom', type: 'seed', name: 'N·∫•m r∆°m', imageFolder: 'Namrom', price: 3, harvestYield: 6, growthTime: 60, fertilityCost: 0.05 }, // 1p, gi·∫£m 5% ph√¨
            'raumuong': { id: 'raumuong', type: 'seed', name: 'Rau mu·ªëng', imageFolder: 'Raumuong', price: 1, harvestYield: 3, growthTime: 120, fertilityCost: 0.06 }, // 2p, gi·∫£m 6% ph√¨
            'caithia':  { id: 'caithia', type: 'seed', name: 'C·∫£i th√¨a', imageFolder: 'Caithia', price: 1, harvestYield: 4, growthTime: 120, fertilityCost: 0.07 }, // 2p, gi·∫£m 7% ph√¨
            'dualeo':   { id: 'dualeo', type: 'seed', name: 'D∆∞a leo', imageFolder: 'Dualeo', price: 2, harvestYield: 5, growthTime: 120, fertilityCost: 0.08 }, // 2p, gi·∫£m 8% ph√¨
            'carot':    { id: 'carot', type: 'seed', name: 'C√† r·ªët', imageFolder: 'Carot', price: 1, harvestYield: 5, growthTime: 180, fertilityCost: 0.09 }, // 3p, gi·∫£m 9% ph√¨
            'cachua':   { id: 'cachua', type: 'seed', name: 'C√† chua', imageFolder: 'Cachua', price: 1, harvestYield: 3, growthTime: 180, fertilityCost: 0.04 }, // 3p, gi·∫£m 4% ph√¨
            'bapcai':   { id: 'bapcai', type: 'seed', name: 'B·∫Øp c·∫£i', imageFolder: 'Bapcai', price: 2, harvestYield: 6, growthTime: 180, fertilityCost: 0.08 }, // 3p, gi·∫£m 8% ph√¨
            'bap':      { id: 'bap', type: 'seed', name: 'B·∫Øp (Ng√¥)', imageFolder: 'Bap', price: 4, harvestYield: 8, growthTime: 180, fertilityCost: 0.09 }, // 3p, gi·∫£m 9% ph√¨
            'hanhtay':  { id: 'hanhtay', type: 'seed', name: 'H√†nh t√¢y', imageFolder: 'Hanhtay', price: 5, harvestYield: 9, growthTime: 180, fertilityCost: 0.07 }, // 3p, gi·∫£m 7% ph√¨
            'bido':     { id: 'bido', type: 'seed', name: 'B√≠ ƒë·ªè', imageFolder: 'Bido', price: 5, harvestYield: 9, growthTime: 180, fertilityCost: 0.08 }, // 3p, gi·∫£m 8% ph√¨
            'khoaitay': { id: 'khoaitay', type: 'seed', name: 'Khoai t√¢y', imageFolder: 'Khoaitay', price: 2, harvestYield: 6, growthTime: 180, fertilityCost: 0.07 }, // 3p, gi·∫£m 7% ph√¨
            'toi':      { id: 'toi', type: 'seed', name: 'T·ªèi', imageFolder: 'Toi', price: 3, harvestYield: 7, growthTime: 180, fertilityCost: 0.09 }, // 3p, gi·∫£m 9% ph√¨
            'khoailang':{ id: 'khoailang', type: 'seed', name: 'Khoai lang', imageFolder: 'Khoailang', price: 5, harvestYield: 9, growthTime: 180, fertilityCost: 0.08 }, // 3p, gi·∫£m 8% ph√¨
            'suplo':    { id: 'suplo', type: 'seed', name: 'S√∫p l∆°', imageFolder: 'Suplo', price: 10, harvestYield: 20, growthTime: 240, fertilityCost: 0.10 }, // 4p, gi·∫£m 10% ph√¨
            'othiem':   { id: 'othiem', type: 'seed', name: '·ªöt hi·ªÉm', imageFolder: 'Othiem', price: 3, harvestYield: 7, growthTime: 240, fertilityCost: 0.08 }, // 4p, gi·∫£m 8% ph√¨
            'dudu':     { id: 'dudu', type: 'seed', name: 'ƒêu ƒë·ªß', imageFolder: 'Dudu', price: 3, harvestYield: 10, growthTime: 360, fertilityCost: 0.11 }, // 6p, gi·∫£m 11% ph√¨
            'chuoi':    { id: 'chuoi', type: 'seed', name: 'Chu·ªëi', imageFolder: 'Chuoi', price: 4, harvestYield: 12, growthTime: 540, fertilityCost: 0.12 }, // 9p, gi·∫£m 12% ph√¨
            'mangtay':  { id: 'mangtay', type: 'seed', name: 'MƒÉng t√¢y', imageFolder: 'Mangtay', price: 12, harvestYield: 30, growthTime: 720, fertilityCost: 0.15 }, // 12p, gi·∫£m 15% ph√¨

             // C√¥ng c·ª• (Thu·ªëc tr·ª´ s√¢u + Ph√¢n B√≥n)
             // id, type, name, imageFolder, imageFile, price, description, [fertilityBoost]
            'pesticide': {
                id: 'pesticide', type: 'tool', name: 'Thu·ªëc Tr·ª´ S√¢u',
                imageFolder: 'Hinhanh/Thuoctrusau', imageFile: 'Thuoctrusau1.png',
                price: 2,
                description: 'Lo·∫°i b·ªè s√¢u b·ªánh kh·ªèi m·ªôt c√¢y tr·ªìng.'
            },
            'fertilizer_basic': {
                id: 'fertilizer_basic', type: 'tool', name: 'Ph√¢n B√≥n C∆° B·∫£n', imageFolder: 'Hinhanh/Phanbon', imageFile: 'Phanboncoban.png',
                price: 2,
                fertilityBoost: 0.20, description: 'B·ªï sung 20% ƒë·ªô ph√¨ nhi√™u cho ƒë·∫•t.'
            },
            'fertilizer_growth': {
                id: 'fertilizer_growth', type: 'tool', name: 'Ph√¢n B√≥n TƒÉng Tr∆∞·ªüng', imageFolder: 'Hinhanh/Phanbon', imageFile: 'Phanbontangtruong.png',
                price: 20, fertilityBoost: 0.30, description: 'B·ªï sung 30% ƒë·ªô ph√¨ nhi√™u cho ƒë·∫•t.'
            },
            'fertilizer_protect': {
                id: 'fertilizer_protect', type: 'tool', name: 'Ph√¢n B√≥n B·∫£o V·ªá', imageFolder: 'Hinhanh/Phanbon', imageFile: 'Phanbonbaove.png',
                price: 40, fertilityBoost: 0.40, description: 'B·ªï sung 40% ƒë·ªô ph√¨ nhi√™u cho ƒë·∫•t.'
            },
            'fertilizer_premium': {
                id: 'fertilizer_premium', type: 'tool', name: 'Ph√¢n B√≥n Cao C·∫•p', imageFolder: 'Hinhanh/Phanbon', imageFile: 'Phanboncaocap.png',
                price: 80, fertilityBoost: 0.60, description: 'B·ªï sung 60% ƒë·ªô ph√¨ nhi√™u cho ƒë·∫•t.'
            },
            'fertilizer_special': {
                id: 'fertilizer_special', type: 'tool', name: 'Ph√¢n B√≥n ƒê·∫∑c Bi·ªát', imageFolder: 'Hinhanh/Phanbon', imageFile: 'Phanbondacbiet.png',
                price: 150, fertilityBoost: 0.80, description: 'B·ªï sung 80% ƒë·ªô ph√¨ nhi√™u cho ƒë·∫•t.'
            }
        };

        // --- Tr·∫°ng Th√°i Game ---
// ====================
let gameState = {
    currency: INITIAL_CURRENCY,
    plots: [], // M·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng √¥ ƒë·∫•t { ..., fertility, causeOfDeath, pestDeathClickCount, barrenHarvestPenaltyFactor }
    maxUnlockedPlots: INITIAL_PLOT_COUNT,
    inventory: { // Kho ƒë·ªì v·∫≠t ph·∫©m ƒê√É MUA
         pesticide: INITIAL_PESTICIDE
         // H·∫°t gi·ªëng & Ph√¢n b√≥n ƒë∆∞·ª£c th√™m ƒë·ªông khi mua
    },
    harvestedItems: { // Kho ƒë·ªì v·∫≠t ph·∫©m ƒê√É THU HO·∫†CH
        // V√≠ d·ª•: 'hanhla': 5, 'cachua': 2
    },
    lastUpdateTimestamp: Date.now(),
    gameStartTime: Date.now(),
    totalPlayTime: 0,
    actionHistory: [], // <<< Gi·ªØ nguy√™n: M·∫£ng l∆∞u l·ªãch s·ª≠ h√†nh ƒë·ªông
    // --- KH√îNG C√íN TR·∫†NG TH√ÅI PEST EVENT ---
    // isPestEventActive: false,
    // pestEventStartTime: 0
	
	 currentWeather: WEATHER_DATA[0],             // <<< THAY ƒê·ªîI: L∆∞u c·∫£ object, m·∫∑c ƒë·ªãnh l√† sunny {id, icon, name}
    nextWeatherChangeTimestamp: 0,               // Timestamp (ms) c·ªßa l·∫ßn ƒë·ªïi th·ªùi ti·∫øt k·∫ø ti·∫øp
    currentWeatherStartTime: 0,                  // Timestamp b·∫Øt ƒë·∫ßu chu k·ª≥ th·ªùi ti·∫øt hi·ªán t·∫°i
	nextDryCheckTimestamp: 0 // <<< BI·∫æN THEO D√ïI CHECK KH√î H·∫†N >>>
	 
};

		// --- H√†m Ti·ªán √çch M·ªõi: Ghi L·ªãch S·ª≠ H√†nh ƒê·ªông ---
// ==============================================
/**
 * Ghi l·∫°i m·ªôt h√†nh ƒë·ªông v√†o l·ªãch s·ª≠ game.
 * @param {string} type Lo·∫°i h√†nh ƒë·ªông (e.g., 'plant', 'harvest', 'fertilize', 'pest', 'clear', 'sell_direct', 'buy_plot', 'buy_item')
 * @param {number|null} plotId ID √¥ ƒë·∫•t li√™n quan (null n·∫øu kh√¥ng √°p d·ª•ng)
 * @param {string} details M√¥ t·∫£ chi ti·∫øt h√†nh ƒë·ªông
 * @param {string} icon Bi·ªÉu t∆∞·ª£ng emoji cho h√†nh ƒë·ªông
 * @param {string|null} itemId ID v·∫≠t ph·∫©m li√™n quan (null n·∫øu kh√¥ng √°p d·ª•ng)
 */
function logAction(type, plotId, details, icon, itemId = null) {
    try {
        const newEntry = {
            timestamp: Date.now(),
            type: type,
            plotId: plotId, // C√≥ th·ªÉ l√† null
            details: details,
            icon: icon,
            itemId: itemId // C√≥ th·ªÉ l√† null
        };

        // Th√™m v√†o ƒë·∫ßu m·∫£ng (m·ªõi nh·∫•t l√™n tr∆∞·ªõc)
        gameState.actionHistory.unshift(newEntry);

        // Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc m·∫£ng l·ªãch s·ª≠
        if (gameState.actionHistory.length > MAX_HISTORY_ENTRIES) {
            gameState.actionHistory.length = MAX_HISTORY_ENTRIES; // C·∫Øt b·ªè ph·∫ßn t·ª≠ c≈© nh·∫•t
            // Ho·∫∑c d√πng splice/pop n·∫øu mu·ªën: gameState.actionHistory.pop();
        }

        // L∆∞u l·ªãch s·ª≠ v√†o localStorage ri√™ng bi·ªát
        localStorage.setItem(HISTORY_SAVE_KEY, JSON.stringify(gameState.actionHistory));
        // console.log("ƒê√£ ghi log h√†nh ƒë·ªông:", details); // B·∫≠t n·∫øu c·∫ßn debug
    } catch (error) {
        console.error("L·ªói khi ghi l·ªãch s·ª≠ h√†nh ƒë·ªông:", error, {type, plotId, details, icon, itemId});
        // Kh√¥ng n√™n d·ª´ng game ch·ªâ v√¨ l·ªói log
    }
}





        // --- Bi·∫øn To√†n C·ª•c ---
		const backgroundMusic = document.getElementById('background-music');
		let musicStarted = false; // C·ªù ƒë·ªÉ ƒë·∫£m b·∫£o nh·∫°c ch·ªâ b·∫Øt ƒë·∫ßu m·ªôt l·∫ßn
        // =====================
        let gameLoopInterval = null;
        let messageTimeout = null;
        let currentPlantingPlotId = null;
        let currentActionPlotId = null;
        let tooltipTimeout = null;
        let currentTooltipTarget = null;
        let tooltipHideTimeout = null;
        let tickCounter = 0;
		let weatherUpdateNeeded = true; // C·ªù ƒë·ªÉ y√™u c·∫ßu c·∫≠p nh·∫≠t UI th·ªùi ti·∫øt l·∫ßn ƒë·∫ßu
        // --- Tham Chi·∫øu Ph·∫ßn T·ª≠ DOM ---
        // ==============================
        const loadingIndicator = document.getElementById('loading-indicator');
        const gameContainer = document.getElementById('game-container');
        const gardenElement = document.getElementById('garden');
        const currencyElement = document.getElementById('currency');
        const gameTimeElement = document.getElementById('game-time');
        const plotCountElement = document.getElementById('plot-count');
        const messageArea = document.getElementById('message-area');
        const shopModal = document.getElementById('shop-modal');
        const inventoryModal = document.getElementById('inventory-modal');
        const seedSelectionModal = document.getElementById('seed-selection-modal');
        const fertilizerSelectionModal = document.getElementById('fertilizer-selection-modal');
        const plantActionModal = document.getElementById('plant-action-modal');
        const emptyPlotActionModal = document.getElementById('empty-plot-action-modal');
        const shopTabsContainer = document.getElementById('shop-tabs');
        const shopSeedList = document.getElementById('shop-seed-list');
        const shopToolList = document.getElementById('shop-tool-list');
        const shopSeedsEmptyMessage = document.getElementById('shop-seeds-empty-message');
        const shopToolsEmptyMessage = document.getElementById('shop-tools-empty-message');
        const inventoryTabsContainer = document.getElementById('inventory-tabs');
        const inventoryHarvestedList = document.getElementById('inventory-harvested-list');
        const inventoryPurchasedList = document.getElementById('inventory-purchased-list');
        const inventoryHarvestedEmptyMessage = document.getElementById('inventory-harvested-empty-message');
        const inventoryPurchasedEmptyMessage = document.getElementById('inventory-purchased-empty-message');
        const seedSelectionList = document.getElementById('seed-selection-list');
        const seedSelectionEmptyMessage = document.getElementById('seed-selection-empty-message');
        const fertilizerSelectionList = document.getElementById('fertilizer-selection-list');
        const fertilizerSelectionEmptyMessage = document.getElementById('fertilizer-selection-empty-message');
        const plantActionButtonsContainer = document.getElementById('plant-action-buttons');
        const plantActionTitle = document.getElementById('plant-action-title');
        const plantActionInfo = document.getElementById('plant-action-info');
        const emptyPlotActionButtonsContainer = document.getElementById('empty-plot-action-buttons');
        const emptyPlotActionTitle = document.getElementById('empty-plot-action-title');
        const emptyPlotActionInfo = document.getElementById('empty-plot-action-info');
        const openShopBtn = document.getElementById('open-shop-btn');
        const openInventoryBtn = document.getElementById('open-inventory-btn');
       // const saveGameBtn = document.getElementById('save-game-btn');
	    const openMenuBtn = document.getElementById('open-menu-btn'); // <<< TH√äM N√öT M·ªöI
        const tooltipElement = document.getElementById('tooltip');
		const lockedPlotPopup = document.getElementById('locked-plot-popup');
		const menuPopup = document.getElementById('menu-popup');
			const plantingHistoryBtn = document.getElementById('planting-history-btn'); // <<< TH√äM N√öT L·ªäCH S·ª¨ TRONG MENU
		 // T√¨m n√∫t ƒë√≥ng b√™n trong menu popup - Quan tr·ªçng l√† t√¨m sau khi menuPopup ƒë√£ ƒë∆∞·ª£c tham chi·∫øu
		const closeMenuPopupBtn = menuPopup ? menuPopup.querySelector('.close-button') : null; // <<< TH√äM N√öT ƒê√ìNG MENU
		const lockedPlotMessage = document.getElementById('locked-plot-message');
		const confirmBuyPlotBtn = document.getElementById('confirm-buy-plot-btn');
		const cancelBuyPlotBtn = document.getElementById('cancel-buy-plot-btn');
		const closePopupBtn = lockedPlotPopup.querySelector('.close-popup-btn'); // T√¨m n√∫t ƒë√≥ng b√™n trong popup
		const confirmSellAllModal = document.getElementById('confirm-sell-all-modal');
        const confirmSellItemName = document.getElementById('confirm-sell-item-name');
        const confirmSellQuantity = document.getElementById('confirm-sell-quantity');
        const confirmSellTotalValue = document.getElementById('confirm-sell-total-value');
        const confirmSellAllBtn = document.getElementById('confirm-sell-all-btn');
        const cancelSellAllBtn = document.getElementById('cancel-sell-all-btn');

		const weatherIconElement = document.getElementById('weather-icon');
        const weatherTimerElement = document.getElementById('weather-timer');
        const weatherProgressBarElement = document.getElementById('weather-progress-bar');
        const weatherProgressContainer = document.getElementById('weather-progress-container'); // Th√™m container
		const weatherNameElement = document.getElementById('weather-name'); // <<< TH√äM THAM CHI·∫æU M·ªöI
        // --- C√°c H√†m Logic Game C·ªët L√µi ---
        // =================================
		 /** Ch·ªçn ng·∫´u nhi√™n m·ªôt icon th·ªùi ti·∫øt m·ªõi, tr√°nh ch·ªçn l·∫°i icon c≈© */
        function chooseRandomWeather() {
             const currentId = gameState.currentWeather?.id; // L·∫•y id hi·ªán t·∫°i m·ªôt c√°ch an to√†n

    // N·∫øu ch·ªâ c√≥ m·ªôt ho·∫∑c kh√¥ng c√≥ ch·∫ø ƒë·ªô th·ªùi ti·∫øt n√†o, tr·∫£ v·ªÅ c√°i ƒë·∫ßu ti√™n (ho·∫∑c undefined n·∫øu r·ªóng)
    if (WEATHER_DATA.length <= 1) {
        return WEATHER_DATA[0];
    }

    let newWeather;
    do {
        // Ch·ªçn ng·∫´u nhi√™n m·ªôt object t·ª´ m·∫£ng WEATHER_DATA
        newWeather = WEATHER_DATA[Math.floor(Math.random() * WEATHER_DATA.length)];
    } while (newWeather.id === currentId); // L·∫∑p l·∫°i n·∫øu ID tr√πng v·ªõi ID hi·ªán t·∫°i

    return newWeather; // Tr·∫£ v·ªÅ to√†n b·ªô object {id, icon, name}
        }
		/** C·∫≠p nh·∫≠t giao di·ªán ng∆∞·ªùi d√πng cho ph·∫ßn th·ªùi ti·∫øt */
        function renderWeatherUI() {
    // 1. Ki·ªÉm tra c√°c ph·∫ßn t·ª≠ DOM v√† d·ªØ li·ªáu c·∫ßn thi·∫øt (gi·ªØ nguy√™n)
    if (!weatherIconElement || !weatherNameElement || !weatherTimerElement || !weatherProgressBarElement || !gameState.currentWeather) {
        console.warn("Thi·∫øu ph·∫ßn t·ª≠ DOM th·ªùi ti·∫øt ho·∫∑c gameState.currentWeather kh√¥ng h·ª£p l·ªá.");
        // ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh/tr·ªëng khi c√≥ l·ªói
        if(weatherIconElement) weatherIconElement.textContent = '‚ùì';
        if(weatherNameElement) weatherNameElement.textContent = '---';
        if(weatherTimerElement) weatherTimerElement.textContent = '--:--';
        if(weatherProgressBarElement) weatherProgressBarElement.style.width = '0%';
        return; // Tho√°t s·ªõm n·∫øu thi·∫øu
    }

    // 2. T√≠nh to√°n th·ªùi gian v√† ti·∫øn tr√¨nh (gi·ªØ nguy√™n)
    const now = Date.now();
    const timeUntilChange = Math.max(0, gameState.nextWeatherChangeTimestamp - now);
    const totalDuration = WEATHER_CHANGE_INTERVAL_MS;
    const progressPercent = totalDuration > 0
        ? Math.max(0, Math.min(100, (timeUntilChange / totalDuration) * 100))
        : 0;

    // 3. <<< THAY ƒê·ªîI CH√çNH: S·ª≠ d·ª•ng Destructuring Assignment >>>
    // L·∫•y c√°c thu·ªôc t√≠nh c·∫ßn thi·∫øt t·ª´ gameState.currentWeather ra c√°c bi·∫øn ri√™ng
    const { id, icon, name } = gameState.currentWeather; // id c√≥ th·ªÉ kh√¥ng d√πng tr·ª±c ti·∫øp ·ªü ƒë√¢y, nh∆∞ng l·∫•y ra lu√¥n cho ti·ªán

    // 4. C·∫≠p nh·∫≠t giao di·ªán ng∆∞·ªùi d√πng s·ª≠ d·ª•ng c√°c bi·∫øn ƒë√£ destructure
    // C·∫≠p nh·∫≠t Icon v√† Title (tooltip)
    weatherIconElement.textContent = icon; // S·ª≠ d·ª•ng bi·∫øn `icon`
    weatherIconElement.title = `Th·ªùi ti·∫øt hi·ªán t·∫°i: ${name}`; // S·ª≠ d·ª•ng bi·∫øn `name`

    // C·∫≠p nh·∫≠t T√™n th·ªùi ti·∫øt
    weatherNameElement.textContent = name; // S·ª≠ d·ª•ng bi·∫øn `name`

    // C·∫≠p nh·∫≠t Timer (ph√∫t:gi√¢y) - Logic kh√¥ng ƒë·ªïi, ch·ªâ t√≠nh to√°n gi√° tr·ªã
    const minutes = Math.floor(timeUntilChange / 60000);
    const seconds = Math.floor((timeUntilChange % 60000) / 1000);
    weatherTimerElement.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    weatherTimerElement.title = `Th·ªùi gian c√≤n l·∫°i ƒë·∫øn khi ƒë·ªïi th·ªùi ti·∫øt: ${formatTime(timeUntilChange)}`;

    // C·∫≠p nh·∫≠t Progress Bar - Logic kh√¥ng ƒë·ªïi
    weatherProgressBarElement.style.width = `${progressPercent}%`;

    // C·∫≠p nh·∫≠t title cho thanh progress n·∫øu mu·ªën (s·ª≠ d·ª•ng bi·∫øn `name`)
    if (weatherProgressContainer) {
        weatherProgressContainer.title = `Ti·∫øn ƒë·ªô chu k·ª≥ th·ªùi ti·∫øt hi·ªán t·∫°i (${name})`;
    }

    // Debug log n·∫øu c·∫ßn (s·ª≠ d·ª•ng bi·∫øn `name`, `icon`)
    // console.log(`Render UI Th·ªùi ti·∫øt: ${name} (${icon}), C√≤n: ${minutes}m ${seconds}s, Progress: ${progressPercent.toFixed(1)}%`);
}
		
		    // --- Listener ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫°c n·ªÅn sau t∆∞∆°ng t√°c ƒë·∫ßu ti√™n ---
		 function openConfirmSellAllModal(itemId, itemName, quantity, totalValue) {
            if (!confirmSellAllModal || !confirmSellItemName || !confirmSellQuantity || !confirmSellTotalValue || !confirmSellAllBtn) {
                console.error("L·ªói: Thi·∫øu c√°c ph·∫ßn t·ª≠ DOM cho modal x√°c nh·∫≠n b√°n h·∫øt.");
                return;
            }
            // ƒêi·ªÅn th√¥ng tin v√†o modal
            confirmSellItemName.textContent = itemName;
            confirmSellQuantity.textContent = quantity;
            confirmSellTotalValue.textContent = totalValue;

            // L∆∞u th√¥ng tin v√†o dataset c·ªßa n√∫t x√°c nh·∫≠n ƒë·ªÉ h√†m x·ª≠ l√Ω c√≥ th·ªÉ l·∫•y
            confirmSellAllBtn.dataset.itemId = itemId;
            confirmSellAllBtn.dataset.quantity = quantity;

            // Hi·ªÉn th·ªã modal
            openModal('confirm-sell-all-modal'); // D√πng h√†m openModal chung
        }

        /** ƒê√≥ng h·ªôp tho·∫°i x√°c nh·∫≠n b√°n h·∫øt */
        function closeConfirmSellAllModal() {
            if (confirmSellAllModal) {
                closeModal('confirm-sell-all-modal'); // D√πng h√†m closeModal chung
                // X√≥a d·ªØ li·ªáu kh·ªèi n√∫t ƒë·ªÉ tr√°nh l·ªói
                if (confirmSellAllBtn) {
                    delete confirmSellAllBtn.dataset.itemId;
                    delete confirmSellAllBtn.dataset.quantity;
                }
            }
        }

        /** X·ª≠ l√Ω khi click n√∫t X√°c nh·∫≠n trong h·ªôp tho·∫°i b√°n h·∫øt */
        function handleConfirmSellAll() {
            if (!confirmSellAllBtn) return;
            const itemId = confirmSellAllBtn.dataset.itemId;
            const quantityString = confirmSellAllBtn.dataset.quantity;

            if (!itemId || !quantityString) {
                console.error("L·ªói: Kh√¥ng t√¨m th·∫•y itemId ho·∫∑c quantity tr√™n n√∫t x√°c nh·∫≠n b√°n h·∫øt.");
                closeConfirmSellAllModal();
                return;
            }

            const quantity = parseInt(quantityString);
            if (isNaN(quantity) || quantity <= 0) {
                console.error("L·ªói: S·ªë l∆∞·ª£ng b√°n h·∫øt kh√¥ng h·ª£p l·ªá:", quantityString);
                closeConfirmSellAllModal();
                return;
            }

            // G·ªçi h√†m b√°n v·ªõi th√¥ng tin ƒë√£ l∆∞u
            sellHarvestedItem(itemId, quantity);
            // ƒê√≥ng modal sau khi b√°n
            closeConfirmSellAllModal();
        }

        // G·∫Øn listener cho c√°c n√∫t trong modal x√°c nh·∫≠n (n√™n th·ª±c hi·ªán trong attachEventListeners)
        // Tuy nhi√™n, ƒë·ªÉ ƒë∆°n gi·∫£n, c√≥ th·ªÉ th√™m tr·ª±c ti·∫øp ·ªü ƒë√¢y n·∫øu c√°c n√∫t lu√¥n t·ªìn t·∫°i
        if (confirmSellAllBtn) {
             confirmSellAllBtn.addEventListener('click', handleConfirmSellAll);
        } else { console.warn("Kh√¥ng t√¨m th·∫•y n√∫t confirm-sell-all-btn khi g·∫Øn listener."); }

        if (cancelSellAllBtn) {
             cancelSellAllBtn.addEventListener('click', closeConfirmSellAllModal);
        } else { console.warn("Kh√¥ng t√¨m th·∫•y n√∫t cancel-sell-all-btn khi g·∫Øn listener."); }
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
    function playMusicOnFirstInteraction() {
        if (!musicStarted && backgroundMusic) {
            // C·ªë g·∫Øng ph√°t nh·∫°c
            const playPromise = backgroundMusic.play();

            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    // Ph√°t th√†nh c√¥ng
                    console.log("Nh·∫°c n·ªÅn ƒë√£ b·∫Øt ƒë·∫ßu ph√°t.");
                    musicStarted = true;
                    // X√≥a listener sau khi ph√°t th√†nh c√¥ng ƒë·ªÉ tr√°nh g·ªçi l·∫°i kh√¥ng c·∫ßn thi·∫øt
                    document.removeEventListener('click', playMusicOnFirstInteraction, { capture: true }); // S·ª≠ d·ª•ng capture ƒë·ªÉ b·∫Øt s·ª± ki·ªán s·ªõm
                })
                .catch(error => {
                    // Ph√°t b·ªã l·ªói (th∆∞·ªùng do ch√≠nh s√°ch tr√¨nh duy·ªát)
                    console.warn("Kh√¥ng th·ªÉ t·ª± ƒë·ªông ph√°t nh·∫°c n·ªÅn (c·∫ßn t∆∞∆°ng t√°c ng∆∞·ªùi d√πng):", error);
                    // Kh√¥ng ƒë·∫∑t musicStarted = true, c√≥ th·ªÉ th·ª≠ l·∫°i ·ªü l·∫ßn click sau
                    // C√≥ th·ªÉ x√≥a listener ·ªü ƒë√¢y n·∫øu b·∫°n kh√¥ng mu·ªën th·ª≠ l·∫°i
                    // document.removeEventListener('click', playMusicOnFirstInteraction, { capture: true });
                });
            }
        } else if (musicStarted) {
             // N·∫øu nh·∫°c ƒë√£ b·∫Øt ƒë·∫ßu, kh√¥ng c·∫ßn listener n√†y n·ªØa
             document.removeEventListener('click', playMusicOnFirstInteraction, { capture: true });
        }
    }

    // G·∫Øn listener v√†o document ƒë·ªÉ b·∫Øt click b·∫•t k·ª≥ ƒë√¢u
    // S·ª≠ d·ª•ng capture: true ƒë·ªÉ ƒë·∫£m b·∫£o listener n√†y ch·∫°y tr∆∞·ªõc c√°c listener kh√°c c√≥ th·ªÉ ngƒÉn ch·∫∑n s·ª± ki·ªán (stopPropagation)
    document.addEventListener('click', playMusicOnFirstInteraction, { capture: true });
    console.log("ƒê√£ g·∫Øn listener ƒë·ªÉ ph√°t nh·∫°c n·ªÅn sau t∆∞∆°ng t√°c.");
    // --- K·∫øt th√∫c Listener nh·∫°c n·ªÅn ---


        /** Kh·ªüi t·∫°o m√¥i tr∆∞·ªùng game. */
        function initGame() {
            console.log(`ƒêang kh·ªüi t·∫°o V∆∞·ªùn H·∫°nh Ph√∫c (Kh√≥a L∆∞u: ${GAME_SAVE_KEY})...`);
            try {
                loadGame();
                initializePlotsData(); // Quan tr·ªçng: Ph·∫£i sau loadGame ƒë·ªÉ c√≥ maxUnlockedPlots ƒë√∫ng
                renderGarden();
                renderUI();
                populateShop();
                startGameLoop();
                loadingIndicator.style.display = 'none';
                gameContainer.classList.remove('hidden');
                attachEventListeners();
                console.log("Kh·ªüi t·∫°o game ho√†n t·∫•t. Ch√†o m·ª´ng!");
                 if(gameState.totalPlayTime < 10 * 1000) showMessage("Ch√†o m·ª´ng ƒë·∫øn V∆∞·ªùn C√¢y H·∫°nh Ph√∫c!", "success");
                 else showMessage("Ch√†o m·ª´ng quay tr·ªü l·∫°i!", "info"); // Th√¥ng b√°o kh√°c n·∫øu quay l·∫°i
            } catch (error) {
                console.error("L·ªñI NGHI√äM TR·ªåNG trong qu√° tr√¨nh kh·ªüi t·∫°o game:", error);
                loadingIndicator.textContent = "L·ªói nghi√™m tr·ªçng! Kh√¥ng th·ªÉ t·∫£i game. H√£y th·ª≠ x√≥a d·ªØ li·ªáu trang web.";
                loadingIndicator.style.color = 'red';
                // Kh√¥ng ·∫©n loading ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y l·ªói
            }
        }

        /** G·∫Øn c√°c tr√¨nh l·∫Øng nghe s·ª± ki·ªán ch√≠nh. */
      function attachEventListeners() {
    console.log("ƒêang g·∫Øn c√°c tr√¨nh l·∫Øng nghe s·ª± ki·ªán...");

    // === C√ÅC N√öT CH√çNH TR√äN GIAO DI·ªÜN ===
    // N√∫t m·ªü C·ª≠a h√†ng
    if (openShopBtn) {
        openShopBtn.addEventListener('click', () => {
            switchShopTab('seeds');
            openModal('shop-modal');
        });
    } else { console.warn("Kh√¥ng t√¨m th·∫•y openShopBtn"); }

    // N√∫t m·ªü Kho ƒë·ªì
    if (openInventoryBtn) {
        openInventoryBtn.addEventListener('click', () => {
            switchInventoryTab('harvested');
            renderInventory();
            openModal('inventory-modal');
        });
    } else { console.warn("Kh√¥ng t√¨m th·∫•y openInventoryBtn"); }

    // N√∫t m·ªü Menu
    if (openMenuBtn) {
        openMenuBtn.addEventListener('click', openMenuPopup);
    } else { console.warn("Kh√¥ng t√¨m th·∫•y openMenuBtn"); }

    // === C√ÅC N√öT B√äN TRONG POPUP MENU ===
    // N√∫t L·ªãch s·ª≠ tr·ªìng c√¢y trong Menu
    if (plantingHistoryBtn) {
        plantingHistoryBtn.addEventListener('click', handlePlantingHistoryClick);
    } else { console.warn("Kh√¥ng t√¨m th·∫•y plantingHistoryBtn"); }

    // N√∫t ƒê√≥ng (X) trong Menu Popup
    if (closeMenuPopupBtn) {
        closeMenuPopupBtn.addEventListener('click', closeMenuPopup);
    } else { console.warn("Kh√¥ng t√¨m th·∫•y closeMenuPopupBtn"); }

    // <<< KH·ªêI LISTENER CHO saveGameMenuBtn ƒê√É ƒê∆Ø·ª¢C X√ìA KH·ªéI ƒê√ÇY >>>

    // === S·ª∞ KI·ªÜN TR√äN KHU V∆Ø·ªúN (·ª¶Y QUY·ªÄN) ===
    if (gardenElement) {
        gardenElement.addEventListener('click', handleGardenClick);
        gardenElement.addEventListener('mouseover', handlePlotMouseover);
        gardenElement.addEventListener('mouseout', handlePlotMouseout);
        gardenElement.addEventListener('mousemove', handlePlotMousemove);
    } else { console.error("L·ªói nghi√™m tr·ªçng: Kh√¥ng t√¨m th·∫•y gardenElement!"); }

    // === ƒê√ìNG MODAL/POPUP ===
    window.addEventListener('click', handleModalBackgroundClick);
    document.addEventListener('keydown', handleEscapeKey);

    // === ·ª¶Y QUY·ªÄN S·ª∞ KI·ªÜN CHO N√öT TRONG C√ÅC MODAL C·ª§ TH·ªÇ ===
    if (plantActionButtonsContainer) {
        plantActionButtonsContainer.addEventListener('click', handlePlantActionClick);
    } else { console.warn("Kh√¥ng t√¨m th·∫•y plantActionButtonsContainer"); }

    if (emptyPlotActionButtonsContainer) {
        emptyPlotActionButtonsContainer.addEventListener('click', handleEmptyPlotActionClick);
    } else { console.warn("Kh√¥ng t√¨m th·∫•y emptyPlotActionButtonsContainer"); }

    if (fertilizerSelectionList) {
        fertilizerSelectionList.addEventListener('click', handleFertilizerSelection);
    } else { console.warn("Kh√¥ng t√¨m th·∫•y fertilizerSelectionList"); }

    if (seedSelectionList) {
        seedSelectionList.addEventListener('click', handleSeedSelectionClick);
    } else { console.warn("Kh√¥ng t√¨m th·∫•y seedSelectionList"); }

    // === TABS TRONG MODAL ===
    if (shopTabsContainer) {
        shopTabsContainer.addEventListener('click', handleShopTabClick);
    } else { console.warn("Kh√¥ng t√¨m th·∫•y shopTabsContainer"); }

    if (inventoryTabsContainer) {
        inventoryTabsContainer.addEventListener('click', handleInventoryTabClick);
    } else { console.warn("Kh√¥ng t√¨m th·∫•y inventoryTabsContainer"); }

    // === DANH S√ÅCH V·∫¨T PH·∫®M (C·ª¨A H√ÄNG & KHO ƒê·ªí) ===
    if (shopSeedList) {
        shopSeedList.addEventListener('click', handleShopItemClick);
        shopSeedList.addEventListener('input', handleShopQuantityChange);
        shopSeedList.addEventListener('change', handleShopQuantityChange);
    } else { console.warn("Kh√¥ng t√¨m th·∫•y shopSeedList"); }

    if (shopToolList) {
        shopToolList.addEventListener('click', handleShopItemClick);
        shopToolList.addEventListener('input', handleShopQuantityChange);
        shopToolList.addEventListener('change', handleShopQuantityChange);
    } else { console.warn("Kh√¥ng t√¨m th·∫•y shopToolList"); }

    if (inventoryHarvestedList) {
        inventoryHarvestedList.addEventListener('click', handleSellHarvestedClick);
    } else { console.warn("Kh√¥ng t√¨m th·∫•y inventoryHarvestedList"); }

    // === POPUP √î ƒê·∫§T B·ªä KH√ìA ===
    if (lockedPlotPopup) {
        if (confirmBuyPlotBtn) {
            confirmBuyPlotBtn.addEventListener('click', handleConfirmBuyPlot);
        } else { console.warn("Kh√¥ng t√¨m th·∫•y confirmBuyPlotBtn trong lockedPlotPopup"); }

        if (cancelBuyPlotBtn) {
            cancelBuyPlotBtn.addEventListener('click', closeLockedPlotPopup);
        } else { console.warn("Kh√¥ng t√¨m th·∫•y cancelBuyPlotBtn trong lockedPlotPopup"); }

        const lockedPlotCloseBtn = lockedPlotPopup.querySelector('.close-popup-btn');
        if (lockedPlotCloseBtn) {
            lockedPlotCloseBtn.addEventListener('click', closeLockedPlotPopup);
        } else { console.warn("Kh√¥ng t√¨m th·∫•y .close-popup-btn trong lockedPlotPopup"); }
    } else { console.warn("Kh√¥ng t√¨m th·∫•y lockedPlotPopup"); }

    // === S·ª∞ KI·ªÜN V√íNG ƒê·ªúI TRANG ===
    window.addEventListener('beforeunload', handlePageUnload);
    document.addEventListener('visibilitychange', handleVisibilityChange);

    console.log("ƒê√£ g·∫Øn xong t·∫•t c·∫£ c√°c tr√¨nh l·∫Øng nghe s·ª± ki·ªán (ƒë√£ c·∫≠p nh·∫≠t cho Menu - b·ªè n√∫t L∆∞u).");
}
        /** Kh·ªüi t·∫°o ho·∫∑c x√°c th·ª±c m·∫£ng d·ªØ li·ªáu gameState.plots d·ª±a tr√™n maxUnlockedPlots */
        function initializePlotsData() {
            // Tr·∫°ng th√°i m·∫∑c ƒë·ªãnh cho m·ªôt √¥ ƒë·∫•t, bao g·ªìm c√°c tr∆∞·ªùng m·ªõi nh·∫•t
            const defaultPlotState = {
                seedId: null,               // ID h·∫°t gi·ªëng ƒëang tr·ªìng (null n·∫øu tr·ªëng)
                plantTime: null,            // Timestamp khi b·∫Øt ƒë·∫ßu tr·ªìng
                hasPest: false,             // C·ªù b√°o c√≥ s√¢u hay kh√¥ng
                health: INITIAL_PLANT_HEALTH, // M√°u hi·ªán t·∫°i c·ªßa c√¢y
                fertility: BASE_FERTILITY,  // ƒê·ªô ph√¨ nhi√™u hi·ªán t·∫°i c·ªßa ƒë·∫•t (%)
                causeOfDeath: null,         // Nguy√™n nh√¢n ch·∫øt ('pest' ho·∫∑c null)
                pestDeathClickCount: 0,     // S·ªë l·∫ßn click ƒë·ªÉ d·ªçn c√¢y ch·∫øt do s√¢u mi·ªÖn ph√≠
                barrenHarvestPenaltyFactor: 1.0, // H·ªá s·ªë nh√¢n th·ªùi gian m·ªçc n·∫øu thu ho·∫°ch tr√™n ƒë·∫•t c·∫±n
                isDry: false                // <<< TH√äM TR·∫†NG TH√ÅI KH√î H·∫†N >>>
            };

            // ƒê·∫£m b·∫£o m·∫£ng c√≥ ƒë·ªß ch·ªó cho c√°c √¥ ƒë√£ m·ªü kh√≥a
            while (gameState.plots.length < gameState.maxUnlockedPlots) {
                const newId = gameState.plots.length;
                gameState.plots.push({ id: newId, ...JSON.parse(JSON.stringify(defaultPlotState)) });
            }

            // X√°c th·ª±c d·ªØ li·ªáu c√°c √¥ hi·ªán c√≥ (quan tr·ªçng khi t·∫£i t·ª´ save c≈© ho·∫∑c l·ªói)
            for(let i = 0; i < gameState.plots.length; i++) {
                 const savedPlotData = gameState.plots[i] || {}; // L·∫•y d·ªØ li·ªáu l∆∞u, ho·∫∑c object r·ªóng n·∫øu ko c√≥
                 gameState.plots[i] = {
                    ...JSON.parse(JSON.stringify(defaultPlotState)), // B·∫Øt ƒë·∫ßu v·ªõi m·∫∑c ƒë·ªãnh m·ªõi nh·∫•t
                    ...savedPlotData,                                 // Ghi ƒë√® b·∫±ng d·ªØ li·ªáu ƒë√£ t·∫£i
                    id: i // Lu√¥n ƒë·∫£m b·∫£o ID ƒë√∫ng
                 };
                 // Gi·ªõi h·∫°n c√°c gi√° tr·ªã s·ªë trong kho·∫£ng h·ª£p l·ªá
                 const plot = gameState.plots[i];
                 plot.health = Math.max(0, Math.min(INITIAL_PLANT_HEALTH, plot.health));
                 plot.fertility = Math.max(0, Math.min(BASE_FERTILITY, plot.fertility));
                 plot.pestDeathClickCount = Math.max(0, plot.pestDeathClickCount || 0);
                 plot.barrenHarvestPenaltyFactor = Math.max(1.0, plot.barrenHarvestPenaltyFactor || 1.0); // ƒê·∫£m b·∫£o kh√¥ng nh·ªè h∆°n 1
                 plot.isDry = !!plot.isDry; // ƒê·∫£m b·∫£o l√† boolean

                 // Ki·ªÉm tra v√† reset tr·∫°ng th√°i c√¢y n·∫øu d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
                 if (plot.seedId && (!plot.plantTime || !ITEM_DATA[plot.seedId])) {
                     console.warn(`D·ªØ li·ªáu c√¢y ·ªü √¥ ${i} kh√¥ng h·ª£p l·ªá (seed: ${plot.seedId}, time: ${plot.plantTime}). ƒêang reset √¥.`);
                     const currentFertility = plot.fertility;
                     const currentPenaltyFactor = plot.barrenHarvestPenaltyFactor;
                     const currentIsDry = plot.isDry; // <<< Gi·ªØ l·∫°i tr·∫°ng th√°i kh√¥ h·∫°n khi reset l·ªói >>>
                     Object.assign(plot, JSON.parse(JSON.stringify(defaultPlotState))); // Reset v·ªÅ m·∫∑c ƒë·ªãnh
                     plot.id = i; // Gi·ªØ l·∫°i ID
                     plot.fertility = currentFertility; // Ph·ª•c h·ªìi
                     plot.barrenHarvestPenaltyFactor = currentPenaltyFactor; // Ph·ª•c h·ªìi
                     plot.isDry = currentIsDry; // <<< Ph·ª•c h·ªìi tr·∫°ng th√°i kh√¥ h·∫°n >>>
                 }
            }
            console.log(`ƒê√£ kh·ªüi t·∫°o/x√°c th·ª±c d·ªØ li·ªáu cho ${gameState.plots.length} √¥ ƒë·∫•t (bao g·ªìm isDry).`);
        }


        /** T·∫°o ho·∫∑c c·∫≠p nh·∫≠t c√°c ph·∫ßn t·ª≠ DOM cho √¥ ƒë·∫•t trong khu v∆∞·ªùn */
         function renderGarden() {
            gardenElement.innerHTML = ''; // X√≥a s·∫°ch ƒë·ªÉ v·∫Ω l·∫°i ho√†n to√†n
            const now = Date.now();
            let offlineMessages = { pestFound: false, plantDied: false }; // D√πng ƒë·ªÉ hi·ªÉn th·ªã 1 l·∫ßn sau khi m√¥ ph·ªèng offline

            for (let i = 0; i <= gameState.maxUnlockedPlots; i++) {
                const isUnlocked = i < gameState.maxUnlockedPlots;
                const plotData = isUnlocked ? gameState.plots[i] : null;
                const plotElement = document.createElement('div');
                plotElement.classList.add('plot');
                plotElement.dataset.plotId = i;

                if (!isUnlocked) {
                    // --- V·∫Ω √î ƒê·∫•t B·ªã Kh√≥a ---
                    plotElement.classList.add('locked');
                    const cost = calculatePlotCost(i);
                    const plotInfo = document.createElement('div');
                    plotInfo.classList.add('plot-info');
                    plotInfo.textContent = `üîí Kh√≥a (Mua: ${cost}üí∞)`;
                    plotElement.appendChild(plotInfo);

                } else if (plotData) {
                    // --- V·∫Ω √î ƒê·∫•t ƒê√£ M·ªü Kh√≥a ---
                    const isBarren = plotData.fertility <= 0;
                    plotElement.classList.toggle('barren-soil', isBarren);
                    // >>> √ÅP D·ª§NG HI·ªÜU ·ª®NG KH√î CHO C·∫¢ √î TR·ªêNG V√Ä C√ì C√ÇY <<<
                    plotElement.classList.toggle('dry-soil-effect', plotData.isDry);

                    // === T·∫°o c·∫•u tr√∫c DOM cho √¥ ƒë·∫•t (visual, bars, info) ===
                    const visualContainer = document.createElement('div');
                    visualContainer.classList.add('plant-visual-container');
                    const plantVisual = document.createElement('div');
                    plantVisual.classList.add('plant-visual');
                    visualContainer.appendChild(plantVisual);
                    const pestIcon = document.createElement('div');
                    pestIcon.classList.add('pest-icon');
                    pestIcon.textContent = 'üêõ';
                    visualContainer.appendChild(pestIcon);
                    plotElement.appendChild(visualContainer);

                    const barsContainer = document.createElement('div');
                    barsContainer.classList.add('bars-container');
                    const healthBarWrapper = document.createElement('div');
                    healthBarWrapper.classList.add('bar-wrapper', 'health-bar-wrapper');
                    healthBarWrapper.style.display = 'none'; // ·∫®n ban ƒë·∫ßu
                    const healthBarFill = document.createElement('div');
                    healthBarFill.classList.add('bar-fill', 'health-bar-fill');
                    healthBarWrapper.appendChild(healthBarFill);
                    barsContainer.appendChild(healthBarWrapper);
                    const fertilityBarWrapper = document.createElement('div');
                    fertilityBarWrapper.classList.add('bar-wrapper', 'fertility-bar-wrapper');
                    const fertilityBarFill = document.createElement('div');
                    fertilityBarFill.classList.add('bar-fill', 'fertility-bar-fill');
                    fertilityBarWrapper.appendChild(fertilityBarFill);
                    barsContainer.appendChild(fertilityBarWrapper);

                    const plotInfo = document.createElement('div');
                    plotInfo.classList.add('plot-info');
                    plotElement.appendChild(barsContainer);
                    plotElement.appendChild(plotInfo);
                    // === K·∫øt th√∫c t·∫°o c·∫•u tr√∫c DOM ===

                    // --- C·∫≠p nh·∫≠t giao di·ªán d·ª±a tr√™n plotData ---
                    const isLowFertility = plotData.fertility < LOW_FERTILITY_THRESHOLD;
                    plotElement.classList.toggle('low-fertility', isLowFertility && !isBarren);

                    const stageInfo = getPlantStageInfo(plotData, now);
                    const seedInfo = plotData.seedId ? ITEM_DATA[plotData.seedId] : null;

                    // --- C·∫≠p nh·∫≠t THANH PH√å NHI√äU ---
                    const fertilityPercent = Math.max(0, plotData.fertility);
                    fertilityBarFill.style.width = `${fertilityPercent}%`;
                    fertilityBarFill.className = 'bar-fill fertility-bar-fill'; // Reset
                    if (isBarren) fertilityBarFill.classList.add('barren');
                    else if (isLowFertility) fertilityBarFill.classList.add('low-fertility');
                    else if (fertilityPercent < 60) fertilityBarFill.classList.add('medium-fertility');

                    // --- X·ª≠ l√Ω khi C√ì C√ÇY tr·ªìng tr√™n √¥ ---
                    if (plotData.seedId && plotData.plantTime && seedInfo) {
                        plotElement.classList.add('planted');
                        healthBarWrapper.style.display = 'block'; // Hi·ªán thanh m√°u

                        if (stageInfo && !stageInfo.isError) {
                            // C·∫≠p nh·∫≠t h√¨nh ·∫£nh c√¢y
                            let img = plantVisual.querySelector('img');
                            if (!img) { img = document.createElement('img'); plantVisual.appendChild(img); }
                            const imgSrc = stageInfo.visualSrc || 'Hinhanh/General/MissingIcon.png';
                            if (img.src !== imgSrc) img.src = imgSrc;
                            img.alt = seedInfo.name;
                            img.onerror = () => { if (img.src !== 'Hinhanh/General/MissingIcon.png') img.src = 'Hinhanh/General/MissingIcon.png'; };
                            plantVisual.classList.add('visible');
                            // <<< C·∫¨P NH·∫¨T CLASS KHI CH·∫æT DO KH√î H·∫†N >>>
                            const isDeadDry = stageInfo.isDead && plotData.causeOfDeath === 'dryness';
                            plantVisual.classList.toggle('stage-dead', stageInfo.isDead);
                            plantVisual.classList.toggle('pest-death', stageInfo.isDead && plotData.causeOfDeath === 'pest');
                            // C√≥ th·ªÉ th√™m class ri√™ng cho ch·∫øt kh√¥ n·∫øu mu·ªën hi·ªáu ·ª©ng kh√°c
                            // plantVisual.classList.toggle('dry-death', isDeadDry);

                            // --- C·∫≠p nh·∫≠t THANH M√ÅU ---
                            const healthPercent = Math.max(0, stageInfo.health);
                            healthBarFill.style.width = `${healthPercent}%`;
                            healthBarFill.className = 'bar-fill health-bar-fill'; // Reset
                            if (healthPercent < 30) healthBarFill.classList.add('low-health');
                            else if (healthPercent < 70) healthBarFill.classList.add('medium-health');

                            // --- C·∫≠p nh·∫≠t th√¥ng tin text (plotInfo) ---
                            let infoText = '';
                            const fertilityText = isBarren ? ' (ƒê·∫•t C·∫∞N 0%!)' : ` (ƒê·∫•t: ${Math.round(plotData.fertility)}%)`;
                            const dryText = plotData.isDry ? ' (Kh√¥!)' : '';

                            plotElement.classList.toggle('infested', plotData.hasPest);
                            pestIcon.style.display = plotData.hasPest ? 'block' : 'none';
                            plotInfo.classList.remove('needs-cleanup-fee', 'free-cleanup-progress'); // Reset class ƒë·∫∑c bi·ªát

                            if (plotData.hasPest) {
                                infoText = `üêõ S√ÇU! (${seedInfo.name}) - HP: ${Math.round(stageInfo.health)}%${fertilityText}${dryText}`;
                                if(tickCounter <= 1 && stageInfo.health < INITIAL_PLANT_HEALTH - 1) { offlineMessages.pestFound = true; }
                            } else if (stageInfo.isMature) {
                                const expectedHarvestQuantity = 1;
                                infoText = `‚úÖ Thu ho·∫°ch (${seedInfo.name}) (x${expectedHarvestQuantity})${fertilityText}${dryText}`;
                            } else if (stageInfo.isDead) {
                                let deathReasonText = '';
                                if (plotData.causeOfDeath === 'pest') {
                                    deathReasonText = 'Do S√¢u';
                                    const hasEnoughMoney = gameState.currency >= DEAD_PEST_CLEANUP_COST;
                                    if (!hasEnoughMoney && plotData.pestDeathClickCount > 0) {
                                         const clicksRemaining = DEAD_PEST_FREE_CLEANUP_CLICKS - plotData.pestDeathClickCount;
                                         infoText = `üíÄ Ch·∫øt (${deathReasonText})! Click ${clicksRemaining} l·∫ßn...${dryText}`;
                                         plotInfo.classList.add('free-cleanup-progress');
                                    } else {
                                        infoText = `üíÄ Ch·∫øt (${deathReasonText})! - D·ªçn (${DEAD_PEST_CLEANUP_COST}üí∞)${fertilityText}${dryText}`;
                                        plotInfo.classList.add('needs-cleanup-fee');
                                    }
                                    if(tickCounter <= 1) offlineMessages.plantDied = true;
                                } else if (plotData.causeOfDeath === 'dryness') { // <<< NGUY√äN NH√ÇN M·ªöI >>>
                                    deathReasonText = 'Do Kh√¥ H·∫°n';
                                    infoText = `üíÄ Ch·∫øt (${deathReasonText}) - Click d·ªçn${fertilityText}${dryText}`; // Ch·∫øt do kh√¥ d·ªçn mi·ªÖn ph√≠
                                    if(tickCounter <= 1) offlineMessages.plantDied = true;
                                }
                                else { // Ch·∫øt t·ª± nhi√™n ho·∫∑c kh√¥ng r√µ
                                    deathReasonText = 'T·ª± nhi√™n';
                                    infoText = `üíÄ Ch·∫øt (${seedInfo.name}) - Click d·ªçn${fertilityText}${dryText}`;
                                     if(tickCounter <= 1 && !plotData.causeOfDeath) offlineMessages.plantDied = true;
                                }
                            } else { // C√¢y ƒëang l·ªõn
                                const effectiveGrowthTimeMs = stageInfo.effectiveGrowthTimeSec * 1000;
                                const timeRemaining = Math.max(0, effectiveGrowthTimeMs - (now - plotData.plantTime));
                                let barrenWarning = '';
                                if (isBarren && plotData.barrenHarvestPenaltyFactor > 1.0) barrenWarning = ` (M·ªçc CH·∫¨M x${plotData.barrenHarvestPenaltyFactor.toFixed(2)}!)`;
                                else if (isBarren) barrenWarning = ' (ƒê·∫•t C·∫∞N!)';
                                infoText = `${seedInfo.name} (${Math.round(stageInfo.growthProgress * 100)}%) - ${formatTime(timeRemaining, true)}${fertilityText}${barrenWarning}${dryText}`;
                            }
                            plotInfo.textContent = infoText;

                        } else { // L·ªói c√¢y tr·ªìng
                             let img = plantVisual.querySelector('img');
                             if (!img) { img = document.createElement('img'); plantVisual.appendChild(img); }
                             img.src = 'Hinhanh/General/ErrorPlant.png'; img.alt = 'L·ªói';
                             plantVisual.classList.add('visible', 'stage-dead');
                             const fertilityTextError = isBarren ? ' (ƒê·∫•t C·∫∞N 0%!)' : ` (ƒê·∫•t: ${Math.round(plotData.fertility)}%)`;
                             const dryTextError = plotData.isDry ? ' (Kh√¥!)' : '';
                             plotInfo.textContent = `L·ªói c√¢y tr·ªìng${fertilityTextError}${dryTextError}`;
                             healthBarWrapper.style.display = 'block';
                             const healthPercent = Math.max(0, plotData.health);
                             healthBarFill.style.width = `${healthPercent}%`; healthBarFill.className = 'bar-fill health-bar-fill';
                             if (healthPercent < 30) healthBarFill.classList.add('low-health');
                             else if (healthPercent < 70) healthBarFill.classList.add('medium-health');
                             plotElement.classList.toggle('infested', plotData.hasPest);
                             pestIcon.style.display = plotData.hasPest ? 'block' : 'none';
                             if (plotData.hasPest) plotInfo.textContent += ' (C√≥ s√¢u!)';
                        }
                    } else { // --- X·ª≠ l√Ω khi √î TR·ªêNG ---
                        const fertilityTextEmpty = isBarren ? ' (ƒê·∫•t C·∫∞N 0%!)' : ` (ƒê·ªô ph√¨: ${Math.round(plotData.fertility)}%)`;
                        let barrenPenaltyText = '';
                        if (isBarren && plotData.barrenHarvestPenaltyFactor > 1.0) {
                             barrenPenaltyText = `\n(Tr·ªìng c√¢y s·∫Ω m·ªçc ch·∫≠m x${plotData.barrenHarvestPenaltyFactor.toFixed(2)})`;
                        }
                        const dryTextEmpty = plotData.isDry ? ' (Kh√¥!)' : ''; // Hi·ªÉn th·ªã n·∫øu √¥ tr·ªëng b·ªã kh√¥
                        plotInfo.textContent = `ƒê·∫•t tr·ªëng${fertilityTextEmpty}${dryTextEmpty}${barrenPenaltyText}`;
                        plotInfo.classList.remove('needs-cleanup-fee', 'free-cleanup-progress');
                        plantVisual.innerHTML = ''; // X√≥a ·∫£nh c√¢y c≈©
                        plantVisual.classList.remove('visible', 'stage-dead', 'pest-death');
                        plotElement.classList.remove('planted', 'infested');
                         // Gi·ªØ l·∫°i dry-soil-effect n·∫øu √¥ tr·ªëng ƒëang kh√¥
                         if (!plotData.isDry) plotElement.classList.remove('dry-soil-effect');
                        pestIcon.style.display = 'none'; // ·∫®n icon s√¢u
                    }

                } else if (!isUnlocked) {
                    // √î kh√≥a ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü ƒë·∫ßu
                } else {
                    // L·ªói render kh√¥ng mong mu·ªën
                    console.error(`L·ªói render: Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho √¥ ƒë√£ m·ªü kh√≥a ${i}`);
                    plotElement.textContent = `L·ªói √¥ ${i}`;
                    plotElement.style.backgroundColor = 'red'; plotElement.style.color = 'white';
                }

                // Th√™m √¥ v√†o DOM
                 if (isUnlocked || i === gameState.maxUnlockedPlots) {
                    gardenElement.appendChild(plotElement);
                 }

            } // --- K·∫øt th√∫c v√≤ng l·∫∑p for c√°c √¥ ƒë·∫•t ---

             // Hi·ªÉn th·ªã th√¥ng b√°o offline
             if (tickCounter <= 1) {
                 let pestRemainedOffline = false;
                 for (let i = 0; i < gameState.maxUnlockedPlots; i++) { if(gameState.plots[i]?.hasPest) { pestRemainedOffline = true; break; }}
                 if (pestRemainedOffline) { setTimeout(() => showMessage("·ªêi! C√≥ v·∫ª s√¢u b·ªánh v·∫´n c√≤n tr√™n c√¢y khi b·∫°n v·∫Øng m·∫∑t!", "warning"), 500); }
                 else if (offlineMessages.pestFound) { setTimeout(() => showMessage("C√≥ v·∫ª s√¢u b·ªánh ƒë√£ gh√© thƒÉm khi b·∫°n v·∫Øng m·∫∑t!", "warning"), 500); }
                 if (offlineMessages.plantDied) { setTimeout(() => showMessage("M·ªôt s·ªë c√¢y tr·ªìng ƒë√£ kh√¥ng qua kh·ªèi khi b·∫°n v·∫Øng m·∫∑t.", "error"), 600); }
             }
        } // --- K·∫øt th√∫c h√†m renderGarden ---


        /** B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p game ch√≠nh. */
        function startGameLoop() {
            if (gameLoopInterval) {
                console.warn("V√≤ng l·∫∑p game ƒë√£ ch·∫°y.");
                return;
            }
            console.log(`ƒêang b·∫Øt ƒë·∫ßu v√≤ng l·∫∑p game v·ªõi kho·∫£ng th·ªùi gian: ${TICK_INTERVAL}ms`);
             gameTick(); // Ch·∫°y tick ƒë·∫ßu ti√™n ngay l·∫≠p t·ª©c
             gameLoopInterval = setInterval(gameTick, TICK_INTERVAL); // Thi·∫øt l·∫≠p interval
        }

        /** D·ª´ng v√≤ng l·∫∑p game ch√≠nh. */
        function stopGameLoop() {
            if (gameLoopInterval) {
                clearInterval(gameLoopInterval); // X√≥a interval
                gameLoopInterval = null; // ƒê·∫∑t l·∫°i bi·∫øn ID
                console.log("V√≤ng l·∫∑p game ƒë√£ d·ª´ng.");
            }
        }

        /** Nh·ªãp ƒë·∫≠p ch√≠nh c·ªßa game, c·∫≠p nh·∫≠t tr·∫°ng th√°i c√¢y tr·ªìng, UI, v√† s·ª± ki·ªán s√¢u b·ªánh. */
         function gameTick() {
            const now = Date.now();
            // C·∫≠p nh·∫≠t timestamp ·ªü ƒë·∫ßu tick ƒë·ªÉ t√≠nh to√°n ch√≠nh x√°c
            gameState.lastUpdateTimestamp = now;
            tickCounter++;

            // C·ªù theo d√µi thay ƒë·ªïi tr·∫°ng th√°i c·∫ßn render l·∫°i v∆∞·ªùn
            let plotStateChangedDuringTick = false; // Khai b√°o ·ªü ƒë·∫ßu h√†m

            // C·∫≠p nh·∫≠t th·ªùi gian hi·ªÉn th·ªã (gi·ªù:ph√∫t)
            const currentTime = new Date();
            const hours = String(currentTime.getHours()).padStart(2, '0');
            const minutes = String(currentTime.getMinutes()).padStart(2, '0');
            const timeString = `${hours}:${minutes}`;
            if (gameTimeElement.textContent !== timeString) {
                gameTimeElement.textContent = timeString;
            }

            // --- X·ª≠ L√Ω Thay ƒê·ªïi Th·ªùi Ti·∫øt ---
            let weatherJustChanged = false;
            if (now >= gameState.nextWeatherChangeTimestamp) {
                // L∆∞u ID th·ªùi ti·∫øt c≈© ƒë·ªÉ so s√°nh n·∫øu c·∫ßn
                const previousWeatherId = gameState.currentWeather?.id;

                // Ch·ªçn th·ªùi ti·∫øt m·ªõi v√† c·∫≠p nh·∫≠t state
                gameState.currentWeather = chooseRandomWeather(); // L·∫•y object th·ªùi ti·∫øt m·ªõi
                gameState.currentWeatherStartTime = now;
                gameState.nextWeatherChangeTimestamp = now + WEATHER_CHANGE_INTERVAL_MS;
                const weatherDisplayName = gameState.currentWeather.name || gameState.currentWeather.icon;
                console.log(`Th·ªùi ti·∫øt ƒë√£ thay ƒë·ªïi th√†nh: ${weatherDisplayName} (ID: ${gameState.currentWeather.id})`);
                showMessage(`Th·ªùi ti·∫øt ƒë√£ ƒë·ªïi th√†nh ${weatherDisplayName}`, 'info');
                weatherJustChanged = true;
                weatherUpdateNeeded = true; // ƒê√°nh d·∫•u c·∫ßn c·∫≠p nh·∫≠t UI th·ªùi ti·∫øt

                // X·ª¨ L√ù KHI TH·ªúI TI·∫æT CHUY·ªÇN SANG LO·∫†I C√ì M∆ØA: L√†m h·∫øt kh√¥ h·∫°n
                const rainyWeatherIdsForDryness = ['rainy', 'thunderstorm', 'rainy_sunny'];
                if (rainyWeatherIdsForDryness.includes(gameState.currentWeather.id)) {
                    let clearedDryPlots = 0;
                    for (let i = 0; i < gameState.maxUnlockedPlots; i++) {
                        const plot = gameState.plots[i];
                        if (plot && plot.isDry) {
                            plot.isDry = false;
                            clearedDryPlots++;
                            plotStateChangedDuringTick = true;
                            console.log(`(Weather Change to Rain) Plot ${i} h·∫øt kh√¥ do tr·ªùi m∆∞a (${gameState.currentWeather.id}).`);
                        }
                    }
                    if (clearedDryPlots > 0) {
                        setTimeout(() => showMessage(`üåßÔ∏è M∆∞a ƒë√£ l√†m ${clearedDryPlots} √¥ ƒë·∫•t h·∫øt kh√¥!`, "success"), 200);
                    }
                }
                saveGame(); // L∆∞u game sau khi th·ªùi ti·∫øt thay ƒë·ªïi
            }

            // --- Lu√¥n C·∫≠p Nh·∫≠t UI Th·ªùi Ti·∫øt ---
            // (renderWeatherUI ƒë∆∞·ª£c g·ªçi cu·ªëi c√πng n·∫øu c·∫ßn, ho·∫∑c ·ªü ƒë√¢y)
            // ƒê·ªÉ ƒë∆°n gi·∫£n, g·ªçi render ·ªü cu·ªëi n·∫øu plotStateChangedDuringTick ho·∫∑c weatherJustChanged
            renderWeatherUI(); // C·∫≠p nh·∫≠t timer/progress bar li√™n t·ª•c

            // --- KI·ªÇM TRA V√Ä √ÅP D·ª§NG KH√î H·∫†N KHI TR·ªúI N·∫ÆNG ---
           let dryCheckOccurredThisTick = false;
    if (gameState.currentWeather.id === 'sunny' && now >= gameState.nextDryCheckTimestamp && !dryCheckOccurredThisTick) {
        dryCheckOccurredThisTick = true;
        let becameDryCount = 0;
        for (let i = 0; i < gameState.maxUnlockedPlots; i++) {
            const plot = gameState.plots[i];
            if (plot && !plot.isDry) {
                // X√°c su·∫•t 65% b·ªã kh√¥ v·∫´n gi·ªØ nguy√™n
                if (Math.random() < 0.65) {
                    plot.isDry = true;
                    becameDryCount++;
                    plotStateChangedDuringTick = true;
                }
            }
        }
        if (becameDryCount > 0) {
            showMessage(`ü•µ ${becameDryCount} √¥ ƒë·∫•t ƒë√£ b·ªã kh√¥ do n·∫Øng g·∫Øt!`, "warning");
        }

        // ---> THAY ƒê·ªîI D√íNG N√ÄY <---
        // const randomInterval = (10 + Math.random() * 20) * 1000; // C≈®: 10-30 gi√¢y khi n·∫Øng
        const randomInterval = (30 + Math.random() * 30) * 1000; // M·ªöI: 30-60 gi√¢y khi n·∫Øng
        // ---> K·∫æT TH√öC THAY ƒê·ªîI <---

        gameState.nextDryCheckTimestamp = now + randomInterval;
    }
    else if (gameState.currentWeather.id !== 'sunny' && now >= gameState.nextDryCheckTimestamp) {
        // L√™n l·ªãch ki·ªÉm tra xa h∆°n n·∫øu kh√¥ng ph·∫£i n·∫Øng g·∫Øt (gi·ªØ nguy√™n 1-2 ph√∫t)
        const randomInterval = (60 + Math.random() * 60) * 1000; // 1-2 ph√∫t khi kh√¥ng n·∫Øng
        gameState.nextDryCheckTimestamp = now + randomInterval;
    }

            // --- X·ª≠ l√Ω S√¢u B·ªánh, H·ªìi M√°u, Gi·∫£m Ph√¨ Nhi√™u, v√† H·∫≠u Qu·∫£ KH√î H·∫†N cho t·ª´ng √î ƒê·∫•t ---
            for (let i = 0; i < gameState.maxUnlockedPlots; i++) {
                const plot = gameState.plots[i];
                if (!plot) continue;
                let plotUpdatedByOthers = false; // C·ªù ri√™ng cho c√°c thay ƒë·ªïi kh√°c ngo√†i kh√¥ h·∫°n v√† th·ªùi ti·∫øt

                // A. G√¢y S√°t Th∆∞∆°ng n·∫øu C√¢y ƒê√É C√ì S√ÇU
                if (plot.hasPest && plot.health > 0) {
                     const stageInfo = getPlantStageInfo(plot, now);
                     const isMature = stageInfo && stageInfo.isMature;
                     const damageMultiplier = isMature ? PEST_DAMAGE_MATURE_REDUCTION_FACTOR : 1;
                     const actualDamage = PEST_DAMAGE_PER_TICK * damageMultiplier;
                     const oldHealth = plot.health;
                     plot.health = Math.max(0, plot.health - actualDamage);
                     if (plot.health === 0 && oldHealth > 0) {
                         plot.causeOfDeath = 'pest'; plot.hasPest = false; plot.pestDeathClickCount = 0; plot.isDry = false;
                         console.warn(`√î ${i} (${ITEM_DATA[plot.seedId]?.name || 'C√¢y'}) v·ª´a CH·∫æT v√¨ s√¢u!`);
                         plotUpdatedByOthers = true; // ƒê√°nh d·∫•u thay ƒë·ªïi
                     } else if (plot.health !== oldHealth) {
                         plotUpdatedByOthers = true; // ƒê√°nh d·∫•u thay ƒë·ªïi
                     }
                }

                // B. Ki·ªÉm Tra T·ªâ L·ªá Xu·∫•t Hi·ªán S√¢u M·ªöI (Ch·ªâ khi th·ªùi ti·∫øt kh√¥ng m∆∞a v√† kh√¥ng c√≥ s√¢u)
                const noPestWeatherIds = ['sunny', 'cloudy', 'windy', 'lightning'];
                if (noPestWeatherIds.includes(gameState.currentWeather.id) && plot.seedId && plot.plantTime && plot.health > 0 && !plot.hasPest) {
                     if (Math.random() < PEST_APPEARANCE_CHANCE_PER_TICK_PER_PLOT) {
                         plot.hasPest = true;
                         console.log(`S√¢u v·ª´a xu·∫•t hi·ªán tr√™n √¥ ${i} (${ITEM_DATA[plot.seedId]?.name || 'C√¢y'})!`);
                         showMessage(`·ªêi! S√¢u xu·∫•t hi·ªán tr√™n ${ITEM_DATA[plot.seedId]?.name || 'c√¢y'} ·ªü √¥ ${i+1}!`, "pest-event");
                         plotUpdatedByOthers = true; // ƒê√°nh d·∫•u thay ƒë·ªïi
                     }
                }

                // C. H·ªìi M√°u (ch·ªâ khi kh√¥ng s√¢u, kh√¥ng kh√¥)
                if (plot.seedId && plot.plantTime && plot.health > 0 && plot.health < INITIAL_PLANT_HEALTH && !plot.hasPest && !plot.isDry) {
                    const oldHealth = plot.health;
                    plot.health = Math.min(INITIAL_PLANT_HEALTH, plot.health + HEALTH_REGEN_PER_TICK);
                    if(plot.health !== oldHealth) plotUpdatedByOthers = true; // ƒê√°nh d·∫•u thay ƒë·ªïi
                }

                // D. Gi·∫£m ƒê·ªô Ph√¨ Nhi√™u D·∫ßn D·∫ßn do c√¢y l·ªõn (n·∫øu c√≤n s·ªëng, ch∆∞a ch√≠n)
                 if (plot.seedId && plot.plantTime && plot.health > 0) {
                    const seedInfo = ITEM_DATA[plot.seedId];
                    if (seedInfo && seedInfo.fertilityCost > 0 && seedInfo.growthTime > 0 && plot.fertility > 0) {
                        const stageInfo = getPlantStageInfo(plot, now);
                        if (stageInfo && !stageInfo.isMature && !stageInfo.isDead) { // Ch·ªâ gi·∫£m khi ƒëang l·ªõn
                             const baseGrowthTime = seedInfo.growthTime;
                             const fertilityDecreasePerTick = (seedInfo.fertilityCost * BASE_FERTILITY) / baseGrowthTime;
                             if (fertilityDecreasePerTick > 0) {
                                 const oldFertility = plot.fertility;
                                 plot.fertility = Math.max(0, plot.fertility - fertilityDecreasePerTick);
                                 if(plot.fertility !== oldFertility) plotUpdatedByOthers = true; // ƒê√°nh d·∫•u thay ƒë·ªïi
                             }
                        }
                    }
                 }

                // E. X·ª¨ L√ù H·∫¨U QU·∫¢ KHI B·ªä KH√î H·∫†N (gi·∫£m m√°u/ph√¨)
                if (plot.isDry) {
                    let changedByDryness = false;
                    if (plot.seedId && plot.health > 0) { // C√¢y b·ªã kh√¥
                        const healthDrain = DRY_HEALTH_DRAIN_PER_TICK;
                        const oldHealth = plot.health;
                        plot.health = Math.max(0, plot.health - healthDrain);
                        if (plot.health === 0 && oldHealth > 0) {
                            plot.causeOfDeath = 'dryness'; plot.hasPest = false; plot.isDry = false;
                            console.warn(`√î ${i} (${ITEM_DATA[plot.seedId]?.name || 'C√¢y'}) v·ª´a CH·∫æT v√¨ kh√¥ h·∫°n!`);
                            changedByDryness = true;
                        } else if (plot.health !== oldHealth) {
                            changedByDryness = true;
                        }
                    } else if (!plot.seedId && plot.fertility > 0) { // ƒê·∫•t tr·ªëng b·ªã kh√¥
                        const fertilityDrain = DRY_FERTILITY_DRAIN_PER_TICK;
                        const oldFertility = plot.fertility;
                        plot.fertility = Math.max(0, plot.fertility - fertilityDrain);
                        if (plot.fertility !== oldFertility) {
                            changedByDryness = true;
                            if (plot.fertility === 0 && oldFertility > 0) {
                                console.log(`√î ƒë·∫•t tr·ªëng ${i} ƒë√£ tr·ªü n√™n c·∫±n c·ªói (0% ph√¨ nhi√™u) do kh√¥ h·∫°n.`);
                            }
                        }
                    }
                    if (changedByDryness) plotStateChangedDuringTick = true; // ƒê√°nh d·∫•u c·∫ßn render
                }

                // G·ªôp c·ªù: n·∫øu c√≥ thay ƒë·ªïi t·ª´ s√¢u/h·ªìi m√°u/m·∫•t ph√¨/kh√¥ h·∫°n -> c·∫ßn render
                 if(plotUpdatedByOthers) plotStateChangedDuringTick = true;

            } // K·∫øt th√∫c v√≤ng l·∫∑p c·∫≠p nh·∫≠t √¥ ƒë·∫•t

            // >>>>>>>>>> X·ª¨ L√ù TƒÇNG PH√å NHI√äU CHO NHI·ªÄU LO·∫†I TH·ªúI TI·∫æT M∆ØA <<<<<<<<<<
            const fertilityBoostingWeatherIds = ['rainy', 'thunderstorm', 'rainy_sunny'];
            let rainBoostAppliedThisTick = false;
            if (fertilityBoostingWeatherIds.includes(gameState.currentWeather.id) && tickCounter > 0 && tickCounter % 15 === 0) {
                let plotsBoostedCount = 0;
                for (let plotIndex = 0; plotIndex < gameState.maxUnlockedPlots; plotIndex++) {
                    const plot = gameState.plots[plotIndex];
                    if (plot && plot.fertility < BASE_FERTILITY) {
                        const oldFertility = plot.fertility;
                        const boostAmount = 1; // 1% m·ªói 15s
                        plot.fertility = Math.min(BASE_FERTILITY, plot.fertility + boostAmount);
                        if (plot.fertility !== oldFertility) {
                            rainBoostAppliedThisTick = true;
                            plotsBoostedCount++;
                            if (oldFertility <= 0 && plot.fertility > 0) {
                                plot.barrenHarvestPenaltyFactor = 1.0; // Reset penalty n·∫øu ph·ª•c h·ªìi t·ª´ c·∫±n
                            }
                        }
                    }
                }
                if (rainBoostAppliedThisTick) {
                    plotStateChangedDuringTick = true; // ƒê√°nh d·∫•u c·∫ßn render l·∫°i
                }
            }
            // >>>>>>>>>> K·∫æT TH√öC X·ª¨ L√ù TƒÇNG PH√å NHI√äU <<<<<<<<<<

            // >>>>>>>>>> X·ª¨ L√ù HI·ªÜU ·ª®NG V√Ä S√ÅT TH∆Ø∆†NG THUNDERSTORM (M∆∞a v√† s·∫•m s√©t ‚õàÔ∏è) <<<<<<<<<<
            if (gameState.currentWeather.id === 'thunderstorm') {
                // S·ª≠ d·ª•ng h·∫±ng s·ªë x√°c su·∫•t C√ì S√ÅT TH∆Ø∆†NG
                if (Math.random() < THUNDERSTORM_STRIKE_CHANCE_PER_TICK) {
                    const unlockedPlots = gameState.maxUnlockedPlots;
                    if (unlockedPlots > 0) {
                        const targetPlotIndex = Math.floor(Math.random() * unlockedPlots);
                        const targetPlotElement = gardenElement.querySelector(`.plot[data-plot-id="${targetPlotIndex}"]`);
                        const plotData = gameState.plots[targetPlotIndex];

                        if (targetPlotElement && plotData && !targetPlotElement.classList.contains('locked') && !targetPlotElement.classList.contains('thunderstruck')) {
                            console.log(`(Thunderstorm) S√©t ƒë√°nh tr√∫ng √¥ ${targetPlotIndex}!`);
                            targetPlotElement.classList.add('thunderstruck'); // K√≠ch ho·∫°t hi·ªáu ·ª©ng CSS
                            setTimeout(() => {
                                const currentElement = gardenElement.querySelector(`.plot[data-plot-id="${targetPlotIndex}"]`);
                                if (currentElement) currentElement.classList.remove('thunderstruck');
                            }, STRIKE_DURATION_MS);

                            let damageApplied = false;
                            let messageType = 'warning';
                            let strikeMessage = `‚ö° S√©t ƒë√°nh tr√∫ng √¥ ${targetPlotIndex + 1}!`;

                            // --- √Åp d·ª•ng S√ÅT TH∆Ø∆†NG cho Thunderstorm ---
                            if (plotData.seedId && plotData.health > 0) {
                                const oldHealth = plotData.health;
                                plotData.health = Math.max(0, plotData.health - PLANT_HEALTH_DAMAGE);
                                const actualHealthDamage = oldHealth - plotData.health;
                                if(actualHealthDamage > 0) {
                                    strikeMessage += `\n${ITEM_DATA[plotData.seedId]?.name || 'C√¢y'} m·∫•t ${actualHealthDamage.toFixed(0)} HP!`;
                                }
                                if (plotData.health === 0 && oldHealth > 0) {
                                    plotData.causeOfDeath = 'lightning'; plotData.hasPest = false; plotData.isDry = false; plotData.pestDeathClickCount = 0;
                                    strikeMessage += `\nC√¢y ƒë√£ b·ªã s√©t ƒë√°nh ch·∫øt! üíÄ`; messageType = 'error';
                                    console.warn(`(Thunderstorm) C√¢y ·ªü √¥ ${targetPlotIndex} ƒë√£ ch·∫øt do s√©t ƒë√°nh!`);
                                }
                                damageApplied = true; // ƒê√°nh d·∫•u c√≥ s√°t th∆∞∆°ng
                                plotStateChangedDuringTick = true; // ƒê√°nh d·∫•u c·∫ßn render
                            } else if (!plotData.seedId && plotData.fertility > 0) {
                                const oldFertility = plotData.fertility;
                                plotData.fertility = Math.max(0, plotData.fertility - SOIL_FERTILITY_DAMAGE);
                                const actualFertilityDamage = oldFertility - plotData.fertility;
                                if(actualFertilityDamage > 0) {
                                    strikeMessage += `\nƒê·ªô ph√¨ nhi√™u gi·∫£m ${actualFertilityDamage.toFixed(0)}%!`;
                                }
                                if (plotData.fertility === 0) {
                                     strikeMessage += `\nƒê·∫•t ƒë√£ tr·ªü n√™n c·∫±n c·ªói!`; messageType = 'error';
                                }
                                damageApplied = true; // ƒê√°nh d·∫•u c√≥ s√°t th∆∞∆°ng
                                plotStateChangedDuringTick = true; // ƒê√°nh d·∫•u c·∫ßn render
                            }
                            // --- K·∫øt th√∫c √°p d·ª•ng S√ÅT TH∆Ø∆†NG ---

                            if (damageApplied) {
                                showMessage(strikeMessage, messageType, MESSAGE_DISPLAY_TIME * 1.5);
                                // saveGame(); // C√¢n nh·∫Øc c√≥ c·∫ßn save ngay kh√¥ng
                            }
                        }
                    }
                }
            }
            // >>>>>>>>>> X·ª¨ L√ù HI·ªÜU ·ª®NG H√åNH ·∫¢NH S√âT ƒê√ÅNH CHO TH·ªúI TI·∫æT 'lightning' (C√≥ s·∫•m s√©t üå©Ô∏è) <<<<<<<<<<
            else if (gameState.currentWeather.id === 'lightning') {
                // S·ª≠ d·ª•ng h·∫±ng s·ªë x√°c su·∫•t ri√™ng cho hi·ªáu ·ª©ng H√åNH ·∫¢NH (KH√îNG S√ÅT TH∆Ø∆†NG)
                if (Math.random() < LIGHTNING_VISUAL_STRIKE_CHANCE_PER_TICK) {
                    const unlockedPlots = gameState.maxUnlockedPlots;
                    if (unlockedPlots > 0) {
                        const targetPlotIndex = Math.floor(Math.random() * unlockedPlots);
                        const targetPlotElement = gardenElement.querySelector(`.plot[data-plot-id="${targetPlotIndex}"]`);

                        // Ch·ªâ √°p d·ª•ng hi·ªáu ·ª©ng n·∫øu t√¨m th·∫•y √¥, √¥ kh√¥ng kh√≥a v√† ch∆∞a b·ªã hi·ªáu ·ª©ng kh√°c
                        if (targetPlotElement && !targetPlotElement.classList.contains('locked') && !targetPlotElement.classList.contains('thunderstruck')) {
                            console.log(`(Lightning Visual) S√©t ƒë√°nh hi·ªáu ·ª©ng v√†o √¥ ${targetPlotIndex}.`);
                            targetPlotElement.classList.add('thunderstruck'); // K√≠ch ho·∫°t hi·ªáu ·ª©ng CSS
                            // ƒê·∫∑t timeout ƒë·ªÉ x√≥a hi·ªáu ·ª©ng
                            setTimeout(() => {
                                const currentElement = gardenElement.querySelector(`.plot[data-plot-id="${targetPlotIndex}"]`);
                                if (currentElement) currentElement.classList.remove('thunderstruck');
                            }, STRIKE_DURATION_MS); // D√πng chung h·∫±ng s·ªë th·ªùi gian hi·ªáu ·ª©ng

                            // *** KH√îNG C√ì CODE G√ÇY S√ÅT TH∆Ø∆†NG ·ªû ƒê√ÇY CHO TH·ªúI TI·∫æT 'lightning' ***
                            // Kh√¥ng c·∫ßn ƒë√°nh d·∫•u plotStateChangedDuringTick v√¨ ch·ªâ l√† hi·ªáu ·ª©ng visual
                        }
                    }
                }
            }
            // >>>>>>>>>> K·∫æT TH√öC X·ª¨ L√ù HI·ªÜU ·ª®NG 'lightning' <<<<<<<<<<

            // === Render l·∫°i v∆∞·ªùn n·∫øu c√≥ B·∫§T K·ª≤ thay ƒë·ªïi n√†o v·ªÅ TR·∫†NG TH√ÅI √¥ ƒë·∫•t ===
            if (plotStateChangedDuringTick) {
                 renderGarden(); // V·∫Ω l·∫°i v∆∞·ªùn ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i √¥ ƒë·∫•t
            }

            // C·∫≠p nh·∫≠t modal n·∫øu ƒëang hi·ªÉn th·ªã v√† plotId h·ª£p l·ªá
            if (plantActionModal.style.display === 'block' && currentActionPlotId !== null && gameState.plots[currentActionPlotId]) {
                updatePlantActionModalButtons(currentActionPlotId);
            }
            if (emptyPlotActionModal.style.display === 'block' && currentActionPlotId !== null && gameState.plots[currentActionPlotId]) {
                 updateEmptyPlotActionModal(currentActionPlotId);
            }

            // T·ª± ƒë·ªông l∆∞u
            if (tickCounter % AUTO_SAVE_INTERVAL_TICKS === 0 && tickCounter > 0) {
                 saveGame();
            }
        } // --- K·∫øt th√∫c h√†m gameTick ---

       
        /**
         * [C·∫¨P NH·∫¨T Req 4] T√≠nh to√°n th·ªùi gian ph√°t tri·ªÉn hi·ªáu qu·∫£ (t√≠nh b·∫±ng gi√¢y) d·ª±a tr√™n ƒë·ªô ph√¨ nhi√™u v√† h·ªá s·ªë ph·∫°t.
         */
         function getEffectiveGrowthTime(plot) {
            if (!plot || !plot.seedId) return 0;
            const seedInfo = ITEM_DATA[plot.seedId];
            if (!seedInfo || seedInfo.type !== 'seed') return 0;

            const baseGrowthTime = seedInfo.growthTime;
            if (baseGrowthTime <= 0) return 0;

            const plotFertility = plot.fertility;
            const penaltyFactor = plot.barrenHarvestPenaltyFactor || 1.0;

            // √Åp d·ª•ng h·ªá s·ªë ph·∫°t CH·ªà KHI ƒë·∫•t c·∫±n (<= 0%)
            if (plotFertility <= 0 && penaltyFactor > 1.0) {
                const totalEffectiveTime = baseGrowthTime * penaltyFactor;
                // console.log(`Plot ${plot.id} barren. Base: ${baseGrowthTime}s, Factor: ${penaltyFactor}, Effective: ${totalEffectiveTime}s`);
                return Math.max(baseGrowthTime, totalEffectiveTime); // ƒê·∫£m b·∫£o kh√¥ng √≠t h∆°n th·ªùi gian g·ªëc
            }

            // Tr·∫£ v·ªÅ th·ªùi gian g·ªëc n·∫øu ƒë·∫•t kh√¥ng c·∫±n ho·∫∑c kh√¥ng c√≥ penalty factor > 1
            return baseGrowthTime;
        }


        /** L·∫•y th√¥ng tin to√†n di·ªán v·ªÅ tr·∫°ng th√°i, ƒë·ªô tr∆∞·ªüng th√†nh v√† NGU·ªíN H√åNH ·∫¢NH c·ªßa c√¢y. */
        function getPlantStageInfo(plot, currentTime) {
    // --- Ph·∫ßn kh·ªüi t·∫°o gi√° tr·ªã m·∫∑c ƒë·ªãnh (kh√¥ng ƒë·ªïi) ---
    const defaultReturn = {
        visualSrc: '', stageIndex: -1, isMature: false, isDead: false, growthProgress: 0,
        health: plot.health, fertility: plot.fertility, hasPest: plot.hasPest,
        effectiveGrowthTimeSec: 0, isError: false, causeOfDeath: plot.causeOfDeath,
        barrenHarvestPenaltyFactor: plot.barrenHarvestPenaltyFactor || 1.0
    };

    if (!plot.seedId || !plot.plantTime) {
         return { ...defaultReturn, fertility: plot.fertility, health: INITIAL_PLANT_HEALTH, barrenHarvestPenaltyFactor: plot.barrenHarvestPenaltyFactor || 1.0 };
    }

    const seedInfo = ITEM_DATA[plot.seedId];
    if (!seedInfo || seedInfo.type !== 'seed' || !seedInfo.imageFolder) {
         console.error(`SeedId "${plot.seedId}" kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu imageFolder trong √¥ ${plot.id}`);
         return { ...defaultReturn, isError: true, health: plot.health, fertility: plot.fertility, hasPest: plot.hasPest, causeOfDeath: plot.causeOfDeath, barrenHarvestPenaltyFactor: plot.barrenHarvestPenaltyFactor || 1.0 };
    }

    // --- Ph·∫ßn t√≠nh to√°n th·ªùi gian, ti·∫øn tr√¨nh, giai ƒëo·∫°n (kh√¥ng ƒë·ªïi) ---
    const effectiveGrowthTimeSec = getEffectiveGrowthTime(plot);
    const totalGrowthTimeMs = effectiveGrowthTimeSec * 1000;
    const elapsedTime = currentTime - plot.plantTime;
    const growthProgress = totalGrowthTimeMs > 0 ? Math.min(1, elapsedTime / totalGrowthTimeMs) : 1;

    let stageIndex = -1;
    let visualSrc = '';
    let isDead = plot.health <= 0;
    const baseImagePath = `Hinhanh/${seedInfo.imageFolder}/`;

    // --- [C·∫¨P NH·∫¨T LOGIC X·ª¨ L√ù C√ÇY CH·∫æT] ---
    if (isDead) {
        stageIndex = -2; // ƒê·∫∑t stageIndex cho c√¢y ch·∫øt
        // Ki·ªÉm tra nguy√™n nh√¢n ch·∫øt ƒë·ªÉ ch·ªçn ·∫£nh ph√π h·ª£p
        if (plot.causeOfDeath === 'pest' || plot.causeOfDeath === 'lightning') {
            // <<< THAY ƒê·ªîI: N·∫øu ch·∫øt do S√ÇU ho·∫∑c S√âT ƒê√ÅNH, d√πng ·∫£nh chung 'Caychet.png' >>>
            visualSrc = 'Hinhanh/Caychet.png';
        } else {
            // <<< KH√îNG ƒê·ªîI: C√°c tr∆∞·ªùng h·ª£p ch·∫øt kh√°c (t·ª± nhi√™n, kh√¥ h·∫°n, kh√¥ng r√µ) d√πng ·∫£nh ch·∫øt ri√™ng c·ªßa c√¢y >>>
            visualSrc = baseImagePath + 'pic_hatgiong_giaidoanchet.png';
        }
        // Log c·ª• th·ªÉ h∆°n n·∫øu c·∫ßn debug
        // console.log(`√î ${plot.id}: C√¢y ch·∫øt (${plot.causeOfDeath || 'kh√¥ng r√µ'}). ·∫¢nh: ${visualSrc}`);

    } else { // C√¢y c√≤n s·ªëng
        const stageThresholds = [0, 0.3, 0.7, 1.0];
        for (let i = stageThresholds.length - 1; i >= 0; i--) {
            if (growthProgress >= stageThresholds[i] - 0.0001) {
                stageIndex = i;
                visualSrc = baseImagePath + `pic_hatgiong_giaidoan${i + 1}.png`;
                break;
            }
        }
         if (stageIndex === -1 && growthProgress >= 0) {
            stageIndex = 0;
            visualSrc = baseImagePath + 'pic_hatgiong_giaidoan1.png';
         }
    }
    // --- [K·∫æT TH√öC C·∫¨P NH·∫¨T LOGIC C√ÇY CH·∫æT] ---

    // --- Ph·∫ßn x√°c ƒë·ªãnh isMature v√† fallback images (kh√¥ng ƒë·ªïi nhi·ªÅu) ---
     const isMature = (growthProgress >= 1.0 - 0.0001) && !isDead && !plot.hasPest;

     // Fallback images
     if(isMature && !visualSrc && !isDead) { // ·∫¢nh cho c√¢y tr∆∞·ªüng th√†nh n·∫øu ch∆∞a c√≥
         visualSrc = baseImagePath + `pic_hatgiong_giaidoan${PLANT_GROWTH_STAGES}.png`;
         stageIndex = PLANT_GROWTH_STAGES - 1;
     }
     // ƒê·∫£m b·∫£o ·∫£nh ch·∫øt lu√¥n c√≥ gi√° tr·ªã (ƒëo·∫°n n√†y gi·ªù √≠t quan tr·ªçng h∆°n v√¨ ƒë√£ x·ª≠ l√Ω trong if(isDead))
     if(isDead && !visualSrc) {
         if (plot.causeOfDeath === 'pest' || plot.causeOfDeath === 'lightning') {
             visualSrc = 'Hinhanh/Caychet.png'; // Double check fallback
         } else {
             visualSrc = baseImagePath + 'pic_hatgiong_giaidoanchet.png'; // Double check fallback
         }
     }
     if (!visualSrc && stageIndex !== -1) visualSrc = 'Hinhanh/General/ErrorPlant.png'; // L·ªói stage s·ªëng
     if (!visualSrc) visualSrc = 'Hinhanh/General/MissingIcon.png'; // Fallback cu·ªëi c√πng

    // --- Tr·∫£ v·ªÅ k·∫øt qu·∫£ (kh√¥ng ƒë·ªïi) ---
    return {
        visualSrc, stageIndex, isMature, isDead, growthProgress,
        health: plot.health, fertility: plot.fertility, hasPest: plot.hasPest,
        effectiveGrowthTimeSec,
        isError: false, causeOfDeath: plot.causeOfDeath,
        barrenHarvestPenaltyFactor: plot.barrenHarvestPenaltyFactor || 1.0
    };
}

        /** Render c√°c ph·∫ßn t·ª≠ UI ch√≠nh (ti·ªÅn, s·ªë √¥ ƒë·∫•t). */
        function renderUI() {
            currencyElement.textContent = gameState.currency;
            plotCountElement.textContent = `${gameState.maxUnlockedPlots}`;
        }

        /** ƒêi·ªÅn v√†o modal c·ª≠a h√†ng v·ªõi c√°c tab v√† v·∫≠t ph·∫©m. */
        function populateShop() {
    console.log("ƒêang ƒëi·ªÅn c·ª≠a h√†ng...");
    if (!shopSeedList || !shopToolList || !shopSeedsEmptyMessage || !shopToolsEmptyMessage) {
         console.error("Kh√¥ng t√¨m th·∫•y c√°c ph·∫ßn t·ª≠ DOM c·ªßa danh s√°ch c·ª≠a h√†ng!"); return;
    }

    shopSeedList.innerHTML = '';
    shopToolList.innerHTML = '';
    let seedsAvailable = false;
    let toolsAvailable = false;

    const sortedItemIds = Object.keys(ITEM_DATA).sort((a, b) => {
         const itemA = ITEM_DATA[a]; const itemB = ITEM_DATA[b];
         const typeOrder = { 'seed': 1, 'tool': 2 };
         const orderA = typeOrder[itemA.type] || 99;
         const orderB = typeOrder[itemB.type] || 99;
         if (orderA !== orderB) return orderA - orderB;
         if (itemA.type === 'tool') {
             if (itemA.id === 'pesticide') return -1; // Thu·ªëc tr·ª´ s√¢u l√™n ƒë·∫ßu c√¥ng c·ª•
             if (itemB.id === 'pesticide') return 1;
         }
         return (itemA.price || 0) - (itemB.price || 0); // S·∫Øp x·∫øp theo gi√°
     });

     sortedItemIds.forEach(itemId => {
        const item = ITEM_DATA[itemId];
        const itemCard = document.createElement('div');
        itemCard.classList.add('item-card');
        itemCard.dataset.itemId = itemId;

        let iconHtml = '';
        let detailsHtml = '';
        let buySectionHtml = '';
        let targetList = null;

         let iconSrc = 'Hinhanh/General/MissingIcon.png';
         if (item.type === 'seed' && item.imageFolder) {
             iconSrc = `Hinhanh/${item.imageFolder}/pic_hatgiong_giaidoan${PLANT_GROWTH_STAGES}.png`;
         } else if (item.type === 'tool' && item.imageFolder && item.imageFile) {
             iconSrc = `${item.imageFolder}/${item.imageFile}`;
         }
         const imgTag = `<img src="${iconSrc}" alt="${item.name}" loading="lazy" onerror="this.onerror=null; this.src='Hinhanh/General/MissingIcon.png';">`;
         iconHtml = `<span class="item-icon">${imgTag}</span>`;

        if (item.type === 'seed') {
            seedsAvailable = true;
            targetList = shopSeedList;
            detailsHtml = `
                <div class="item-details">
                    <div>üß∫ B√°n ƒë∆∞·ª£c: ${item.harvestYield || 0}üí∞/c√¢y</div>
                    <div>‚è∞ L·ªõn: ${formatTime(item.growthTime * 1000, true)}</div>
                    <div>üí© Hao ƒë·∫•t: -${(item.fertilityCost * 100).toFixed(0)}%</div>
                </div>`;
            // S·ª≠ d·ª•ng c·∫•u tr√∫c nh·∫≠p s·ªë l∆∞·ª£ng v√† t·ªïng ti·ªÅn cho h·∫°t gi·ªëng
            buySectionHtml = `
                <div class="seed-quantity-selector">
                    <label for="qty-${itemId}" style="font-size:0.8rem; margin-right: 5px;">SL:</label>
                    <input type="number" id="qty-${itemId}" class="seed-quantity-input" value="1" min="1" max="99" step="1" data-item-id="${itemId}">
                </div>
                <div class="total-seed-cost" id="total-${itemId}">Gi√° b√°n: ${item.price}üí∞</div>
                <button class="buy-button buy-seed-button" data-item-id="${itemId}" ${gameState.currency < item.price ? 'disabled' : ''}>Mua</button>
            `;
        } else if (item.type === 'tool') {
            toolsAvailable = true;
            targetList = shopToolList;
            let toolDescHtml = '';
            if (item.description) {
                toolDescHtml = `<div>${item.description}</div>`;
            } else if (typeof item.fertilityBoost === 'number') {
                toolDescHtml = `<div>üí© Ph√¨ nhi√™u: +${(item.fertilityBoost * 100).toFixed(0)}%</div>`;
            }
            detailsHtml = `<div class="item-details">${toolDescHtml}</div>`;

            // [C·∫¨P NH·∫¨T] T√°i s·ª≠ d·ª•ng c·∫•u tr√∫c nh·∫≠p s·ªë l∆∞·ª£ng v√† t·ªïng ti·ªÅn c·ªßa h·∫°t gi·ªëng cho c√¥ng c·ª•
            // L∆∞u √Ω: D√πng chung l·ªõp CSS `seed-quantity-selector`, `seed-quantity-input`, `total-seed-cost`, `buy-seed-button`
            // ƒë·ªÉ c√≥ th·ªÉ d√πng chung logic c·∫≠p nh·∫≠t t·ªïng ti·ªÅn v√† x·ª≠ l√Ω s·ª± ki·ªán mua h√†ng.
            // Max c√≥ th·ªÉ ƒë·ªÉ 99 ho·∫∑c √≠t h∆°n t√πy √Ω, ·ªü ƒë√¢y ƒë·ªÉ 99 cho gi·ªëng h·∫°t gi·ªëng.
            buySectionHtml = `
                <div class="seed-quantity-selector">
                    <label for="qty-${itemId}" style="font-size:0.8rem; margin-right: 5px;">SL:</label>
                    <input type="number" id="qty-${itemId}" class="seed-quantity-input" value="1" min="1" max="99" step="1" data-item-id="${itemId}">
                </div>
                <div class="total-seed-cost" id="total-${itemId}">Gi√° b√°n: ${item.price}üí∞</div>
                <button class="buy-button buy-seed-button" data-item-id="${itemId}" ${gameState.currency < item.price ? 'disabled' : ''}>Mua</button>
            `;
         }

         if (targetList) {
             itemCard.innerHTML = `
                ${iconHtml}
                <div class="item-name">${item.name}</div>
                ${detailsHtml}
                ${buySectionHtml}
            `;
            targetList.appendChild(itemCard);
         }
    });

    shopSeedsEmptyMessage.classList.toggle('hidden', seedsAvailable);
    shopToolsEmptyMessage.classList.toggle('hidden', toolsAvailable);

    updateShopButtons(); // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t mua d·ª±a tr√™n ti·ªÅn v√† s·ªë l∆∞·ª£ng m·∫∑c ƒë·ªãnh
    console.log("C·ª≠a h√†ng ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn xong.");
}

        /** Render modal kho ƒë·ªì v·ªõi √¥ nh·∫≠p s·ªë l∆∞·ª£ng b√°n. */
        function renderInventory() {
            inventoryHarvestedList.innerHTML = '';
            inventoryPurchasedList.innerHTML = '';
            let harvestedCount = 0;
            let purchasedCount = 0;

            // --- Render Tab ƒê√£ Thu Ho·∫°ch ---
            const harvestedItemIds = Object.keys(gameState.harvestedItems);
            harvestedItemIds.sort((a, b) => (ITEM_DATA[a]?.name || '').localeCompare(ITEM_DATA[b]?.name || ''));

            harvestedItemIds.forEach(itemId => {
                const quantity = gameState.harvestedItems[itemId];
                if (quantity > 0) {
                    harvestedCount++;
                    const item = ITEM_DATA[itemId];
                    if (!item || item.type !== 'seed') { console.warn(`V·∫≠t ph·∫©m thu ho·∫°ch "${itemId}" kh√¥ng ph·∫£i h·∫°t gi·ªëng ho·∫∑c kh√¥ng t·ªìn t·∫°i.`); return; }

                    const itemCard = document.createElement('div');
                    itemCard.classList.add('item-card', 'no-hover');
                    itemCard.dataset.itemId = itemId;

                    let iconSrc = item.imageFolder ? `Hinhanh/${item.imageFolder}/pic_hatgiong_giaidoan${PLANT_GROWTH_STAGES}.png` : 'Hinhanh/General/MissingIcon.png';
                    const imgTagInv = `<img src="${iconSrc}" alt="${item.name}" loading="lazy" onerror="this.onerror=null; this.src='Hinhanh/General/MissingIcon.png';">`;
                    const iconHtml = `<span class="item-icon">${imgTagInv}</span>`;

                    const singleValue = item.harvestYield || 0;
                    const totalValue = quantity * singleValue;

                    // [C·∫¨P NH·∫¨T] Th√™m div .sell-buttons-row ƒë·ªÉ ch·ª©a c·∫£ hai n√∫t b√°n
                    itemCard.innerHTML = `
                        ${iconHtml}
                        <div class="item-name">${item.name}</div>
                        <div class="item-quantity">S·ªë l∆∞·ª£ng: <span class="current-quantity">${quantity}</span></div>
                        <div class="item-harvest-value">Gi√° tr·ªã: ${singleValue}üí∞/c√¢y (Gi√° b√°n: <span>${totalValue}üí∞</span>)</div>
                        <div class="sell-container">
                            <div class="sell-quantity-selector">
                                <label for="sell-qty-${itemId}">B√°n SL:</label>
                                <input type="number" id="sell-qty-${itemId}" class="sell-quantity-input" value="1" min="1" max="${quantity}" step="1" data-item-id="${itemId}">
                            </div>
                            <div class="sell-buttons-row" style="display: flex; justify-content: center; gap: 8px; width: 100%; margin-top: 5px;">
                                <button class="sell-button sell-selected-button" data-item-id="${itemId}" title="B√°n s·ªë l∆∞·ª£ng ƒë√£ ch·ªçn">B√°n</button>
                                <button class="sell-button sell-all-button" data-item-id="${itemId}" title="B√°n h·∫øt ${quantity} ${item.name}">B√°n H·∫øt</button>
                            </div>
                        </div>
                    `;
                    inventoryHarvestedList.appendChild(itemCard);
                }
            });

            // --- Render Tab ƒê√£ Mua ---
            const purchasedItemIds = Object.keys(gameState.inventory);
            purchasedItemIds.sort((a, b) => {
                const itemA = ITEM_DATA[a]; const itemB = ITEM_DATA[b];
                if (!itemA) return 1; if (!itemB) return -1;
                const typeOrderInv = { 'seed': 1, 'tool': 2 };
                const orderAInv = typeOrderInv[itemA.type] || 99;
                const orderBInv = typeOrderInv[itemB.type] || 99;
                if (orderAInv !== orderBInv) return orderAInv - orderBInv;
                 if (itemA.type === 'tool') {
                     if (itemA.id === 'pesticide') return -1;
                     if (itemB.id === 'pesticide') return 1;
                     const priceDiff = (itemA.price || 0) - (itemB.price || 0);
                     if (priceDiff !== 0) return priceDiff;
                 }
                return (itemA.name || '').localeCompare(itemB.name || '');
            });

             purchasedItemIds.forEach(itemId => {
                 const quantity = gameState.inventory[itemId];
                 if (quantity > 0) {
                     purchasedCount++;
                     const item = ITEM_DATA[itemId];
                     if (!item) { console.warn(`V·∫≠t ph·∫©m ƒë√£ mua "${itemId}" kh√¥ng t√¨m th·∫•y trong ITEM_DATA.`); return; }

                     const itemCard = document.createElement('div');
                     itemCard.classList.add('item-card', 'no-hover');

                     let iconHtml = '';
                     let detailsHtml = '';
                     let quantityClass = '';

                     let iconSrc = 'Hinhanh/General/MissingIcon.png';
                     if (item.type === 'seed' && item.imageFolder) {
                         iconSrc = `Hinhanh/${item.imageFolder}/pic_hatgiong_giaidoan${PLANT_GROWTH_STAGES}.png`;
                     } else if (item.type === 'tool' && item.imageFolder && item.imageFile) {
                         iconSrc = `${item.imageFolder}/${item.imageFile}`;
                     }
                     const imgTagPurch = `<img src="${iconSrc}" alt="${item.name}" loading="lazy" onerror="this.onerror=null; this.src='Hinhanh/General/MissingIcon.png';">`;
                     iconHtml = `<span class="item-icon">${imgTagPurch}</span>`;

                     if (item.type === 'seed') {
                         detailsHtml = `<div class="item-details" style="font-size: 0.7rem;">(L·ªõn: ${formatTime(item.growthTime * 1000, true)}, Hao: ${(item.fertilityCost*100).toFixed(0)}% ƒë·∫•t)</div>`;
                     } else if (item.id === 'pesticide') {
                         detailsHtml = `<div class="item-details" style="font-size: 0.75rem;">${item.description || ''}</div>`;
                         quantityClass = 'pesticide';
                     } else { // Ph√¢n b√≥n
                          detailsHtml = `<div class="item-details" style="font-size: 0.75rem;">`;
                          if (typeof item.fertilityBoost === 'number') detailsHtml += `<div>üí© Ph√¨: +${(item.fertilityBoost * 100).toFixed(0)}%</div>`;
                          // B·ªè hi·ªÉn th·ªã gi·∫£m s√¢u
                          detailsHtml += `</div>`;
                          quantityClass = 'fertilizer';
                     }

                     itemCard.innerHTML = `
                        ${iconHtml}
                        <div class="item-name">${item.name}</div>
                        <div class="item-quantity ${quantityClass}">S·ªë l∆∞·ª£ng: ${quantity}</div>
                        ${detailsHtml}
                    `;
                     inventoryPurchasedList.appendChild(itemCard);
                 }
            });

             // Hi·ªÉn th·ªã/·∫©n th√¥ng b√°o tr·ªëng
             inventoryHarvestedEmptyMessage.style.display = harvestedCount === 0 ? 'block' : 'none';
             inventoryPurchasedEmptyMessage.style.display = purchasedCount === 0 ? 'block' : 'none';
             // Ch·ªâ hi·ªÉn th·ªã list c·ªßa tab active (th√™m check s·ªë l∆∞·ª£ng ƒë·ªÉ ·∫©n ho√†n to√†n n·∫øu tr·ªëng)
             switchInventoryTab(inventoryTabsContainer.querySelector('.tab-button.active')?.dataset.tab || 'harvested');
             inventoryHarvestedList.style.display = (harvestedCount > 0 && inventoryHarvestedList.classList.contains('active-list')) ? 'grid' : 'none';
             inventoryPurchasedList.style.display = (purchasedCount > 0 && inventoryPurchasedList.classList.contains('active-list')) ? 'grid' : 'none';
        }

        /** ƒêi·ªÅn v√†o modal ch·ªçn h·∫°t gi·ªëng d·ª±a tr√™n h·∫°t gi·ªëng c√≥ s·∫µn trong kho ƒê√É MUA. */
        function populateSeedSelection() {
            console.log("ƒêang ƒëi·ªÅn modal ch·ªçn h·∫°t gi·ªëng...");
            seedSelectionList.innerHTML = '';
            let availableSeedCount = 0;

            const availableSeedIds = Object.keys(gameState.inventory)
                .filter(itemId => {
                    const item = ITEM_DATA[itemId];
                    return item && item.type === 'seed' && gameState.inventory[itemId] > 0;
                })
                .sort((a, b) => (ITEM_DATA[a]?.price || 0) - (ITEM_DATA[b]?.price || 0));

            availableSeedIds.forEach(seedId => {
                availableSeedCount++;
                const item = ITEM_DATA[seedId];
                const quantity = gameState.inventory[seedId];
                const itemCard = document.createElement('div');
                itemCard.classList.add('item-card');

                 let iconSrc = item.imageFolder ? `Hinhanh/${item.imageFolder}/pic_hatgiong_giaidoan${PLANT_GROWTH_STAGES}.png` : 'Hinhanh/General/MissingIcon.png';
                 const imgTagSeed = `<img src="${iconSrc}" alt="${item.name}" loading="lazy" onerror="this.onerror=null; this.src='Hinhanh/General/MissingIcon.png';">`;
                 const iconHtml = `<span class="item-icon">${imgTagSeed}</span>`;

                itemCard.innerHTML = `
                    ${iconHtml}
                    <div class="item-name">${item.name}</div>
                    <div class="item-quantity">C√≥ s·∫µn (ƒë√£ mua): ${quantity}</div>
                    <div class="item-details" style="font-size: 0.7rem;">(L·ªõn: ${formatTime(item.growthTime * 1000, true)}, Hao: ${(item.fertilityCost*100).toFixed(0)}% ƒë·∫•t)</div>
                    <button class="plant-button" data-seed-id="${item.id}">Tr·ªìng H·∫°t N√†y</button>
                `;
                seedSelectionList.appendChild(itemCard);
            });

            seedSelectionEmptyMessage.style.display = availableSeedCount === 0 ? 'block' : 'none';
            seedSelectionList.style.display = availableSeedCount > 0 ? 'grid' : 'none';
            console.log(`Modal ch·ªçn h·∫°t gi·ªëng ƒë√£ ƒëi·ªÅn v·ªõi ${availableSeedCount} lo·∫°i h·∫°t (t·ª´ kho ƒë√£ mua).`);
        }

        /** X·ª≠ l√Ω click v√†o n√∫t tr·ªìng trong modal ch·ªçn h·∫°t gi·ªëng. */
        function handleSeedSelectionClick(event) {
            const plantButton = event.target.closest('.plant-button');
            if (plantButton) {
                const selectedSeedId = plantButton.dataset.seedId;
                if (currentPlantingPlotId !== null && gameState.plots[currentPlantingPlotId]) {
                    plantSeed(currentPlantingPlotId, selectedSeedId);
                    closeModal('seed-selection-modal');
                } else {
                    showMessage("L·ªói: Kh√¥ng th·ªÉ tr·ªìng, vui l√≤ng ch·ªçn l·∫°i √¥ ƒë·∫•t.", "error");
                    console.error("L·ªói logic: handleSeedSelectionClick kh√¥ng t√¨m th·∫•y currentPlantingPlotId h·ª£p l·ªá.");
                    closeModal('seed-selection-modal');
                    currentPlantingPlotId = null;
                }
            }
        }

         /** ƒêi·ªÅn v√†o modal ch·ªçn ph√¢n b√≥n d·ª±a tr√™n ph√¢n b√≥n c√≥ trong kho ƒê√É MUA. */
         function populateFertilizerSelection() {
            console.log("ƒêang ƒëi·ªÅn modal ch·ªçn ph√¢n b√≥n...");
            fertilizerSelectionList.innerHTML = '';
            let availableFertilizerCount = 0;

            const availableFertilizerIds = Object.keys(gameState.inventory)
                 .filter(itemId => {
                    const item = ITEM_DATA[itemId];
                    // Ch·ªâ bao g·ªìm ph√¢n b√≥n (c√≥ fertilityBoost)
                    return item && item.type === 'tool' && typeof item.fertilityBoost === 'number' && gameState.inventory[itemId] > 0;
                 })
                 .sort((a, b) => (ITEM_DATA[a]?.price || 0) - (ITEM_DATA[b]?.price || 0));

             availableFertilizerIds.forEach(fertilizerId => {
                 availableFertilizerCount++;
                 const item = ITEM_DATA[fertilizerId];
                 const quantity = gameState.inventory[fertilizerId];
                 const itemCard = document.createElement('div');
                 itemCard.classList.add('item-card');

                 let iconSrc = (item.imageFolder && item.imageFile) ? `${item.imageFolder}/${item.imageFile}` : 'Hinhanh/General/MissingIcon.png';
                 const imgTagFert = `<img src="${iconSrc}" alt="${item.name}" loading="lazy" onerror="this.onerror=null; this.src='Hinhanh/General/MissingIcon.png';">`;
                 const iconHtml = `<span class="item-icon">${imgTagFert}</span>`;

                 let detailsHtml = `<div class="item-details" style="font-size: 0.75rem;">`;
                 detailsHtml += `<div>üí© Ph√¨: +${(item.fertilityBoost * 100).toFixed(0)}%</div>`;
                 // B·ªè d√≤ng gi·∫£m s√¢u
                 detailsHtml += `</div>`;

                 itemCard.innerHTML = `
                     ${iconHtml}
                     <div class="item-name">${item.name}</div>
                     <div class="item-quantity">C√≥ s·∫µn (ƒë√£ mua): ${quantity}</div>
                     ${detailsHtml}
                     <button class="use-button" data-fertilizer-id="${item.id}">B√≥n Ph√¢n N√†y</button>
                 `;
                 fertilizerSelectionList.appendChild(itemCard);
             });

             fertilizerSelectionEmptyMessage.style.display = availableFertilizerCount === 0 ? 'block' : 'none';
             fertilizerSelectionList.style.display = availableFertilizerCount > 0 ? 'grid' : 'none';
             console.log(`Modal ch·ªçn ph√¢n b√≥n ƒë√£ ƒëi·ªÅn v·ªõi ${availableFertilizerCount} lo·∫°i (t·ª´ kho ƒë√£ mua).`);
         }


        /** C·∫≠p nh·∫≠t c√°c n√∫t v√† th√¥ng tin trong Modal H√†nh ƒê·ªông C√¢y Tr·ªìng */
		 function updatePlantActionModalButtons(plotId) {
             // --- Ki·ªÉm tra ƒë·∫ßu v√†o v√† l·∫•y d·ªØ li·ªáu c∆° b·∫£n ---
             if (plotId === null || plotId >= gameState.maxUnlockedPlots || !gameState.plots[plotId]) {
                 console.warn(`updatePlantActionModalButtons ƒë∆∞·ª£c g·ªçi v·ªõi plotId kh√¥ng h·ª£p l·ªá: ${plotId}`);
                 if (plantActionModal.style.display === 'block') { closeModal('plant-action-modal'); currentActionPlotId = null; }
                 return;
             }
            const plotData = gameState.plots[plotId];
            const seedInfo = plotData.seedId ? ITEM_DATA[plotData.seedId] : null;
            if (!plotData.seedId || !seedInfo) {
                 console.warn(`Modal h√†nh ƒë·ªông c√¢y ƒë∆∞·ª£c m·ªü cho √¥ ${plotId} kh√¥ng c√≥ c√¢y ho·∫∑c c√¢y l·ªói. ƒêang ƒë√≥ng.`);
                 closeModal('plant-action-modal'); currentActionPlotId = null; return;
            }

            // --- L·∫•y th√¥ng tin giai ƒëo·∫°n v√† tr·∫°ng th√°i ƒë·∫•t ---
            const now = Date.now();
            const stageInfo = getPlantStageInfo(plotData, now);
            const isBarren = plotData.fertility <= 0;
            const isDry = plotData.isDry; // L·∫•y tr·∫°ng th√°i kh√¥ h·∫°n

            // --- C·∫≠p nh·∫≠t Ti√™u ƒë·ªÅ Modal ---
            plantActionTitle.textContent = `ChƒÉm S√≥c ${seedInfo.name} (√î ${plotId + 1})`;

            // --- C·∫≠p nh·∫≠t Th√¥ng tin Hi·ªÉn th·ªã ---
            let barrenPenaltyInfo = '';
            if (isBarren && plotData.barrenHarvestPenaltyFactor > 1.0) barrenPenaltyInfo = ` (M·ªçc ch·∫≠m x${plotData.barrenHarvestPenaltyFactor.toFixed(2)})`;
            else if (isBarren) barrenPenaltyInfo = ' (ƒê·∫•t C·∫∞N!)';
            let fertilityInfoStr = isBarren ? `ƒê·∫•t C·∫∞N 0%` : `ƒê·∫•t: ${Math.round(plotData.fertility)}%`;
            let dryInfoStr = isDry ? ' | üèúÔ∏è Kh√¥!' : ''; // Th√™m th√¥ng tin kh√¥ v√†o info
            let infoStr = `HP: ${Math.round(plotData.health)}% | ${fertilityInfoStr}${barrenPenaltyInfo}${dryInfoStr}`;
            if (stageInfo && !stageInfo.isMature && !stageInfo.isDead) infoStr += ` | L·ªõn: ${Math.round(stageInfo.growthProgress * 100)}%`;
            if (plotData.hasPest) infoStr += ` | üêõ C√≥ s√¢u!`;
            if (stageInfo.isDead) infoStr = `üíÄ C√¢y ƒë√£ ch·∫øt (${plotData.causeOfDeath === 'pest' ? 'Do s√¢u' : 'T·ª± nhi√™n'}) | ${fertilityInfoStr}${dryInfoStr}`;
            plantActionInfo.textContent = infoStr;

            // --- L·∫•y s·ªë l∆∞·ª£ng v·∫≠t ph·∫©m ---
            const pesticideCount = gameState.inventory.pesticide || 0;
            let totalFertilizerCount = 0;
             for (const itemId in gameState.inventory) {
                 const item = ITEM_DATA[itemId]; const quantity = gameState.inventory[itemId];
                 if (item && item.type === 'tool' && typeof item.fertilityBoost === 'number' && quantity > 0) totalFertilizerCount += quantity;
             }
             const hasPesticide = pesticideCount > 0;
             const hasAnyFertilizer = totalFertilizerCount > 0;

            // --- L·∫•y tham chi·∫øu c√°c n√∫t h√†nh ƒë·ªông c∆° b·∫£n (n·∫øu ƒë√£ t·ªìn t·∫°i) ---
            const treatPestBtn = document.getElementById('action-treat-pest');
            const selectFertilizerBtn = document.getElementById('action-select-fertilizer');
            const clearPlantBtn = document.getElementById('action-clear-plant');
            // N√∫t t∆∞·ªõi n∆∞·ªõc v√† c√°c n√∫t ƒë·ªông kh√°c s·∫Ω ƒë∆∞·ª£c t·∫°o/x√≥a sau

            // --- X√≥a c√°c n√∫t ƒë·ªông c≈© (Harvest, Sell, Shop, Water) ---
            const existingHarvestBtn = plantActionButtonsContainer.querySelector('#action-harvest-plant');
            if (existingHarvestBtn) plantActionButtonsContainer.removeChild(existingHarvestBtn);
            const existingSellNowBtn = plantActionButtonsContainer.querySelector('#action-sell-now');
            if (existingSellNowBtn) plantActionButtonsContainer.removeChild(existingSellNowBtn);
            const existingShopBtn = plantActionButtonsContainer.querySelector('#action-open-shop');
            if (existingShopBtn) plantActionButtonsContainer.removeChild(existingShopBtn);
            const existingWaterBtn = plantActionButtonsContainer.querySelector('#modal-content-Tuoinuoc');
            if (existingWaterBtn) plantActionButtonsContainer.removeChild(existingWaterBtn);
            // ----------------------------------------------------------

            // --- Th√™m n√∫t Thu ho·∫°ch / B√°n ngay (n·∫øu ƒë·ªß ƒëi·ªÅu ki·ªán) L√äN TR√äN ---
            let referenceNodeForInsertion = treatPestBtn; // N√∫t tham chi·∫øu ƒë·ªÉ ch√®n tr∆∞·ªõc
            if (stageInfo && stageInfo.isMature && !plotData.hasPest && plotData.health > 0) { // Ch·ªâ hi·ªán n·∫øu c√¢y s·ªëng
                // 1. N√∫t Thu Ho·∫°ch (V√†o Kho)
                const harvestButton = document.createElement('button');
                harvestButton.id = 'action-harvest-plant';
                harvestButton.classList.add('action-button'); harvestButton.style.backgroundColor = '#4CAF50';
                harvestButton.textContent = `üß∫ Thu Ho·∫°ch (V√†o Kho)`; harvestButton.disabled = false;
                harvestButton.title = `Thu ho·∫°ch ${seedInfo.name}`; harvestButton.style.gridColumn = '1 / -1';
                plantActionButtonsContainer.insertBefore(harvestButton, referenceNodeForInsertion);
                referenceNodeForInsertion = harvestButton; // C·∫≠p nh·∫≠t n√∫t tham chi·∫øu

                // 2. N√∫t B√°n Ngay
                const sellNowButton = document.createElement('button');
                sellNowButton.id = 'action-sell-now'; sellNowButton.classList.add('action-button', 'sell-now');
                const sellValue = Math.round(1 * (plotData.health / 100)) * (seedInfo.harvestYield || 0);
                sellNowButton.textContent = `üí∞ B√°n Ngay (${sellValue}üí∞)`; sellNowButton.disabled = false;
                sellNowButton.title = `B√°n tr·ª±c ti·∫øp ${seedInfo.name} (+${sellValue}üí∞)`; sellNowButton.style.gridColumn = '1 / -1';
                plantActionButtonsContainer.insertBefore(sellNowButton, referenceNodeForInsertion);
                referenceNodeForInsertion = sellNowButton; // C·∫≠p nh·∫≠t n√∫t tham chi·∫øu
            }

            // --- C·∫≠p nh·∫≠t n√∫t Tr·ª´ S√¢u (ƒë√£ t·ªìn t·∫°i) ---
            if (treatPestBtn) {
                treatPestBtn.textContent = `üíä Tr·ª´ S√¢u (${pesticideCount})`;
                treatPestBtn.disabled = !(plotData.hasPest && hasPesticide && plotData.health > 0);
                treatPestBtn.title = treatPestBtn.disabled ? ((!plotData.hasPest || plotData.health <=0) ? "C√¢y kh√¥ng c√≥ s√¢u ho·∫∑c ƒë√£ ch·∫øt" : `H·∫øt Thu·ªëc Tr·ª´ S√¢u (C√≥: ${pesticideCount})`) : `D√πng Thu·ªëc Tr·ª´ S√¢u (C√≥: ${pesticideCount})`;
                referenceNodeForInsertion = selectFertilizerBtn; // N√∫t ti·∫øp theo l√† B√≥n ph√¢n
            }

            // --- C·∫≠p nh·∫≠t N√∫t B√≥n Ph√¢n (ƒë√£ t·ªìn t·∫°i) ---
            if (selectFertilizerBtn) {
                selectFertilizerBtn.textContent = `üí© B√≥n Ph√¢n (${totalFertilizerCount})`;
                selectFertilizerBtn.disabled = !(hasAnyFertilizer && plotData.fertility < BASE_FERTILITY && plotData.health > 0);
                selectFertilizerBtn.title = selectFertilizerBtn.disabled ? (!hasAnyFertilizer ? `H·∫øt Ph√¢n B√≥n (C√≥: ${totalFertilizerCount})` : (plotData.fertility >= BASE_FERTILITY ? "ƒê·∫•t ƒë√£ max ph√¨ nhi√™u" : "Kh√¥ng b√≥n ph√¢n cho c√¢y ch·∫øt")) : `Ch·ªçn Ph√¢n B√≥n (C√≥: ${totalFertilizerCount})`;
                referenceNodeForInsertion = selectFertilizerBtn.nextSibling; // N√∫t ti·∫øp theo s·∫Ω l√† T∆∞·ªõi n∆∞·ªõc (ho·∫∑c X·ªõi ƒë·∫•t n·∫øu ko c√≥ T∆∞·ªõi n∆∞·ªõc)
            }

            // >>> T·∫†O V√Ä CH√àN N√öT T∆Ø·ªöI N∆Ø·ªöC M·ªöI <<<
            const newWaterButton = document.createElement('button');
            newWaterButton.id = 'modal-content-Tuoinuoc';
            newWaterButton.classList.add('action-button');
            newWaterButton.textContent = 'üíß T∆∞·ªõi N∆∞·ªõc';
            // *** K√çCH HO·∫†T N√öT N·∫æU C√ÇY B·ªä KH√î V√Ä C√íN S·ªêNG ***
            newWaterButton.disabled = !(isDry && plotData.health > 0);
            newWaterButton.title = (isDry && plotData.health > 0) ? 'T∆∞·ªõi n∆∞·ªõc cho c√¢y ƒëang b·ªã kh√¥ n√†y' : (plotData.health <= 0 ? 'Kh√¥ng th·ªÉ t∆∞·ªõi c√¢y ƒë√£ ch·∫øt' : 'C√¢y kh√¥ng c·∫ßn t∆∞·ªõi n∆∞·ªõc');
            // Ch√®n n√∫t T∆∞·ªõi n∆∞·ªõc v√†o v·ªã tr√≠ ph√π h·ª£p (sau B√≥n ph√¢n)
            plantActionButtonsContainer.insertBefore(newWaterButton, referenceNodeForInsertion);
            referenceNodeForInsertion = newWaterButton.nextSibling; // C·∫≠p nh·∫≠t tham chi·∫øu cho n√∫t X·ªõi ƒë·∫•t
            // >>> K·∫æT TH√öC T·∫†O V√Ä CH√àN N√öT T∆Ø·ªöI N∆Ø·ªöC <<<

            // --- C·∫≠p nh·∫≠t N√∫t X·ªõi ƒê·∫•t/D·ªçn D·∫πp (ƒë√£ t·ªìn t·∫°i) ---
            if (clearPlantBtn) {
                 clearPlantBtn.classList.remove('costly'); clearPlantBtn.disabled = false;
                 clearPlantBtn.textContent = '‚õèÔ∏è X·ªõi ƒê·∫•t (B·ªè)'; let clearPlantTitle = "";
                 if (plotData.health > 0) {
                     clearPlantTitle = "B·ªè c√¢y tr·ªìng n√†y ƒëi (Kh√¥ng thu ho·∫°ch ƒë∆∞·ª£c)";
                 } else if (plotData.causeOfDeath === 'pest') {
                     const hasEnoughMoney = gameState.currency >= DEAD_PEST_CLEANUP_COST;
                     if (hasEnoughMoney) {
                         clearPlantBtn.textContent = `‚õèÔ∏è D·ªçn S·∫°ch (${DEAD_PEST_CLEANUP_COST}üí∞)`; clearPlantBtn.classList.add('costly');
                         clearPlantTitle = `D·ªçn √¥ ƒë·∫•t b·ªã s√¢u ph√° ho·∫°i (T·ªën ${DEAD_PEST_CLEANUP_COST}üí∞)`;
                     } else {
                         const clicksRemaining = DEAD_PEST_FREE_CLEANUP_CLICKS - (plotData.pestDeathClickCount || 0);
                         clearPlantBtn.textContent = `‚õèÔ∏è D·ªçn S·∫°ch (Click ${clicksRemaining} l·∫ßn)`; clearPlantBtn.classList.add('costly');
                         clearPlantTitle = `Kh√¥ng ƒë·ªß ti·ªÅn (${gameState.currency}/${DEAD_PEST_CLEANUP_COST}üí∞)! ƒê√≥ng c·ª≠a s·ªï, click √¥ ƒë·∫•t ${clicksRemaining} l·∫ßn ƒë·ªÉ d·ªçn mi·ªÖn ph√≠.`;
                     }
                 } else { // Ch·∫øt t·ª± nhi√™n
                      clearPlantTitle = "D·ªçn c√¢y ƒë√£ ch·∫øt (Mi·ªÖn ph√≠)";
                 }
                 clearPlantBtn.title = clearPlantTitle;
                 referenceNodeForInsertion = clearPlantBtn.nextSibling; // C·∫≠p nh·∫≠t tham chi·∫øu cho n√∫t Shop
            }

            // --- Th√™m n√∫t "C·ª≠a h√†ng" v√†o cu·ªëi container ---
            const shopButton = document.createElement('button');
            shopButton.id = 'action-open-shop'; shopButton.classList.add('action-button'); shopButton.style.backgroundColor = '#ff9800';
            shopButton.textContent = 'üõí C·ª≠a H√†ng'; shopButton.title = 'M·ªü c·ª≠a h√†ng'; shopButton.disabled = false;
            plantActionButtonsContainer.appendChild(shopButton); // Lu√¥n th√™m v√†o cu·ªëi
        }
	  
	  

         /** C·∫≠p nh·∫≠t modal h√†nh ƒë·ªông √¥ tr·ªëng */
         function updateEmptyPlotActionModal(plotId) {
             if (plotId === null || plotId >= gameState.maxUnlockedPlots || !gameState.plots[plotId] || gameState.plots[plotId].seedId) {
                 console.warn(`updateEmptyPlotActionModal ƒë∆∞·ª£c g·ªçi cho √¥ ${plotId} kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng tr·ªëng.`);
                  if (emptyPlotActionModal.style.display === 'block') {
                      closeModal('empty-plot-action-modal');
                      currentActionPlotId = null;
                  }
                 return;
             }
             const plotData = gameState.plots[plotId];
             const isBarren = plotData.fertility <= 0;

             emptyPlotActionTitle.textContent = `√î ƒê·∫•t ${plotId + 1}`;
             let barrenPenaltyInfo = '';
             if (isBarren && plotData.barrenHarvestPenaltyFactor > 1.0) {
                 barrenPenaltyInfo = ` (Tr·ªìng c√¢y s·∫Ω m·ªçc ch·∫≠m x${plotData.barrenHarvestPenaltyFactor.toFixed(2)})`;
             } else if (isBarren) {
                  barrenPenaltyInfo = ' (C·∫∞N KI·ªÜT!)';
             }
             const fertilityText = isBarren ? `C·∫∞N KI·ªÜT 0%` : `${Math.round(plotData.fertility)}%`;
             emptyPlotActionInfo.textContent = `ƒê·ªô ph√¨ nhi√™u: ${fertilityText}${barrenPenaltyInfo}`;

             emptyPlotActionButtonsContainer.innerHTML = ''; // X√≥a n√∫t c≈©

             // --- T√≠nh to√°n s·ªë l∆∞·ª£ng v·∫≠t ph·∫©m c√≥ s·∫µn ---
             let availableSeedTypesCount = 0;
             let totalFertilizerCount = 0;
             for (const itemId in gameState.inventory) {
                 const item = ITEM_DATA[itemId];
                 const quantity = gameState.inventory[itemId];
                 if (item && quantity > 0) {
                     if (item.type === 'seed') {
                         availableSeedTypesCount++; // ƒê·∫øm s·ªë *lo·∫°i* h·∫°t gi·ªëng kh√°c nhau
                     } else if (item.type === 'tool' && typeof item.fertilityBoost === 'number') {
                         totalFertilizerCount += quantity; // C·ªông d·ªìn *t·ªïng* s·ªë l∆∞·ª£ng ph√¢n b√≥n
                     }
                 }
             }
             // ----------------------------------------

             // --- N√∫t 1: Tr·ªìng c√¢y ho·∫∑c Mua h·∫°t gi·ªëng ---
             if (availableSeedTypesCount > 0) { // Ki·ªÉm tra s·ªë lo·∫°i h·∫°t gi·ªëng > 0
                 const plantBtn = document.createElement('button');
                 plantBtn.classList.add('action-button', 'plant');
                 plantBtn.dataset.action = 'plant';
                 plantBtn.dataset.plotId = plotId;
                 plantBtn.innerHTML = `üå± Tr·ªìng C√¢y (C√≥ ${availableSeedTypesCount} lo·∫°i)`;
                 plantBtn.title = "Ch·ªçn h·∫°t gi·ªëng t·ª´ kho ƒë·ªì ƒê√É MUA ƒë·ªÉ tr·ªìng";
                 emptyPlotActionButtonsContainer.appendChild(plantBtn);
             } else { // Kh√¥ng c√≥ lo·∫°i h·∫°t gi·ªëng n√†o
                  const buySeedBtn = document.createElement('button');
                 buySeedBtn.classList.add('action-button', 'shop');
                 buySeedBtn.dataset.action = 'shop_seed';
                 buySeedBtn.dataset.plotId = plotId;
                 buySeedBtn.innerHTML = 'üõí Mua H·∫°t Gi·ªëng';
                 buySeedBtn.title = "M·ªü c·ª≠a h√†ng ƒë·ªÉ mua th√™m h·∫°t gi·ªëng";
                 emptyPlotActionButtonsContainer.appendChild(buySeedBtn);
             }

             // --- N√∫t 2: B√≥n ph√¢n ---
             if (plotData.fertility < BASE_FERTILITY) { // Ch·ªâ hi·ªán n√∫t b√≥n n·∫øu ƒë·∫•t ch∆∞a max ph√¨ nhi√™u
                 const fertilizeBtn = document.createElement('button');
                 fertilizeBtn.classList.add('action-button', 'fertilize');
                 fertilizeBtn.dataset.action = 'fertilize';
                 fertilizeBtn.dataset.plotId = plotId;
                 fertilizeBtn.innerHTML = `üí© B√≥n Ph√¢n (C√≥ ${totalFertilizerCount})`;
                 fertilizeBtn.disabled = (totalFertilizerCount <= 0); // V√¥ hi·ªáu h√≥a n·∫øu kh√¥ng c√≥ ph√¢n b√≥n n√†o
                 fertilizeBtn.title = totalFertilizerCount > 0
                    ? `Ch·ªçn lo·∫°i ph√¢n b√≥n (C√≥: ${totalFertilizerCount}) ƒë·ªÉ s·ª≠ d·ª•ng`
                    : `B·∫°n kh√¥ng c√≥ lo·∫°i ph√¢n b√≥n n√†o (C√≥: ${totalFertilizerCount})`;
                 emptyPlotActionButtonsContainer.appendChild(fertilizeBtn);
             } else { // ƒê·∫•t ƒë√£ max ph√¨ nhi√™u
                  const infoText = document.createElement('p');
                  infoText.textContent = "(ƒê·∫•t ƒë√£ ƒë·∫°t ƒë·ªô ph√¨ nhi√™u t·ªëi ƒëa)";
                  infoText.style.cssText = 'text-align: center; font-size: 0.8em; color: #3b7554; margin-top: 5px;';
                  emptyPlotActionButtonsContainer.appendChild(infoText);
             }

             // >>> TH√äM N√öT T∆Ø·ªöI N∆Ø·ªöC V√ÄO ƒê√ÇY <<<
             const waterButton = document.createElement('button');
             waterButton.id = 'modal-content-Tuoinuoc'; // ID theo y√™u c·∫ßu
             waterButton.classList.add('action-button'); // L·ªõp chung
             waterButton.textContent = 'üíß T∆∞·ªõi N∆∞·ªõc';
             waterButton.disabled = true; // Lu√¥n disable v√¨ l√† √¥ tr·ªëng
             waterButton.title = 'Kh√¥ng th·ªÉ t∆∞·ªõi √¥ ƒë·∫•t tr·ªëng.';
             emptyPlotActionButtonsContainer.appendChild(waterButton); // Th√™m v√†o cu·ªëi
             // >>> K·∫æT TH√öC TH√äM N√öT T∆Ø·ªöI N∆Ø·ªöC <<<
         }


        // --- C√°c H√†m H√†nh ƒê·ªông Ng∆∞·ªùi Ch∆°i ---
        // ==================================

        /** X·ª≠ l√Ω click trong danh s√°ch v·∫≠t ph·∫©m c·ª≠a h√†ng (·ªßy quy·ªÅn). */
         function handleShopItemClick(event) {
            const target = event.target;
            if (target.classList.contains('buy-tool-button') && !target.disabled) {
                 buyItem(target.dataset.itemId, 1);
                 return;
             }
            if (target.classList.contains('buy-seed-button') && !target.disabled) {
                const itemId = target.dataset.itemId;
                const itemCard = target.closest('.item-card');
                const quantityInput = itemCard ? itemCard.querySelector(`#qty-${itemId}`) : null;
                let quantity = quantityInput ? parseInt(quantityInput.value) : 1;
                if (isNaN(quantity) || quantity < 1) quantity = 1;
                quantity = Math.min(quantity, 99);
                buyItem(itemId, quantity);
                return;
            }
         }

         /** X·ª≠ l√Ω thay ƒë·ªïi tr∆∞·ªùng input s·ªë l∆∞·ª£ng h·∫°t gi·ªëng (·ªßy quy·ªÅn) */
         function handleShopQuantityChange(event) {
             const target = event.target;
             if (target.classList.contains('seed-quantity-input')) {
                 const itemCard = target.closest('.item-card');
                 if (itemCard) {
                     updateSeedTotalCost(target.dataset.itemId, itemCard);
                 }
             }
         }

         /** C·∫≠p nh·∫≠t t·ªïng chi ph√≠ hi·ªÉn th·ªã v√† tr·∫°ng th√°i n√∫t mua cho m·ªôt th·∫ª h·∫°t gi·ªëng */
         function updateSeedTotalCost(itemId, itemCardElement) {
    const item = ITEM_DATA[itemId];
    // Log khi h√†m ƒë∆∞·ª£c g·ªçi v√† ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
    // console.log(`updateSeedTotalCost - B·∫Øt ƒë·∫ßu cho itemId: ${itemId}`, itemCardElement);

    if (!item || !itemCardElement) {
        console.error(`updateSeedTotalCost: Kh√¥ng t√¨m th·∫•y item ho·∫∑c itemCardElement cho itemId: ${itemId}`);
        return; // Tho√°t s·ªõm n·∫øu thi·∫øu d·ªØ li·ªáu
    }

    // T√¨m c√°c ph·∫ßn t·ª≠ con quan tr·ªçng
    const quantityInput = itemCardElement.querySelector(`#qty-${itemId}`);
    const totalCostElement = itemCardElement.querySelector(`#total-${itemId}`);
    // V·∫´n d√πng l·ªõp '.buy-seed-button' v√¨ ch√∫ng ta ƒë√£ th·ªëng nh·∫•t d√πng l·ªõp n√†y cho c·∫£ hai lo·∫°i
    const buyButton = itemCardElement.querySelector(`.buy-seed-button[data-item-id="${itemId}"]`);

    // Log k·∫øt qu·∫£ t√¨m ki·∫øm ph·∫ßn t·ª≠
    // console.log(`  - T√¨m th·∫•y quantityInput: ${!!quantityInput}`);
    // console.log(`  - T√¨m th·∫•y totalCostElement: ${!!totalCostElement}`);
    // console.log(`  - T√¨m th·∫•y buyButton: ${!!buyButton}`);

    // Ki·ªÉm tra xem c√°c ph·∫ßn t·ª≠ c√≥ ƒë∆∞·ª£c t√¨m th·∫•y kh√¥ng
    if (!quantityInput || !totalCostElement || !buyButton) {
        console.error(`updateSeedTotalCost: Kh√¥ng t√¨m th·∫•y m·ªôt ho·∫∑c nhi·ªÅu ph·∫ßn t·ª≠ con cho itemId: ${itemId} trong th·∫ª:`, itemCardElement);
        // Log chi ti·∫øt h∆°n n·∫øu kh√¥ng t√¨m th·∫•y
        if (!quantityInput) console.error("  -> Kh√¥ng t√¨m th·∫•y: input#qty-" + itemId);
        if (!totalCostElement) console.error("  -> Kh√¥ng t√¨m th·∫•y: div#total-" + itemId);
        if (!buyButton) console.error("  -> Kh√¥ng t√¨m th·∫•y: button.buy-seed-button[data-item-id='" + itemId + "']");
        return; // Tho√°t s·ªõm n·∫øu kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ c·∫ßn thi·∫øt
    }

    // X·ª≠ l√Ω gi√° tr·ªã s·ªë l∆∞·ª£ng nh·∫≠p v√†o
    let quantity = parseInt(quantityInput.value);
    const rawValue = quantityInput.value;
    const maxQuantity = parseInt(quantityInput.max) || 99; // L·∫•y max t·ª´ input ho·∫∑c m·∫∑c ƒë·ªãnh 99

    // Validate v√† ƒëi·ªÅu ch·ªânh s·ªë l∆∞·ª£ng
    if (isNaN(quantity) || quantity < 1) {
        quantity = 1; // N·∫øu kh√¥ng h·ª£p l·ªá, ƒë·∫∑t l·∫°i l√† 1
    } else if (quantity > maxQuantity) {
        quantity = maxQuantity; // N·∫øu v∆∞·ª£t qu√° max, ƒë·∫∑t l·∫°i l√† max
        quantityInput.value = maxQuantity; // C·∫≠p nh·∫≠t c·∫£ gi√° tr·ªã hi·ªÉn th·ªã tr√™n input
    }
    // console.log(`  - S·ªë l∆∞·ª£ng ƒë√£ x·ª≠ l√Ω: ${quantity}`);

    // T√≠nh to√°n t·ªïng chi ph√≠
    const totalCost = item.price * quantity;
    // console.log(`  - T·ªïng chi ph√≠ t√≠nh to√°n: ${totalCost}`);

    // *** ƒê√¢y l√† d√≤ng quan tr·ªçng: C·∫≠p nh·∫≠t n·ªôi dung text c·ªßa ph·∫ßn t·ª≠ hi·ªÉn th·ªã t·ªïng ti·ªÅn ***
    totalCostElement.textContent = `Gi√° b√°n: ${totalCost}üí∞`;
    // console.log(`  - ƒê√£ c·∫≠p nh·∫≠t textContent c·ªßa totalCostElement th√†nh: "${totalCostElement.textContent}"`);

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t Mua
    const isInputInvalidOrEmpty = rawValue === '' || isNaN(parseInt(rawValue)) || parseInt(rawValue) < 1;
    buyButton.disabled = gameState.currency < totalCost || isInputInvalidOrEmpty;
    // console.log(`  - Tr·∫°ng th√°i n√∫t Mua (disabled): ${buyButton.disabled}`);
}


        /** X·ª≠ l√Ω click trong khu v·ª±c v∆∞·ªùn (·ª¶y quy·ªÅn s·ª± ki·ªán) */
        function handleGardenClick(event) {
            const clickedPlotElement = event.target.closest('.plot');
            if (!clickedPlotElement) return;
            const plotId = parseInt(clickedPlotElement.dataset.plotId);
            if (isNaN(plotId) || plotId < 0) { console.error("ID √¥ ƒë·∫•t click kh√¥ng h·ª£p l·ªá:", clickedPlotElement.dataset.plotId); return; }
            const isLocked = clickedPlotElement.classList.contains('locked');

            if (isLocked) { handleLockedPlotClick(plotId); }
            else {
                 const plotData = gameState.plots[plotId];
                 if (!plotData) { console.error("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho √¥ ƒë·∫•t ID:", plotId); return; }
                 // ∆Øu ti√™n x·ª≠ l√Ω click d·ªçn c√¢y ch·∫øt do s√¢u tr∆∞·ªõc
                 if (plotData.seedId && plotData.health <= 0 && plotData.causeOfDeath === 'pest') {
                     handleDeadPlotClick(plotId, clickedPlotElement);
                 }
                 // N·∫øu kh√¥ng ph·∫£i ch·∫øt do s√¢u, ho·∫∑c tr·ªëng, ho·∫∑c ƒëang s·ªëng -> M·ªü modal
                 else if (!plotData.seedId) { // √î tr·ªëng
                     handleEmptyPlotClick(plotId);
                 }
                 else if (plotData.seedId) { // C√≥ c√¢y (s·ªëng ho·∫∑c ch·∫øt t·ª± nhi√™n)
                      currentActionPlotId = plotId;
                      updatePlantActionModalButtons(plotId); // C·∫≠p nh·∫≠t modal tr∆∞·ªõc khi m·ªü
                      openModal('plant-action-modal');
                 } else {
                     console.warn("Tr·∫°ng th√°i click √¥ ƒë·∫•t kh√¥ng ƒë∆∞·ª£c x·ª≠ l√Ω cho √¥:", plotId, plotData);
                 }
            }
        }

        /** X·ª≠ l√Ω click v√†o √¥ ƒë·∫•t tr·ªëng ƒë√£ m·ªü kh√≥a -> M·ªü modal h√†nh ƒë·ªông √¥ tr·ªëng */
        function handleEmptyPlotClick(plotId) {
             const plot = gameState.plots[plotId];
             if (!plot || plotId >= gameState.maxUnlockedPlots || plot.seedId) { console.warn(`handleEmptyPlotClick ƒë∆∞·ª£c g·ªçi cho √¥ ${plotId} kh√¥ng tr·ªëng/b·ªã kh√≥a/kh√¥ng h·ª£p l·ªá.`); return; }
            currentActionPlotId = plotId;
            updateEmptyPlotActionModal(plotId);
            openModal('empty-plot-action-modal');

             if(plot.fertility <= 0) {
                 let barrenMsg = `√î ${plotId+1} ƒë·∫•t ƒë√£ C·∫∞N KI·ªÜT (0%)! C√¢y tr·ªìng s·∫Ω m·ªçc R·∫§T ch·∫≠m.`;
                 if (plot.barrenHarvestPenaltyFactor > 1.0) {
                     barrenMsg += ` (L·∫ßn t·ªõi x${plot.barrenHarvestPenaltyFactor.toFixed(2)})`;
                 }
                  barrenMsg += " H√£y b√≥n ph√¢n!";
                 setTimeout(() => showMessage(barrenMsg, "error", MESSAGE_DISPLAY_TIME * 1.5), 200);
             } else if(plot.fertility < LOW_FERTILITY_THRESHOLD) {
                 setTimeout(() => showMessage(`ƒê·∫•t √¥ ${plotId+1} kh√° c·∫±n (${Math.round(plot.fertility)}%), c√¢n nh·∫Øc b√≥n ph√¢n!`, "warning", MESSAGE_DISPLAY_TIME * 1.2), 200);
             }
        }

        /** X·ª≠ l√Ω click v√†o n√∫t trong modal h√†nh ƒë·ªông √¥ tr·ªëng (·ª¶y quy·ªÅn s·ª± ki·ªán) */
        function handleEmptyPlotActionClick(event) {
             const actionButton = event.target.closest('.action-button');
             if (!actionButton || actionButton.disabled) return; // B·ªè qua n·∫øu n√∫t b·ªã disable
             const action = actionButton.dataset.action; // L·∫•y data-action cho c√°c n√∫t c≈©
             const buttonId = actionButton.id; // L·∫•y ID cho n√∫t m·ªõi
             const plotId = parseInt(actionButton.dataset.plotId); // PlotId v·∫´n l·∫•y t·ª´ data-plot-id (c·∫ßn ƒë·∫£m b·∫£o n√∫t T∆∞·ªõi n∆∞·ªõc c≈©ng c√≥)

             // Ki·ªÉm tra plotId tr∆∞·ªõc khi v√†o switch
             if (isNaN(plotId)) {
                 console.error("Kh√¥ng l·∫•y ƒë∆∞·ª£c plotId t·ª´ n√∫t h√†nh ƒë·ªông √¥ tr·ªëng.");
                 closeModal('empty-plot-action-modal');
                 currentActionPlotId = null;
                 return;
             }
             currentActionPlotId = plotId; // L∆∞u l·∫°i ƒë·ªÉ c√°c modal con bi·∫øt (n·∫øu c·∫ßn)

             // S·ª≠ d·ª•ng ID cho n√∫t T∆∞·ªõi n∆∞·ªõc v√† data-action cho c√°c n√∫t kh√°c
             const actionIdentifier = buttonId === 'modal-content-Tuoinuoc' ? buttonId : action;

             switch (actionIdentifier) {
                 case 'plant':
                    selectPlotForPlanting(plotId); break; // H√†m con t·ª± ƒë√≥ng modal tr·ªëng
                 case 'fertilize':
                    openFertilizerSelectionModal(plotId);
                    closeModal('empty-plot-action-modal'); break; // ƒê√≥ng modal tr·ªëng, m·ªü modal ph√¢n b√≥n
                 case 'shop_seed':
                    switchShopTab('seeds'); openModal('shop-modal');
                    closeModal('empty-plot-action-modal'); currentActionPlotId = null; break; // ƒê√≥ng modal tr·ªëng, m·ªü shop
                 // >>> TH√äM CASE CHO N√öT T∆Ø·ªöI N∆Ø·ªöC <<<
                 case 'modal-content-Tuoinuoc':
                     console.log(`N√∫t T∆∞·ªõi N∆∞·ªõc tr√™n √¥ tr·ªëng ${plotId} ƒë∆∞·ª£c click (nh∆∞ng ƒë√£ b·ªã disable).`);
                     // Hi·ªán t·∫°i kh√¥ng l√†m g√¨ v√¨ n√∫t ƒë√£ b·ªã disable
                     showMessage("Kh√¥ng th·ªÉ t∆∞·ªõi √¥ ƒë·∫•t tr·ªëng.", "info");
                     break;
                 // >>> K·∫æT TH√öC CASE T∆Ø·ªöI N∆Ø·ªöC <<<
                 default:
                    console.warn("H√†nh ƒë·ªông √¥ tr·ªëng kh√¥ng x√°c ƒë·ªãnh:", actionIdentifier);
                    closeModal('empty-plot-action-modal'); currentActionPlotId = null;
             }
        }


        /** M·ªü modal ch·ªçn ph√¢n b√≥n cho m·ªôt √¥ ƒë·∫•t c·ª• th·ªÉ */
         function openFertilizerSelectionModal(plotId) {
             if (plotId === null || plotId >= gameState.maxUnlockedPlots || !gameState.plots[plotId]) { console.warn(`openFertilizerSelectionModal g·ªçi cho √¥ ${plotId} kh√¥ng h·ª£p l·ªá.`); currentActionPlotId = null; return; }
             const plot = gameState.plots[plotId];
              if (plot.fertility >= BASE_FERTILITY) {
                 showMessage(`√î ƒë·∫•t ${plotId+1} ƒë√£ c√≥ ƒë·ªô ph√¨ nhi√™u t·ªëi ƒëa!`, "info");
                 if (plantActionModal.style.display === 'block') updatePlantActionModalButtons(plotId);
                 if (emptyPlotActionModal.style.display === 'block') updateEmptyPlotActionModal(plotId);
                 currentActionPlotId = null; return;
             }
             const hasAnyFertilizer = Object.keys(gameState.inventory).some(itemId => {
                const item = ITEM_DATA[itemId];
                return item && item.type === 'tool' && typeof item.fertilityBoost === 'number' && gameState.inventory[itemId] > 0;
             });
             if (!hasAnyFertilizer) {
                  showMessage("B·∫°n kh√¥ng c√≥ lo·∫°i ph√¢n b√≥n n√†o (trong kho ƒë√£ mua)! H√£y mua th√™m ·ªü c·ª≠a h√†ng.", "error");
                  switchShopTab('tools'); openModal('shop-modal');
                  closeModal('plant-action-modal'); closeModal('empty-plot-action-modal');
                  currentActionPlotId = null; return;
             }
             currentActionPlotId = plotId; // L∆∞u plotId ƒëang thao t√°c
             populateFertilizerSelection();
             openModal('fertilizer-selection-modal');
             // Kh√¥ng ƒë√≥ng modal g·ªëc ·ªü ƒë√¢y, ƒë·ªÉ n·∫øu ng∆∞·ªùi d√πng kh√¥ng ch·ªçn ph√¢n b√≥n th√¨ quay l·∫°i modal tr∆∞·ªõc ƒë√≥
         }


        /** X·ª≠ l√Ω click trong Modal H√†nh ƒê·ªông C√¢y Tr·ªìng (·ª¶y quy·ªÅn s·ª± ki·ªán) */
         function handlePlantActionClick(event) {
             const actionButton = event.target.closest('.action-button');
             // >>> B·ªè qua n·∫øu n√∫t b·ªã disable <<<
             if (!actionButton || currentActionPlotId === null || actionButton.disabled) return;
             const plotId = currentActionPlotId;
             const actionId = actionButton.id; // L·∫•y ID c·ªßa n√∫t ƒë∆∞·ª£c click

             // Ki·ªÉm tra plotData c∆° b·∫£n (kh√¥ng c·∫ßn cho n√∫t Shop)
             const plotData = gameState.plots[plotId];
             if (actionId !== 'action-open-shop' && !plotData) {
                 console.warn(`D·ªØ li·ªáu √¥ ƒë·∫•t ${plotId} cho h√†nh ƒë·ªông "${actionId}" kh√¥ng h·ª£p l·ªá.`);
                 closeModal('plant-action-modal'); currentActionPlotId = null; return;
             }
             // Ki·ªÉm tra c√¢y tr·ªìng n·∫øu h√†nh ƒë·ªông y√™u c·∫ßu (kh√¥ng c·∫ßn cho Shop, Clear, Water tr√™n l√Ω thuy·∫øt)
             if (actionId !== 'action-open-shop' && actionId !== 'action-clear-plant' && actionId !== 'modal-content-Tuoinuoc' && !plotData.seedId) {
                 console.warn(`√î ƒë·∫•t ${plotId} kh√¥ng c√≥ c√¢y tr·ªìng cho h√†nh ƒë·ªông "${actionId}".`);
                 closeModal('plant-action-modal'); currentActionPlotId = null; return;
             }

             switch (actionId) {
                 case 'action-harvest-plant':
                    harvestPlant(plotId);
                    closeModal('plant-action-modal'); currentActionPlotId = null; break;
                 case 'action-sell-now':
                    sellPlantDirectly(plotId);
                    closeModal('plant-action-modal'); currentActionPlotId = null; break;
                 case 'action-treat-pest':
                    treatPest(plotId);
                    // Kh√¥ng ƒë√≥ng modal ƒë·ªÉ c√≥ th·ªÉ th·ª±c hi·ªán h√†nh ƒë·ªông kh√°c
                    // closeModal('plant-action-modal'); currentActionPlotId = null;
                    break;
                 case 'action-select-fertilizer':
                    openFertilizerSelectionModal(plotId);
                    closeModal('plant-action-modal'); // ƒê√≥ng modal c√¢y, m·ªü modal ph√¢n b√≥n
                    // currentActionPlotId ƒë∆∞·ª£c gi·ªØ l·∫°i cho modal ph√¢n b√≥n
                    break;

                 // >>> C·∫¨P NH·∫¨T CASE T∆Ø·ªöI N∆Ø·ªöC <<<
                 case 'modal-content-Tuoinuoc':
                     // Ki·ªÉm tra l·∫°i plotData v√† tr·∫°ng th√°i kh√¥ h·∫°n tr∆∞·ªõc khi h√†nh ƒë·ªông
                     if (plotData && plotData.isDry && plotData.health > 0) {
                         console.log(`ƒêang t∆∞·ªõi n∆∞·ªõc cho √¥ ${plotId}.`);
                         plotData.isDry = false; // B·ªè tr·∫°ng th√°i kh√¥ h·∫°n

                         renderGarden(); // C·∫≠p nh·∫≠t giao di·ªán √¥ ƒë·∫•t ngay l·∫≠p t·ª©c
                         updatePlantActionModalButtons(plotId); // C·∫≠p nh·∫≠t l·∫°i modal (n√∫t t∆∞·ªõi s·∫Ω b·ªã disable)
                         showMessage(`ƒê√£ t∆∞·ªõi n∆∞·ªõc cho ${ITEM_DATA[plotData.seedId]?.name || 'c√¢y'} ·ªü √¥ ${plotId + 1}!`, "success");
                         saveGame(); // L∆∞u tr·∫°ng th√°i m·ªõi

                         // Ghi log h√†nh ƒë·ªông
                         logAction('water', plotId, `ƒê√£ t∆∞·ªõi n∆∞·ªõc cho ${ITEM_DATA[plotData.seedId]?.name || 'c√¢y'}.`, 'üíß', null);

                         // Kh√¥ng c·∫ßn ƒë√≥ng modal, ng∆∞·ªùi d√πng c√≥ th·ªÉ mu·ªën l√†m h√†nh ƒë·ªông kh√°c
                     } else {
                         // ƒêi·ªÅu n√†y kh√¥ng n√™n x·∫£y ra n·∫øu n√∫t b·ªã disable ƒë√∫ng c√°ch, nh∆∞ng l√† m·ªôt bi·ªán ph√°p an to√†n
                         console.warn(`N√∫t t∆∞·ªõi n∆∞·ªõc ƒë∆∞·ª£c click cho √¥ ${plotId} nh∆∞ng c√¢y kh√¥ng kh√¥ ho·∫∑c ƒë√£ ch·∫øt.`);
                         showMessage("C√¢y n√†y kh√¥ng c·∫ßn t∆∞·ªõi n∆∞·ªõc ho·∫∑c ƒë√£ ch·∫øt.", "info");
                         // C·∫≠p nh·∫≠t l·∫°i modal ph√≤ng tr∆∞·ªùng h·ª£p tr·∫°ng th√°i thay ƒë·ªïi ng·∫ßm
                         updatePlantActionModalButtons(plotId);
                     }
                     break;
                 // >>> K·∫æT TH√öC CASE T∆Ø·ªöI N∆Ø·ªöC <<<

                 case 'action-clear-plant':
                    handleClearPlantAction(plotId); // H√†m n√†y t·ª± ƒë√≥ng modal n·∫øu c·∫ßn
                    // currentActionPlotId s·∫Ω ƒë∆∞·ª£c reset trong handleClearPlantAction n·∫øu th√†nh c√¥ng
                    break;
                 case 'action-open-shop':
                     console.log("M·ªü c·ª≠a h√†ng t·ª´ modal h√†nh ƒë·ªông c√¢y tr·ªìng...");
                     switchShopTab('seeds'); openModal('shop-modal');
                     closeModal('plant-action-modal'); currentActionPlotId = null;
                     break;
                 default:
                    console.warn("N√∫t h√†nh ƒë·ªông kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c click:", actionId);
                    closeModal('plant-action-modal'); currentActionPlotId = null;
             }
        }

        /** X·ª≠ l√Ω h√†nh ƒë·ªông 'D·ªçn C√¢y', bao g·ªìm x√°c nh·∫≠n v√† ki·ªÉm tra chi ph√≠ ho·∫∑c click mi·ªÖn ph√≠ */
         function handleClearPlantAction(plotId) {
            if (plotId === null || plotId >= gameState.maxUnlockedPlots || !gameState.plots[plotId]) return;
            const plotData = gameState.plots[plotId];
            const plantName = plotData.seedId ? (ITEM_DATA[plotData.seedId]?.name || 'c√¢y') : '√¥ ƒë·∫•t';
            const isDead = plotData.health <= 0;
            const needsCost = isDead && plotData.causeOfDeath === 'pest';
            const canPay = gameState.currency >= DEAD_PEST_CLEANUP_COST;
            let confirmMsg = '';

            if (needsCost) {
                if (canPay) { confirmMsg = `D·ªçn ${plantName} ch·∫øt do s√¢u ·ªü √¥ ${plotId + 1} t·ªën ${DEAD_PEST_CLEANUP_COST}üí∞. B·∫°n c√≥ ch·∫Øc?`; }
                else {
                    // Th√¥ng b√°o kh√¥ng ƒë·ªß ti·ªÅn v√† h∆∞·ªõng d·∫´n click
                    confirmMsg = `B·∫°n kh√¥ng ƒë·ªß ti·ªÅn (${gameState.currency}/${DEAD_PEST_CLEANUP_COST}üí∞) ƒë·ªÉ d·ªçn √¥ n√†y!\nH√£y ƒë√≥ng c·ª≠a s·ªï n√†y v√† click tr·ª±c ti·∫øp v√†o √¥ ƒë·∫•t ${DEAD_PEST_FREE_CLEANUP_CLICKS} l·∫ßn ƒë·ªÉ d·ªçn mi·ªÖn ph√≠.`;
                    showMessage(confirmMsg, "warning", MESSAGE_DISPLAY_TIME * 2);
                    // ƒê√≥ng modal h√†nh ƒë·ªông ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ click tr·ª±c ti·∫øp
                    closeModal('plant-action-modal');
                    currentActionPlotId = null;
                    return; // Kh√¥ng th·ª±c hi·ªán g√¨ th√™m t·ª´ modal
                }
            } else if (isDead) { confirmMsg = `D·ªçn ${plantName} ƒë√£ ch·∫øt (t·ª± nhi√™n) ·ªü √¥ ${plotId + 1}? (Mi·ªÖn ph√≠)`; }
            else { confirmMsg = `B·∫°n c√≥ ch·∫Øc mu·ªën x·ªõi b·ªè ${plantName} ƒëang s·ªëng ·ªü √¥ ${plotId + 1} kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c v√† s·∫Ω kh√¥ng thu ho·∫°ch ƒë∆∞·ª£c g√¨.`; }

            // Ch·ªâ h·ªèi confirm n·∫øu kh√¥ng ph·∫£i tr∆∞·ªùng h·ª£p kh√¥ng ƒë·ªß ti·ªÅn d·ªçn s√¢u ch·∫øt
            if (confirm(confirmMsg)) {
                if (needsCost && canPay) { // ƒê√£ confirm v√† c√≥ ƒë·ªß ti·ªÅn
                    gameState.currency -= DEAD_PEST_CLEANUP_COST; renderUI();
                    showMessage(`ƒê√£ chi ${DEAD_PEST_CLEANUP_COST}üí∞ ƒë·ªÉ d·ªçn √¥ ƒë·∫•t ${plotId+1} b·ªã s√¢u ph√° ho·∫°i.`, "info");
                    clearPlot(plotId); // D·ªçn √¥
                } else if (!needsCost) { // D·ªçn c√¢y ch·∫øt t·ª± nhi√™n ho·∫∑c c√¢y s·ªëng (ƒë√£ confirm)
                    clearPlot(plotId); // D·ªçn √¥
                }
                 // ƒê√≥ng modal sau khi th·ª±c hi·ªán h√†nh ƒë·ªông (ho·∫∑c confirm) th√†nh c√¥ng
                closeModal('plant-action-modal');
                currentActionPlotId = null;
            }
         }

         /** H√†nh ƒë·ªông: D·ªçn s·∫°ch m·ªôt √¥ ƒë·∫•t, reset tr·∫°ng th√°i c√¢y tr·ªìng v√† c√°c thu·ªôc t√≠nh li√™n quan. */
         function clearPlot(plotId) {
             // 1. Ki·ªÉm tra ƒë·∫ßu v√†o
             if (plotId === null || plotId >= gameState.maxUnlockedPlots || !gameState.plots[plotId]) {
                 console.warn(`C·ªë g·∫Øng d·ªçn √¥ kh√¥ng h·ª£p l·ªá/b·ªã kh√≥a ${plotId}.`);
                 return;
             }
             const plot = gameState.plots[plotId];

             // 2. L∆∞u tr·ªØ th√¥ng tin *tr∆∞·ªõc* khi reset ƒë·ªÉ log v√† hi·ªÉn th·ªã th√¥ng b√°o
             const wasPlanted = !!plot.seedId;
             const originalSeedId = plot.seedId; // L∆∞u l·∫°i ID h·∫°t gi·ªëng g·ªëc n·∫øu c√≥
             const plantName = wasPlanted ? (ITEM_DATA[originalSeedId]?.name || 'c√¢y') : '√¥ ƒë·∫•t';
             const wasDead = wasPlanted && plot.health <= 0;
             const causeOfDeath = plot.causeOfDeath; // L·∫•y nguy√™n nh√¢n ch·∫øt *tr∆∞·ªõc khi reset*
             const wasPestDeath = wasDead && causeOfDeath === 'pest';
             // Ki·ªÉm tra xem c√≥ ph·∫£i l√† tr∆∞·ªùng h·ª£p d·ªçn s√¢u mi·ªÖn ph√≠ kh√¥ng
             const wasFreePestCleanup = wasPestDeath && (plot.pestDeathClickCount || 0) >= DEAD_PEST_FREE_CLEANUP_CLICKS;

             // 3. --- Reset Tr·∫°ng Th√°i √î ƒê·∫•t ---
             plot.seedId = null;               // X√≥a th√¥ng tin c√¢y tr·ªìng
             plot.plantTime = null;            // X√≥a th·ªùi gian tr·ªìng
             plot.hasPest = false;             // X√≥a tr·∫°ng th√°i s√¢u b·ªánh
             plot.health = INITIAL_PLANT_HEALTH; // Ph·ª•c h·ªìi m√°u v·ªÅ ƒë·∫ßy (cho l·∫ßn tr·ªìng sau)
             plot.causeOfDeath = null;        // X√≥a nguy√™n nh√¢n ch·∫øt
             plot.pestDeathClickCount = 0;     // Reset b·ªô ƒë·∫øm click d·ªçn s√¢u
             plot.barrenHarvestPenaltyFactor = 1.0; // Reset h·ªá s·ªë ph·∫°t ƒë·∫•t c·∫±n
             plot.isDry = false; // <<< *** Quan tr·ªçng: Reset tr·∫°ng th√°i kh√¥ h·∫°n *** >>>
             // *** L∆ØU √ù: KH√îNG reset plot.fertility (ƒë·ªô ph√¨ nhi√™u) ***

             // 4. C·∫≠p nh·∫≠t giao di·ªán v√† L∆∞u game (n√™n l√†m tr∆∞·ªõc khi hi·ªÉn th·ªã th√¥ng b√°o/log)
             renderGarden(); // V·∫Ω l·∫°i khu v∆∞·ªùn v·ªõi √¥ ƒë·∫•t ƒë√£ ƒë∆∞·ª£c d·ªçn
             saveGame();     // L∆∞u tr·∫°ng th√°i game m·ªõi

             // 5. <<< C·∫¨P NH·∫¨T LOG ACTION >>>
             let logDetails = '';
             let logIcon = '‚õèÔ∏è'; // Icon m·∫∑c ƒë·ªãnh l√† x·ªõi/d·ªçn
             if (wasPlanted) { // Ch·ªâ log chi ti·∫øt n·∫øu tr∆∞·ªõc ƒë√≥ c√≥ c√¢y
                 if (wasPestDeath) {
                     logIcon = 'üíÄ'; // Icon ch·∫øt
                     logDetails = `ƒê√£ d·ªçn ${plantName} (ch·∫øt do s√¢u, ${wasFreePestCleanup ? 'mi·ªÖn ph√≠' : 't·ªën ph√≠'}) ·ªü √¥ ${plotId + 1}.`;
                 } else if (wasDead && causeOfDeath === 'dryness') { // <<< X·ª¨ L√ù NGUY√äN NH√ÇN KH√î H·∫†N >>>
                     logIcon = 'üíÄ'; // Icon ch·∫øt
                     logDetails = `ƒê√£ d·ªçn ${plantName} (ch·∫øt do kh√¥ h·∫°n) ·ªü √¥ ${plotId + 1}.`;
                 } else if (wasDead) { // Ch·∫øt t·ª± nhi√™n (causeOfDeath c√≥ th·ªÉ l√† null ho·∫∑c gi√° tr·ªã kh√°c)
                     logIcon = 'üíÄ'; // Icon ch·∫øt
                     logDetails = `ƒê√£ d·ªçn ${plantName} (ch·∫øt t·ª± nhi√™n) ·ªü √¥ ${plotId + 1}.`;
                 } else { // C√¢y ƒëang s·ªëng b·ªã x·ªõi b·ªè
                     // Icon v·∫´n l√† ‚õèÔ∏è
                     logDetails = `ƒê√£ x·ªõi b·ªè ${plantName} (ƒëang s·ªëng) ·ªü √¥ ${plotId + 1}.`;
                 }
             } else {
                 // Tr∆∞·ªùng h·ª£p hi·∫øm: D·ªçn m·ªôt √¥ ƒë·∫•t ƒë√£ tr·ªëng s·∫µn
                 logDetails = `ƒê√£ d·ªçn/x·ªõi √¥ ƒë·∫•t tr·ªëng ${plotId + 1}.`;
             }
             // Ghi log h√†nh ƒë·ªông v·ªõi th√¥ng tin chi ti·∫øt
             logAction('clear', plotId, logDetails, logIcon, originalSeedId);
             // <<< K·∫æT TH√öC LOG ACTION >>>

             // 6. --- Hi·ªÉn th·ªã Th√¥ng b√°o cho ng∆∞·ªùi ch∆°i (t√πy ch·ªânh) ---
             // Kh√¥ng hi·ªÉn th·ªã l·∫°i message n·∫øu l√† tr∆∞·ªùng h·ª£p tr·∫£ ph√≠ d·ªçn s√¢u (ƒë√£ c√≥ msg tr∆∞·ªõc ƒë√≥)
             if (!(wasPestDeath && !wasFreePestCleanup)) {
                 if (wasFreePestCleanup) {
                     // Message cho d·ªçn s√¢u mi·ªÖn ph√≠ ƒë√£ hi·ªÉn th·ªã khi ƒë·ªß click, kh√¥ng c·∫ßn th√™m ·ªü ƒë√¢y
                 } else if (wasDead && causeOfDeath === 'dryness') { // <<< TH√îNG B√ÅO CH·∫æT KH√î >>>
                     showMessage(`ƒê√£ d·ªçn ${plantName} ch·∫øt kh√¥ kh·ªèi √¥ ${plotId + 1}.`, "info");
                 } else if (wasPlanted && !wasDead) { // X·ªõi c√¢y s·ªëng
                     showMessage(`ƒê√£ x·ªõi b·ªè ${plantName} ƒëang s·ªëng ·ªü √¥ ${plotId + 1}.`, "warning");
                 } else if (wasDead) { // D·ªçn c√¢y ch·∫øt t·ª± nhi√™n
                     showMessage(`ƒê√£ d·ªçn ${plantName} ch·∫øt kh·ªèi √¥ ${plotId + 1}.`, "info");
                 }
                 // Kh√¥ng c·∫ßn th√¥ng b√°o ƒë·∫∑c bi·ªát khi d·ªçn √¥ ƒë√£ tr·ªëng.
             }

             // 7. ƒê√≥ng modal h√†nh ƒë·ªông n·∫øu n√≥ ƒëang m·ªü cho √¥ n√†y
             if (plantActionModal.style.display === 'block' && currentActionPlotId === plotId) {
                 closeModal('plant-action-modal');
                 currentActionPlotId = null; // Reset ID ƒëang h√†nh ƒë·ªông
             }
         } // --- K·∫øt th√∫c h√†m clearPlot ---

        /** H√†nh ƒë·ªông: X·ª≠ l√Ω khi click tr·ª±c ti·∫øp v√†o c√¢y ch·∫øt (ki·ªÉm tra ph√≠ ho·∫∑c click mi·ªÖn ph√≠) */
         function handleDeadPlotClick(plotId, plotElement) {
             if (plotId === null || plotId >= gameState.maxUnlockedPlots || !gameState.plots[plotId] || !gameState.plots[plotId].seedId || gameState.plots[plotId].health > 0) return;
             const plot = gameState.plots[plotId];
             const plotInfoElement = plotElement ? plotElement.querySelector('.plot-info') : null;

             if (plot.causeOfDeath === 'pest') {
                 const hasEnoughMoney = gameState.currency >= DEAD_PEST_CLEANUP_COST;
                 if (hasEnoughMoney) {
                      // M·ªü modal ƒë·ªÉ x√°c nh·∫≠n tr·∫£ ph√≠
                      currentActionPlotId = plotId;
                      updatePlantActionModalButtons(plotId);
                      openModal('plant-action-modal');
                      // Th√¥ng b√°o ph·ª• tr·ª£
                      setTimeout(() => showMessage(`C√¢y ch·∫øt do s√¢u. Click "D·ªçn S·∫°ch" trong c·ª≠a s·ªï v·ª´a m·ªü (t·ªën ${DEAD_PEST_CLEANUP_COST}üí∞) ho·∫∑c click tr·ª±c ti·∫øp v√†o √¥ ƒë·∫•t n√†y ${DEAD_PEST_FREE_CLEANUP_CLICKS} l·∫ßn n·∫øu b·∫°n ƒë·ªïi √Ω/h·∫øt ti·ªÅn.`, "warning", MESSAGE_DISPLAY_TIME * 1.8), 100);
                 } else {
                     // Ti·∫øn h√†nh click mi·ªÖn ph√≠
                     plot.pestDeathClickCount++;
                     const clicksRemaining = DEAD_PEST_FREE_CLEANUP_CLICKS - plot.pestDeathClickCount;
                     if (clicksRemaining <= 0) {
                         showMessage(`Yeah! ƒê√£ click ƒë·ªß ${DEAD_PEST_FREE_CLEANUP_CLICKS} l·∫ßn! D·ªçn √¥ ƒë·∫•t ${plotId+1} mi·ªÖn ph√≠!`, "success");
                         clearPlot(plotId); // D·ªçn ngay khi ƒë·ªß click
                     }
                     else {
                         showMessage(`C√≤n ${clicksRemaining} l·∫ßn click n·ªØa ƒë·ªÉ d·ªçn √¥ ${plotId+1} mi·ªÖn ph√≠!`, "info");
                          // C·∫≠p nh·∫≠t text tr√™n √¥ ƒë·∫•t ngay l·∫≠p t·ª©c
                          if (plotInfoElement) {
                              plotInfoElement.textContent = `üíÄ Ch·∫øt (S√¢u)! Click ${clicksRemaining} l·∫ßn...`;
                              plotInfoElement.classList.add('free-cleanup-progress');
                              plotInfoElement.classList.remove('needs-cleanup-fee');
                          }
                         // Kh√¥ng c·∫ßn saveGame() m·ªói l·∫ßn click, s·∫Ω save khi d·ªçn xong ho·∫∑c auto save
                     }
                 }
             } else { // Ch·∫øt t·ª± nhi√™n -> M·ªü modal ƒë·ªÉ d·ªçn mi·ªÖn ph√≠
                 currentActionPlotId = plotId;
                 updatePlantActionModalButtons(plotId);
                 openModal('plant-action-modal');
                 setTimeout(() => showMessage(`C√¢y ƒë√£ ch·∫øt t·ª± nhi√™n. Click "X·ªõi ƒê·∫•t" trong c·ª≠a s·ªï v·ª´a m·ªü ƒë·ªÉ d·ªçn mi·ªÖn ph√≠.`, "info"), 100);
             }
         }


        /** H√†nh ƒë·ªông: S·ª≠ d·ª•ng thu·ªëc tr·ª´ s√¢u t·ª´ kho ƒê√É MUA. */
        function treatPest(plotId) {
            if (plotId === null || plotId >= gameState.maxUnlockedPlots || !gameState.plots[plotId]) {
                console.warn(`treatPest ƒë∆∞·ª£c g·ªçi cho √¥ ${plotId} kh√¥ng h·ª£p l·ªá.`);
                return;
            }
            const plot = gameState.plots[plotId];
            const plantName = plot.seedId ? (ITEM_DATA[plot.seedId]?.name || 'c√¢y') : '√¥ ƒë·∫•t'; // L·∫•y t√™n c√¢y n·∫øu c√≥

            if (!plot.hasPest) {
                showMessage(`C√¢y ${plantName} n√†y hi·ªán kh√¥ng c√≥ s√¢u.`, "info");
                return;
            }
            if (plot.health <= 0) {
                showMessage(`C√¢y ${plantName} ƒë√£ ch·∫øt, kh√¥ng th·ªÉ tr·ªã s√¢u!`, "warning");
                return;
            }

            const currentPesticide = gameState.inventory.pesticide || 0;
            if (currentPesticide > 0) {
                // --- Th·ª±c hi·ªán tr·ªã s√¢u ---
                gameState.inventory.pesticide--; // Tr·ª´ thu·ªëc kh·ªèi kho ƒë√£ mua
                plot.hasPest = false; // Lo·∫°i b·ªè tr·∫°ng th√°i s√¢u

                // C·∫≠p nh·∫≠t UI v√† L∆∞u game
                renderUI(); // C·∫≠p nh·∫≠t ti·ªÅn (kh√¥ng ƒë·ªïi)
                renderGarden(); // V·∫Ω l·∫°i ƒë·ªÉ b·ªè icon s√¢u v√† hi·ªáu ·ª©ng vi·ªÅn ƒë·ªè
                if (inventoryModal.style.display === 'block') renderInventory(); // C·∫≠p nh·∫≠t kho n·∫øu ƒëang m·ªü
                saveGame();

                // Hi·ªÉn th·ªã th√¥ng b√°o
                showMessage(`ƒê√£ d√πng ${ITEM_DATA.pesticide.name} cho ${plantName} ·ªü √¥ ${plotId + 1}.`, "success");

                // <<< TH√äM LOG ACTION >>>
                logAction('pest', plotId, `ƒê√£ d√πng ${ITEM_DATA.pesticide.name} cho ${plantName}.`, 'üíä', 'pesticide');
                // <<< K·∫æT TH√öC LOG ACTION >>>

                // C·∫≠p nh·∫≠t l·∫°i modal h√†nh ƒë·ªông n·∫øu n√≥ ƒëang m·ªü cho √¥ n√†y
                if (plantActionModal.style.display === 'block' && currentActionPlotId === plotId) {
                    updatePlantActionModalButtons(plotId);
                }

            } else { // H·∫øt thu·ªëc
                showMessage(`H·∫øt ${ITEM_DATA.pesticide.name} (trong kho ƒë√£ mua) r·ªìi! üò≠ H√£y mua th√™m ·ªü c·ª≠a h√†ng.`, "error");
                // ƒê√≥ng modal h√†nh ƒë·ªông (n·∫øu m·ªü) v√† m·ªü c·ª≠a h√†ng
                if (plantActionModal.style.display === 'block') closeModal('plant-action-modal');
                currentActionPlotId = null;
                switchShopTab('tools');
                openModal('shop-modal');
            }
        }

         /** X·ª≠ l√Ω ch·ªçn ph√¢n b√≥n t·ª´ modal (·ª¶y quy·ªÅn s·ª± ki·ªán) */
         function handleFertilizerSelection(event) {
             const useButton = event.target.closest('.use-button');
             // Ph·∫£i c√≥ plotId ƒë√£ l∆∞u t·ª´ tr∆∞·ªõc v√† n√∫t ph·∫£i ƒë∆∞·ª£c enable
             if (!useButton || currentActionPlotId === null || useButton.disabled) return;
             const fertilizerId = useButton.dataset.fertilizerId;
             if (!fertilizerId || !ITEM_DATA[fertilizerId]) { console.error("ID ph√¢n b√≥n kh√¥ng h·ª£p l·ªá:", fertilizerId); closeModal('fertilizer-selection-modal'); currentActionPlotId = null; return; }

             const plotIdToFertilize = currentActionPlotId; // L·∫•y plotId ƒë√£ l∆∞u
             applyFertilizer(plotIdToFertilize, fertilizerId);
             closeModal('fertilizer-selection-modal');
             currentActionPlotId = null; // Reset ID sau khi √°p d·ª•ng th√†nh c√¥ng
         }


        /** H√†nh ƒë·ªông: √Åp d·ª•ng ph√¢n b√≥n ƒë√£ ch·ªçn v√†o √¥ ƒë·∫•t m·ª•c ti√™u. */
        function applyFertilizer(plotId, fertilizerId) {
            if (plotId === null || plotId >= gameState.maxUnlockedPlots || !gameState.plots[plotId]) {
                console.warn(`applyFertilizer g·ªçi tr√™n √¥ ${plotId} kh√¥ng h·ª£p l·ªá/b·ªã kh√≥a.`);
                return;
            }
            const plot = gameState.plots[plotId];
            const item = ITEM_DATA[fertilizerId];

            if (!item || item.type !== 'tool' || typeof item.fertilityBoost !== 'number') {
                console.warn(`applyFertilizer g·ªçi v·ªõi fertilizerId ${fertilizerId} kh√¥ng h·ª£p l·ªá.`);
                return;
            }

            if ((gameState.inventory[fertilizerId] || 0) <= 0) {
                showMessage(`B·∫°n kh√¥ng c√≥ ${item.name} (trong kho ƒë√£ mua)!`, "error");
                // ƒê√≥ng c√°c modal l·ª±a ch·ªçn n·∫øu ng∆∞·ªùi ch∆°i h·∫øt ph√¢n b√≥n
                if (fertilizerSelectionModal.style.display === 'block') closeModal('fertilizer-selection-modal');
                currentActionPlotId = null;
                return;
            }
            if (plot.fertility >= BASE_FERTILITY) {
                showMessage(`√î ƒë·∫•t ${plotId + 1} ƒë√£ c√≥ ƒë·ªô ph√¨ nhi√™u t·ªëi ƒëa!`, "info");
                // Kh√¥ng ƒë√≥ng modal l·ª±a ch·ªçn, ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ ch·ªçn l·∫°i n·∫øu mu·ªën
                return;
            }

            // --- Th·ª±c hi·ªán b√≥n ph√¢n ---
            gameState.inventory[fertilizerId]--; // Tr·ª´ ph√¢n b√≥n kh·ªèi kho ƒë√£ mua

            const boostAmount = (item.fertilityBoost || 0) * BASE_FERTILITY;
            const oldFertility = plot.fertility;
            plot.fertility = Math.min(BASE_FERTILITY, plot.fertility + boostAmount);
            const actualBoost = plot.fertility - oldFertility;

            // [M·ªöI Req 4] Reset h·ªá s·ªë ph·∫°t n·∫øu ƒë·∫•t h·∫øt c·∫±n nh·ªù b√≥n ph√¢n
            if (oldFertility <= 0 && plot.fertility > 0) {
                plot.barrenHarvestPenaltyFactor = 1.0;
                console.log(`√î ${plotId} ƒë∆∞·ª£c ph·ª•c h·ªìi t·ª´ c·∫±n nh·ªù b√≥n ph√¢n, barrenHarvestPenaltyFactor reset v·ªÅ 1.0.`);
            }

            // C·∫≠p nh·∫≠t UI v√† L∆∞u game
            renderUI(); // C·∫≠p nh·∫≠t ti·ªÅn (kh√¥ng ƒë·ªïi nh∆∞ng ƒë·ªÉ ƒë√≥ cho nh·∫•t qu√°n)
            renderGarden(); // V·∫Ω l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t thanh ph√¨ nhi√™u v√† text
            if (inventoryModal.style.display === 'block') renderInventory(); // C·∫≠p nh·∫≠t kho n·∫øu ƒëang m·ªü
            saveGame();

            // Hi·ªÉn th·ªã th√¥ng b√°o
            let successMsg = `ƒê√£ b√≥n ${item.name} cho √¥ ${plotId + 1}. ƒê·ªô ph√¨ tƒÉng +${actualBoost.toFixed(0)}% (Hi·ªán t·∫°i: ${Math.round(plot.fertility)}%).`;
            if(oldFertility <= 0 && plot.fertility > 0) {
                 successMsg += `\nƒê·∫•t ƒë√£ ƒë∆∞·ª£c ph·ª•c h·ªìi t·ª´ tr·∫°ng th√°i c·∫±n ki·ªát v√† h·ªá s·ªë ph·∫°t m·ªçc ch·∫≠m ƒë√£ ƒë∆∞·ª£c x√≥a!`;
             }
            showMessage(successMsg, "success", successMsg.includes('\n') ? MESSAGE_DISPLAY_TIME + 1000 : MESSAGE_DISPLAY_TIME);

            // <<< TH√äM LOG ACTION >>>
            logAction('fertilize', plotId, `ƒê√£ b√≥n ${item.name} (+${actualBoost.toFixed(0)}% ph√¨).`, 'üí©', fertilizerId);
            // <<< K·∫æT TH√öC LOG ACTION >>>

            // T·ª± ƒë·ªông ƒë√≥ng modal ch·ªçn ph√¢n b√≥n sau khi th√†nh c√¥ng
            if (fertilizerSelectionModal.style.display === 'block') closeModal('fertilizer-selection-modal');
            // C·∫≠p nh·∫≠t l·∫°i modal h√†nh ƒë·ªông g·ªëc n·∫øu n√≥ v·∫´n m·ªü (v√≠ d·ª•: m·ªü t·ª´ c√¢y tr·ªìng)
            if (plantActionModal.style.display === 'block' && currentActionPlotId === plotId) {
                 updatePlantActionModalButtons(plotId);
            } else if (emptyPlotActionModal.style.display === 'block' && currentActionPlotId === plotId) {
                 updateEmptyPlotActionModal(plotId);
            }
             currentActionPlotId = null; // Reset ID sau khi ho√†n t·∫•t
        }

         /** H√†nh ƒë·ªông: Thu ho·∫°ch c√¢y, th√™m v√†o kho "ƒê√£ Thu Ho·∫°ch", v√† c·∫≠p nh·∫≠t h·ªá s·ªë ph·∫°t n·∫øu c·∫ßn. */
          function harvestPlant(plotId) {
             if (plotId === null || plotId >= gameState.maxUnlockedPlots || !gameState.plots[plotId] || !gameState.plots[plotId].seedId || !gameState.plots[plotId].plantTime) {
                  console.warn(`harvestPlant ƒë∆∞·ª£c g·ªçi cho √¥ ${plotId} kh√¥ng h·ª£p l·ªá.`);
                  return;
             }
             const plot = gameState.plots[plotId];
             const seedInfo = ITEM_DATA[plot.seedId];
             if (!seedInfo || seedInfo.type !== 'seed') {
                 console.error(`D·ªØ li·ªáu h·∫°t gi·ªëng ${plot.seedId} kh√¥ng h·ª£p l·ªá khi thu ho·∫°ch.`);
                 clearPlot(plotId); // D·ªçn √¥ n·∫øu d·ªØ li·ªáu c√¢y b·ªã l·ªói
                 return;
             }

             const now = Date.now();
             const stageInfo = getPlantStageInfo(plot, now);

             // Ki·ªÉm tra ƒëi·ªÅu ki·ªán thu ho·∫°ch
             if (!stageInfo || stageInfo.isError || !stageInfo.isMature || plot.hasPest || plot.health <= 0) {
                 let reason = "kh√¥ng r√µ";
                 if (!stageInfo || stageInfo.isError) reason = "l·ªói d·ªØ li·ªáu c√¢y";
                 else if (!stageInfo.isMature) reason = "c√¢y ch∆∞a ch√≠n";
                 else if (plot.hasPest) reason = "c√¢y ƒëang b·ªã s√¢u";
                 else if (plot.health <= 0) reason = "c√¢y ƒë√£ ch·∫øt";
                 showMessage(`Kh√¥ng th·ªÉ thu ho·∫°ch ${seedInfo.name} v√¨ ${reason}!`, "warning");
                 return;
             }

             // --- Th·ª±c hi·ªán thu ho·∫°ch ---
             const harvestQuantity = 1; // Lu√¥n thu ho·∫°ch 1 c√¢y m·ªói l·∫ßn
             const harvestedItemId = plot.seedId;
             const harvestedPlantName = seedInfo.name;
             const fertilityBeforeHarvest = plot.fertility; // Ghi l·∫°i ƒë·ªô ph√¨ tr∆∞·ªõc khi reset
             let penaltyFactorBeforeHarvest = plot.barrenHarvestPenaltyFactor || 1.0; // Ghi l·∫°i h·ªá s·ªë ph·∫°t tr∆∞·ªõc khi reset

             // Th√™m v√†o kho ƒë√£ thu ho·∫°ch
             gameState.harvestedItems[harvestedItemId] = (gameState.harvestedItems[harvestedItemId] || 0) + harvestQuantity;

             // Reset √¥ ƒë·∫•t sau thu ho·∫°ch (gi·ªØ l·∫°i fertility v√† penalty factor)
             plot.seedId = null;
             plot.plantTime = null;
             plot.hasPest = false;
             plot.health = INITIAL_PLANT_HEALTH;
             plot.causeOfDeath = null;
             plot.pestDeathClickCount = 0;
             // plot.fertility kh√¥ng ƒë·ªïi
             // plot.barrenHarvestPenaltyFactor s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b√™n d∆∞·ªõi

             // [M·ªöI Req 4] C·∫≠p nh·∫≠t h·ªá s·ªë ph·∫°t N·∫æU thu ho·∫°ch tr√™n ƒë·∫•t c·∫±n
             let penaltyApplied = false;
             if (fertilityBeforeHarvest <= 0) {
                 plot.barrenHarvestPenaltyFactor = penaltyFactorBeforeHarvest * BARREN_HARVEST_PENALTY_MULTIPLIER;
                 penaltyApplied = true;
                 console.log(`√î ${plotId} thu ho·∫°ch tr√™n ƒë·∫•t c·∫±n. Penalty factor tƒÉng l√™n ${plot.barrenHarvestPenaltyFactor.toFixed(2)}`);
             } else {
                  // N·∫øu thu ho·∫°ch tr√™n ƒë·∫•t kh√¥ng c·∫±n, ƒë·∫£m b·∫£o penalty l√† 1.0 cho l·∫ßn sau (ph√≤ng l·ªói)
                  plot.barrenHarvestPenaltyFactor = 1.0;
             }

             // C·∫≠p nh·∫≠t UI v√† L∆∞u game
             renderUI();
             renderGarden();
             if (inventoryModal.style.display === 'block') renderInventory();
             saveGame();

             // Hi·ªÉn th·ªã th√¥ng b√°o thu ho·∫°ch
             let harvestMessage = `ƒê√£ thu ho·∫°ch ${harvestQuantity} ${harvestedPlantName}! Th√™m v√†o kho "ƒê√£ Thu Ho·∫°ch".`;
             const fertilityAfterHarvest = plot.fertility; // L·∫•y ƒë·ªô ph√¨ ƒë√£ c·∫≠p nh·∫≠t (kh√¥ng ƒë·ªïi)
             harvestMessage += `\nƒê·ªô ph√¨ nhi√™u c√≤n l·∫°i: ${fertilityAfterHarvest.toFixed(0)}%.`;
             if (fertilityAfterHarvest <= 0) {
                  harvestMessage += `\nC·∫¢NH B√ÅO: ƒê·∫•t ƒë√£ C·∫∞N KI·ªÜT!`;
                  if(penaltyApplied) {
                       harvestMessage += ` L·∫ßn tr·ªìng t·ªõi s·∫Ω m·ªçc ch·∫≠m x${plot.barrenHarvestPenaltyFactor.toFixed(2)}!`;
                  }
             }
             else if (fertilityAfterHarvest < LOW_FERTILITY_THRESHOLD) harvestMessage += `\nC·∫¢NH B√ÅO: ƒê·∫•t kh√° c·∫±n!`;

             showMessage(harvestMessage, "success", harvestMessage.includes('\n') ? MESSAGE_DISPLAY_TIME + 1500 : MESSAGE_DISPLAY_TIME);

             // <<< TH√äM LOG ACTION >>>
             logAction('harvest', plotId, `ƒê√£ thu ho·∫°ch ${harvestQuantity} ${harvestedPlantName}.`, 'üß∫', harvestedItemId);
             // <<< K·∫æT TH√öC LOG ACTION >>>
         }

         /** H√†nh ƒë·ªông: B√°n c√¢y tr·ª±c ti·∫øp t·ª´ √¥ ƒë·∫•t, v√† c·∫≠p nh·∫≠t h·ªá s·ªë ph·∫°t n·∫øu c·∫ßn. */
         function sellPlantDirectly(plotId) {
             if (plotId === null || plotId >= gameState.maxUnlockedPlots || !gameState.plots[plotId] || !gameState.plots[plotId].seedId || !gameState.plots[plotId].plantTime) {
                 console.warn(`sellPlantDirectly ƒë∆∞·ª£c g·ªçi cho √¥ ${plotId} kh√¥ng h·ª£p l·ªá.`);
                 return;
             }
             const plot = gameState.plots[plotId];
             const seedInfo = ITEM_DATA[plot.seedId];
             if (!seedInfo || seedInfo.type !== 'seed') {
                 console.error(`D·ªØ li·ªáu h·∫°t gi·ªëng ${plot.seedId} kh√¥ng h·ª£p l·ªá khi b√°n tr·ª±c ti·∫øp.`);
                 clearPlot(plotId); // D·ªçn √¥ n·∫øu d·ªØ li·ªáu c√¢y b·ªã l·ªói
                 return;
             }

             const now = Date.now();
             const stageInfo = getPlantStageInfo(plot, now);

             // Ki·ªÉm tra ƒëi·ªÅu ki·ªán b√°n
             if (!stageInfo || stageInfo.isError || !stageInfo.isMature || plot.hasPest || plot.health <= 0) {
                 let reason = "kh√¥ng r√µ";
                 if (!stageInfo || stageInfo.isError) reason = "l·ªói d·ªØ li·ªáu c√¢y";
                 else if (!stageInfo.isMature) reason = "c√¢y ch∆∞a ch√≠n";
                 else if (plot.hasPest) reason = "c√¢y ƒëang b·ªã s√¢u";
                 else if (plot.health <= 0) reason = "c√¢y ƒë√£ ch·∫øt";
                 showMessage(`Kh√¥ng th·ªÉ b√°n ngay ${seedInfo.name} v√¨ ${reason}!`, "warning");
                 return;
             }

             // --- Th·ª±c hi·ªán b√°n tr·ª±c ti·∫øp ---
             const quantitySold = 1; // Lu√¥n b√°n 1 c√¢y m·ªói l·∫ßn
             // Gi√° tr·ªã b√°n = S·ªë l∆∞·ª£ng * (T·ªâ l·ªá m√°u) * Gi√° tr·ªã g·ªëc
             const earnings = Math.round(quantitySold * (plot.health / 100)) * (seedInfo.harvestYield || 0);
             const fertilityBeforeSell = plot.fertility; // Ghi l·∫°i ƒë·ªô ph√¨
             let penaltyFactorBeforeSell = plot.barrenHarvestPenaltyFactor || 1.0; // Ghi l·∫°i h·ªá s·ªë ph·∫°t

             // C·ªông ti·ªÅn
             gameState.currency += earnings;

             // Reset √¥ ƒë·∫•t gi·ªëng h·ªát thu ho·∫°ch (gi·ªØ l·∫°i fertility v√† penalty factor)
             const soldItemId = plot.seedId; // L∆∞u l·∫°i ID tr∆∞·ªõc khi reset
             plot.seedId = null;
             plot.plantTime = null;
             plot.hasPest = false;
             plot.health = INITIAL_PLANT_HEALTH;
             plot.causeOfDeath = null;
             plot.pestDeathClickCount = 0;
             // plot.fertility kh√¥ng ƒë·ªïi
             // plot.barrenHarvestPenaltyFactor s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b√™n d∆∞·ªõi

             // [M·ªöI Req 4] C·∫≠p nh·∫≠t h·ªá s·ªë ph·∫°t N·∫æU b√°n tr√™n ƒë·∫•t c·∫±n
             let penaltyAppliedSell = false;
             if (fertilityBeforeSell <= 0) {
                 plot.barrenHarvestPenaltyFactor = penaltyFactorBeforeSell * BARREN_HARVEST_PENALTY_MULTIPLIER;
                 penaltyAppliedSell = true;
                 console.log(`√î ${plotId} b√°n tr√™n ƒë·∫•t c·∫±n. Penalty factor tƒÉng l√™n ${plot.barrenHarvestPenaltyFactor.toFixed(2)}`);
             } else {
                  // N·∫øu b√°n tr√™n ƒë·∫•t kh√¥ng c·∫±n, ƒë·∫£m b·∫£o penalty l√† 1.0
                  plot.barrenHarvestPenaltyFactor = 1.0;
             }

             // C·∫≠p nh·∫≠t UI v√† L∆∞u game
             renderUI();
             updateShopButtons(); // C·∫≠p nh·∫≠t n√∫t shop v√¨ ti·ªÅn thay ƒë·ªïi
             renderGarden();
             saveGame();

             // Hi·ªÉn th·ªã th√¥ng b√°o b√°n
             let sellMessage = `ƒê√£ b√°n tr·ª±c ti·∫øp ${quantitySold} ${seedInfo.name}! +${earnings}üí∞.`;
             const fertilityAfterSell = plot.fertility; // L·∫•y ƒë·ªô ph√¨ ƒë√£ c·∫≠p nh·∫≠t (kh√¥ng ƒë·ªïi)
             sellMessage += `\nƒê·ªô ph√¨ nhi√™u c√≤n l·∫°i: ${fertilityAfterSell.toFixed(0)}%.`;
              if (fertilityAfterSell <= 0) {
                   sellMessage += `\nC·∫¢NH B√ÅO: ƒê·∫•t ƒë√£ C·∫∞N KI·ªÜT!`;
                   if(penaltyAppliedSell) {
                        sellMessage += ` L·∫ßn tr·ªìng t·ªõi s·∫Ω m·ªçc ch·∫≠m x${plot.barrenHarvestPenaltyFactor.toFixed(2)}!`;
                   }
              }
              else if (fertilityAfterSell < LOW_FERTILITY_THRESHOLD) sellMessage += `\nC·∫¢NH B√ÅO: ƒê·∫•t kh√° c·∫±n!`;

             showMessage(sellMessage, "success", sellMessage.includes('\n') ? MESSAGE_DISPLAY_TIME + 1500 : MESSAGE_DISPLAY_TIME);

             // <<< TH√äM LOG ACTION >>>
             logAction('sell_direct', plotId, `ƒê√£ b√°n tr·ª±c ti·∫øp ${quantitySold} ${seedInfo.name} (+${earnings}üí∞).`, 'üí∞', soldItemId);
             // <<< K·∫æT TH√öC LOG ACTION >>>
         }

        /** H√†nh ƒë·ªông: B·∫Øt ƒë·∫ßu qu√° tr√¨nh tr·ªìng c√¢y cho √¥ ƒë·∫•t tr·ªëng -> M·ªü modal ch·ªçn h·∫°t gi·ªëng. */
        function selectPlotForPlanting(plotId) {
             if (plotId === null || plotId >= gameState.maxUnlockedPlots || !gameState.plots[plotId] || gameState.plots[plotId].seedId) {
                  showMessage("√î ƒë·∫•t n√†y kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ c√≥ c√¢y tr·ªìng r·ªìi.", "error");
                  console.warn(`C·ªë g·∫Øng tr·ªìng tr√™n √¥ ${plotId} kh√¥ng tr·ªëng/b·ªã kh√≥a/kh√¥ng h·ª£p l·ªá.`);
                  closeModal('empty-plot-action-modal');
                  currentActionPlotId = null; return;
             }
             if (!checkHasSeeds(true)) {
                 closeModal('empty-plot-action-modal');
                 currentActionPlotId = null; return;
             }
             currentPlantingPlotId = plotId; // L∆∞u ID √¥ ƒë·ªÉ tr·ªìng
             populateSeedSelection();
             openModal('seed-selection-modal');
             closeModal('empty-plot-action-modal'); // ƒê√≥ng modal h√†nh ƒë·ªông √¥ tr·ªëng
             currentActionPlotId = null; // Reset ID h√†nh ƒë·ªông
        }

        /** Ki·ªÉm tra xem ng∆∞·ªùi ch∆°i c√≥ h·∫°t gi·ªëng trong kho ƒê√É MUA kh√¥ng. */
        function checkHasSeeds(showMsgIfEmpty = true) {
            let hasSeeds = Object.keys(gameState.inventory).some(itemId => {
                const item = ITEM_DATA[itemId];
                return item && item.type === 'seed' && gameState.inventory[itemId] > 0;
            });
             if (!hasSeeds && showMsgIfEmpty) {
                 showMessage("B·∫°n ch∆∞a c√≥ h·∫°t gi·ªëng n√†o (trong kho ƒë√£ mua)! H√£y gh√© qua c·ª≠a h√†ng.", "error");
                 switchShopTab('seeds');
                 openModal('shop-modal');
                 return false;
             }
             return hasSeeds;
        }


         /** H√†m chung ƒë·ªÉ mua v·∫≠t ph·∫©m, th√™m v√†o kho ƒê√É MUA (gameState.inventory). */
          function buyItem(itemId, quantity) {
             const item = ITEM_DATA[itemId];
             if (!item) {
                 showMessage("L·ªói: V·∫≠t ph·∫©m kh√¥ng t·ªìn t·∫°i!", "error");
                 console.error(`C·ªë g·∫Øng mua v·∫≠t ph·∫©m kh√¥ng t·ªìn t·∫°i: ${itemId}`);
                 return;
             }

             // --- Validate s·ªë l∆∞·ª£ng ---
             let validQuantity = parseInt(quantity);
             if (isNaN(validQuantity) || validQuantity < 1) {
                 console.warn(`S·ªë l∆∞·ª£ng mua kh√¥ng h·ª£p l·ªá (${quantity}) cho ${itemId}, ƒë·∫∑t l·∫°i th√†nh 1.`);
                 validQuantity = 1;
             }

             const maxBuyQuantity = 99; // Gi·ªõi h·∫°n mua t·ªëi ƒëa m·ªói l·∫ßn
             if (validQuantity > maxBuyQuantity) {
                 showMessage(`Ch·ªâ c√≥ th·ªÉ mua t·ªëi ƒëa ${maxBuyQuantity} "${item.name}" m·ªói l·∫ßn.`, "warning");
                 validQuantity = maxBuyQuantity;
                 // C·∫≠p nh·∫≠t l·∫°i input n·∫øu ƒëang ·ªü shop
                 if (shopModal.style.display === 'block') {
                      let listContainer = item.type === 'seed' ? shopSeedList : shopToolList;
                      const inputEl = listContainer?.querySelector(`#qty-${itemId}`);
                      if(inputEl) inputEl.value = maxBuyQuantity;
                 }
             }

             // --- T√≠nh to√°n v√† ki·ªÉm tra chi ph√≠ ---
             const totalCost = item.price * validQuantity;
             if (gameState.currency < totalCost) {
                 showMessage(`Kh√¥ng ƒë·ªß ti·ªÅn! C·∫ßn ${totalCost}üí∞, b·∫°n ch·ªâ c√≥ ${gameState.currency}üí∞.`, "error");
                 // C·∫≠p nh·∫≠t l·∫°i n√∫t mua cho v·∫≠t ph·∫©m n√†y n·∫øu ƒëang ·ªü shop
                  if (shopModal.style.display === 'block') {
                      let listContainer = item.type === 'seed' ? shopSeedList : shopToolList;
                      const cardEl = listContainer?.querySelector(`.item-card[data-item-id="${itemId}"]`);
                      if(cardEl) updateSeedTotalCost(itemId, cardEl); // H√†m n√†y t·ª± disable n√∫t n·∫øu thi·∫øu ti·ªÅn
                  }
                 return;
             }

             // --- Th·ª±c hi·ªán mua ---
             gameState.currency -= totalCost;
             gameState.inventory[itemId] = (gameState.inventory[itemId] || 0) + validQuantity;

             // C·∫≠p nh·∫≠t UI v√† c√°c modal li√™n quan
             renderUI();
             updateShopButtons(); // Quan tr·ªçng: C·∫≠p nh·∫≠t T·∫§T C·∫¢ n√∫t mua sau khi ti·ªÅn thay ƒë·ªïi
             if (inventoryModal.style.display === 'block') renderInventory();
             if (seedSelectionModal.style.display === 'block' && item.type === 'seed') populateSeedSelection();
             if (fertilizerSelectionModal.style.display === 'block' && item.type === 'tool' && typeof item.fertilityBoost === 'number') populateFertilizerSelection();
             // C·∫≠p nh·∫≠t c√°c n√∫t trong modal h√†nh ƒë·ªông n·∫øu ƒëang m·ªü
             if (plantActionModal.style.display === 'block' && currentActionPlotId !== null) updatePlantActionModalButtons(currentActionPlotId);
             if (emptyPlotActionModal.style.display === 'block' && currentActionPlotId !== null) updateEmptyPlotActionModal(currentActionPlotId);

             showMessage(`ƒê√£ mua th√†nh c√¥ng ${validQuantity} ${item.name}! Th√™m v√†o kho "ƒê√£ Mua".`, "success");
             saveGame(); // L∆∞u game sau khi mua

             // <<< TH√äM LOG ACTION >>>
             logAction('buy_item', null, `ƒê√£ mua ${validQuantity} ${item.name} (-${totalCost}üí∞).`, 'üõí', itemId);
             // <<< K·∫æT TH√öC LOG ACTION >>>

             // Reset √¥ nh·∫≠p s·ªë l∆∞·ª£ng v·ªÅ 1 trong c·ª≠a h√†ng sau khi mua
             if (shopModal.style.display === 'block') {
                 let listContainer = item.type === 'seed' ? shopSeedList : shopToolList;
                 const itemCard = listContainer?.querySelector(`.item-card[data-item-id="${itemId}"]`);
                 if (itemCard) {
                     const quantityInput = itemCard.querySelector(`#qty-${itemId}`);
                     if (quantityInput) {
                         quantityInput.value = 1; // Reset v·ªÅ 1
                     }
                     // G·ªçi l·∫°i updateSeedTotalCost ƒë·ªÉ c·∫≠p nh·∫≠t hi·ªÉn th·ªã t·ªïng ti·ªÅn v√† tr·∫°ng th√°i n√∫t
                     updateSeedTotalCost(itemId, itemCard);
                 }
             }
         } // --- K·∫øt th√∫c h√†m buyItem ---

        /** Tr·ªìng m·ªôt h·∫°t gi·ªëng c·ª• th·ªÉ t·ª´ kho ƒê√É MUA. */
                /** Tr·ªìng m·ªôt h·∫°t gi·ªëng c·ª• th·ªÉ t·ª´ kho ƒê√É MUA. */
        function plantSeed(plotId, seedId) {
            if (plotId === null || plotId >= gameState.maxUnlockedPlots || !gameState.plots[plotId] || gameState.plots[plotId].seedId) {
                showMessage("√î ƒë·∫•t kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ c√≥ c√¢y.", "error");
                console.warn(`C·ªë g·∫Øng tr·ªìng tr√™n √¥ ${plotId} kh√¥ng tr·ªëng/b·ªã kh√≥a/kh√¥ng h·ª£p l·ªá.`);
                // ƒê√≥ng modal ch·ªçn h·∫°t gi·ªëng n·∫øu ƒëang m·ªü v√† c√≥ l·ªói
                if (seedSelectionModal.style.display === 'block') closeModal('seed-selection-modal');
                currentPlantingPlotId = null; // Reset ID ƒëang tr·ªìng
                return;
            }
            const plot = gameState.plots[plotId];
            const seed = ITEM_DATA[seedId];

            if (!seed || seed.type !== 'seed' || (gameState.inventory[seedId] || 0) <= 0) {
                 showMessage("H·∫°t gi·ªëng kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt (trong kho ƒë√£ mua).", "error");
                 if (seedSelectionModal.style.display === 'block') populateSeedSelection(); // C·∫≠p nh·∫≠t l·∫°i modal n·∫øu c√≤n m·ªü
                 currentPlantingPlotId = null; // Reset ID ƒëang tr·ªìng
                 return;
            }

            // --- Th·ª±c hi·ªán tr·ªìng ---
            gameState.inventory[seedId]--; // Tr·ª´ h·∫°t gi·ªëng kh·ªèi kho ƒë√£ mua
            plot.seedId = seedId;
            plot.plantTime = Date.now();
            plot.hasPest = false;
            plot.health = INITIAL_PLANT_HEALTH;
            plot.causeOfDeath = null;
            plot.pestDeathClickCount = 0;
            // plot.fertility v√† plot.barrenHarvestPenaltyFactor gi·ªØ nguy√™n t·ª´ tr·∫°ng th√°i √¥ ƒë·∫•t tr·ªëng tr∆∞·ªõc ƒë√≥

            renderGarden(); // V·∫Ω l·∫°i ƒë·ªÉ hi·ªán c√¢y v√† thanh m√°u
            saveGame(); // L∆∞u tr·∫°ng th√°i game
            if (inventoryModal.style.display === 'block') renderInventory(); // C·∫≠p nh·∫≠t kho ƒë·ªì n·∫øu ƒëang m·ªü

            let plantMessage = `ƒê√£ gieo h·∫°t ${seed.name} v√†o √¥ ${plotId + 1}!`;
            const currentFertility = plot.fertility;
            const isBarren = currentFertility <= 0;
            const currentPenalty = plot.barrenHarvestPenaltyFactor || 1.0;

            // C·∫£nh b√°o n·∫øu tr·ªìng tr√™n ƒë·∫•t c·∫±n
            if (isBarren && currentPenalty > 1.0) {
                 plantMessage += `\nC·∫¢NH B√ÅO: ƒê·∫•t C·∫∞N KI·ªÜT! Th·ªùi gian m·ªçc s·∫Ω b·ªã NH√ÇN L√äN x${currentPenalty.toFixed(2)}!`;
            } else if (isBarren) {
                 plantMessage += `\nC·∫¢NH B√ÅO: ƒê·∫•t C·∫∞N KI·ªÜT! Th·ªùi gian m·ªçc c√≥ th·ªÉ b·ªã ·∫£nh h∆∞·ªüng.`;
            } else if (currentFertility < LOW_FERTILITY_THRESHOLD) {
                 plantMessage += ` (Ch√∫ √Ω: ƒê·∫•t kh√° c·∫±n [${Math.round(currentFertility)}%], c√¢n nh·∫Øc b√≥n ph√¢n!)`;
            }

            showMessage(plantMessage, isBarren ? "error" : (currentFertility < LOW_FERTILITY_THRESHOLD ? "warning" : "success"), plantMessage.includes('\n') ? MESSAGE_DISPLAY_TIME + 1500 : MESSAGE_DISPLAY_TIME);

            // <<< TH√äM LOG ACTION >>>
            logAction('plant', plotId, `ƒê√£ gieo h·∫°t ${seed.name}.`, 'üå±', seedId);
            // <<< K·∫æT TH√öC LOG ACTION >>>

            currentPlantingPlotId = null; // Reset ID ƒëang tr·ªìng sau khi ho√†n t·∫•t
        }

        /** T√≠nh to√°n chi ph√≠ ƒë·ªÉ m·ªü kh√≥a √¥ ƒë·∫•t ti·∫øp theo */
        function calculatePlotCost(targetPlotIndex) {
             const unlockedCount = gameState.maxUnlockedPlots;
             // S·ªë √¥ ƒë√£ mua = s·ªë √¥ ƒë√£ m·ªü kh√≥a - s·ªë √¥ ban ƒë·∫ßu (t·ªëi thi·ªÉu l√† 0)
             const plotsBought = Math.max(0, unlockedCount - INITIAL_PLOT_COUNT);
             // Gi√° = gi√° g·ªëc * h·ªá s·ªë m≈© (s·ªë √¥ ƒë√£ mua)
             const cost = BASE_PLOT_COST * Math.pow(PLOT_COST_MULTIPLIER, plotsBought);
             return Math.floor(cost); // L√†m tr√≤n xu·ªëng
         }

        /** X·ª≠ l√Ω click v√†o √¥ ƒë·∫•t b·ªã kh√≥a -> Th·ª≠ mua √¥ ƒë·∫•t m·ªõi */
        function handleLockedPlotClick(plotId) {
        // Ch·ªâ cho ph√©p mua √¥ ti·∫øp theo li·ªÅn k·ªÅ
        if (plotId !== gameState.maxUnlockedPlots) {
            showMessage(`M·ªü kh√≥a √¥ ${gameState.maxUnlockedPlots + 1} tr∆∞·ªõc!`, "warning");
            return;
        }
        const cost = calculatePlotCost(plotId);
        const hasEnoughMoney = gameState.currency >= cost;

        // C·∫≠p nh·∫≠t n·ªôi dung v√† tr·∫°ng th√°i popup
        lockedPlotMessage.innerHTML = `M·ªü kh√≥a √¥ ƒë·∫•t s·ªë ${plotId + 1} v·ªõi gi√° <strong>${cost}üí∞</strong>? <br>(B·∫°n ƒëang c√≥: ${gameState.currency}üí∞)`; // D√πng innerHTML ƒë·ªÉ nh·∫≠n th·∫ª strong
        confirmBuyPlotBtn.disabled = !hasEnoughMoney;
        confirmBuyPlotBtn.title = hasEnoughMoney ? `Chi ${cost}üí∞ ƒë·ªÉ m·ªü kh√≥a` : `Kh√¥ng ƒë·ªß ti·ªÅn (C·∫ßn ${cost}üí∞)`;

        // L∆∞u th√¥ng tin c·∫ßn thi·∫øt v√†o n√∫t Mua ƒë·ªÉ x·ª≠ l√Ω sau
        confirmBuyPlotBtn.dataset.plotId = plotId;
        confirmBuyPlotBtn.dataset.cost = cost;

        // Hi·ªÉn th·ªã popup
        openLockedPlotPopup(); // S·ª≠ d·ª•ng h√†m tr·ª£ gi√∫p m·ªõi (s·∫Ω ƒë·ªãnh nghƒ©a ·ªü d∆∞·ªõi)
    }

        /** X·ª≠ l√Ω click v√†o n√∫t B√°n ho·∫∑c input s·ªë l∆∞·ª£ng trong tab ƒê√£ Thu Ho·∫°ch */
        function handleSellHarvestedClick(event) {
            const sellButton = event.target.closest('.sell-selected-button');
            const sellAllButton = event.target.closest('.sell-all-button');
            const quantityInput = event.target;

            if (sellButton) { // X·ª≠ l√Ω n√∫t "B√°n" (s·ªë l∆∞·ª£ng ƒë√£ ch·ªçn)
                const itemCard = sellButton.closest('.item-card');
                if (!itemCard) return;
                const itemId = itemCard.dataset.itemId;
                const inputElement = itemCard.querySelector(`#sell-qty-${itemId}`);
                if (!inputElement || !itemId) return;

                const currentMax = parseInt(inputElement.max);
                let quantityToSell = parseInt(inputElement.value);

                if (isNaN(quantityToSell) || quantityToSell < 1) {
                    showMessage("S·ªë l∆∞·ª£ng b√°n kh√¥ng h·ª£p l·ªá.", "warning");
                    inputElement.value = 1;
                    return;
                }
                if (quantityToSell > currentMax) {
                    showMessage(`B·∫°n ch·ªâ c√≥ ${currentMax} ƒë·ªÉ b√°n.`, "warning");
                    inputElement.value = currentMax;
                    quantityToSell = currentMax;
                }
                sellHarvestedItem(itemId, quantityToSell); // B√°n ngay s·ªë l∆∞·ª£ng ƒë√£ ch·ªçn

            } else if (sellAllButton) { // [C·∫¨P NH·∫¨T] X·ª≠ l√Ω n√∫t "B√°n H·∫øt" -> M·ªü x√°c nh·∫≠n
                const itemCard = sellAllButton.closest('.item-card');
                if (!itemCard) return;
                const itemId = itemCard.dataset.itemId;
                const item = ITEM_DATA[itemId];
                if (!item || !itemId) return;

                const quantityToSellAll = gameState.harvestedItems[itemId] || 0;

                if (quantityToSellAll <= 0) {
                    showMessage("Kh√¥ng c√≥ g√¨ ƒë·ªÉ b√°n h·∫øt.", "warning");
                    return;
                }

                const totalEarnings = quantityToSellAll * (item.harvestYield || 0);
                const itemName = item.name;

                // M·ªü h·ªôp tho·∫°i x√°c nh·∫≠n thay v√¨ b√°n ngay
                openConfirmSellAllModal(itemId, itemName, quantityToSellAll, totalEarnings);

            } else if (quantityInput && quantityInput.classList.contains('sell-quantity-input')) {
                // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng thay ƒë·ªïi input (logic c≈© gi·ªØ nguy√™n)
                const currentMax = parseInt(quantityInput.max);
                let currentValue = parseInt(quantityInput.value);
                const rawValue = quantityInput.value;

                if (rawValue === '' || isNaN(currentValue) || currentValue < 1) {
                     quantityInput.value = 1;
                }
                else if (currentValue > currentMax) {
                    quantityInput.value = currentMax;
                     showMessage(`B·∫°n ch·ªâ c√≥ ${currentMax} ƒë·ªÉ b√°n.`, "warning");
                }
            }
        }

        /** B√°n s·ªë l∆∞·ª£ng c·ª• th·ªÉ v·∫≠t ph·∫©m t·ª´ kho ƒê√£ Thu Ho·∫°ch */
         function sellHarvestedItem(itemId, quantityToSell) {
            const item = ITEM_DATA[itemId];
            const currentQuantity = gameState.harvestedItems[itemId] || 0;

            // --- Ki·ªÉm tra ƒëi·ªÅu ki·ªán b√°n ---
            if (!item || item.type !== 'seed') {
                showMessage("L·ªói: Kh√¥ng th·ªÉ b√°n v·∫≠t ph·∫©m kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng ph·∫£i l√† s·∫£n ph·∫©m thu ho·∫°ch.", "error");
                console.warn(`L·ªói khi b√°n: itemId=${itemId} kh√¥ng h·ª£p l·ªá.`);
                if (inventoryModal.style.display === 'block') renderInventory(); // V·∫Ω l·∫°i kho ƒë·ªÉ x√≥a item l·ªói n·∫øu c√≥
                return;
            }
            if (currentQuantity <= 0) {
                 showMessage(`B·∫°n kh√¥ng c√≤n ${item.name} ƒë·ªÉ b√°n.`, "error");
                 console.warn(`C·ªë g·∫Øng b√°n ${itemId} nh∆∞ng s·ªë l∆∞·ª£ng l√† 0.`);
                 if (inventoryModal.style.display === 'block') renderInventory();
                 return;
            }

            // --- Validate s·ªë l∆∞·ª£ng b√°n ---
            const actualSellQuantity = parseInt(quantityToSell);
            if (isNaN(actualSellQuantity) || actualSellQuantity <= 0) {
                showMessage("S·ªë l∆∞·ª£ng b√°n kh√¥ng h·ª£p l·ªá (ph·∫£i l√† s·ªë d∆∞∆°ng).", "error");
                 if(inventoryModal.style.display === 'block') { // Reset input n·∫øu ƒëang m·ªü kho
                    const inputElement = inventoryHarvestedList.querySelector(`#sell-qty-${itemId}`);
                    if(inputElement) inputElement.value = 1;
                 }
                return;
            }
            if (actualSellQuantity > currentQuantity) {
                showMessage(`S·ªë l∆∞·ª£ng b√°n (${actualSellQuantity}) v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng b·∫°n c√≥ (${currentQuantity}).`, "error");
                console.warn(`S·ªë l∆∞·ª£ng b√°n kh√¥ng h·ª£p l·ªá: ${quantityToSell} cho item ${itemId} (c√≥ ${currentQuantity})`);
                 if(inventoryModal.style.display === 'block') { // Reset input v·ªÅ max n·∫øu ƒëang m·ªü kho
                    const inputElement = inventoryHarvestedList.querySelector(`#sell-qty-${itemId}`);
                    if(inputElement) inputElement.value = currentQuantity;
                 }
                return;
            }

            // --- Th·ª±c hi·ªán b√°n ---
            const earnings = actualSellQuantity * (item.harvestYield || 0);
            gameState.harvestedItems[itemId] -= actualSellQuantity; // Tr·ª´ kh·ªèi kho
            gameState.currency += earnings; // C·ªông ti·ªÅn

            // X√≥a kh·ªèi kho n·∫øu s·ªë l∆∞·ª£ng v·ªÅ 0
            if (gameState.harvestedItems[itemId] <= 0) {
                delete gameState.harvestedItems[itemId];
            }

            // C·∫≠p nh·∫≠t UI v√† L∆∞u game
            renderUI();
            updateShopButtons(); // C·∫≠p nh·∫≠t n√∫t shop v√¨ ti·ªÅn thay ƒë·ªïi
            renderInventory(); // Quan tr·ªçng: C·∫≠p nh·∫≠t l·∫°i kho ƒë·ªì ngay l·∫≠p t·ª©c
            saveGame();

            // Hi·ªÉn th·ªã th√¥ng b√°o
            showMessage(`ƒê√£ b√°n ${actualSellQuantity} ${item.name}! +${earnings}üí∞`, "success");

            // <<< TH√äM LOG ACTION >>>
            // L∆∞u √Ω: B√°n t·ª´ kho n√™n plotId l√† null
            logAction('sell_harvested', null, `ƒê√£ b√°n ${actualSellQuantity} ${item.name} t·ª´ kho (+${earnings}üí∞).`, 'üí∞', itemId);
            // <<< K·∫æT TH√öC LOG ACTION >>>
        }


        // --- C√°c H√†m Ti·ªán √çch & Tr·ª£ Gi√∫p ---
		    /** M·ªü popup x√°c nh·∫≠n mua √¥ ƒë·∫•t b·ªã kh√≥a */
    function openLockedPlotPopup() {
        if (lockedPlotPopup) {
            lockedPlotPopup.style.display = 'flex'; // D√πng flex ƒë·ªÉ cƒÉn gi·ªØa theo CSS
            // T·ª± ƒë·ªông focus n√∫t h·ªßy ho·∫∑c n√∫t mua (n·∫øu enable)
            const focusTarget = confirmBuyPlotBtn.disabled ? cancelBuyPlotBtn : confirmBuyPlotBtn;
            setTimeout(() => focusTarget?.focus(), 50); // Delay nh·ªè
        }
    }

    /** ƒê√≥ng popup x√°c nh·∫≠n mua √¥ ƒë·∫•t b·ªã kh√≥a */
    function closeLockedPlotPopup() {
        if (lockedPlotPopup) {
            lockedPlotPopup.style.display = 'none';
             // X√≥a data c≈© ph√≤ng tr∆∞·ªùng h·ª£p l·ªói
             if (confirmBuyPlotBtn) {
                 delete confirmBuyPlotBtn.dataset.plotId;
                 delete confirmBuyPlotBtn.dataset.cost;
             }
        }
    }

    /** X·ª≠ l√Ω khi nh·∫•n n√∫t Mua trong popup √¥ ƒë·∫•t b·ªã kh√≥a */
    function handleConfirmBuyPlot() {
            // L·∫•y th√¥ng tin t·ª´ dataset c·ªßa n√∫t x√°c nh·∫≠n
            const plotIdString = confirmBuyPlotBtn.dataset.plotId;
            const costString = confirmBuyPlotBtn.dataset.cost;

            // Ki·ªÉm tra xem dataset c√≥ t·ªìn t·∫°i v√† h·ª£p l·ªá kh√¥ng
            if (plotIdString === undefined || costString === undefined) {
                 console.error("L·ªói: Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu plotId ho·∫∑c cost tr√™n n√∫t x√°c nh·∫≠n.");
                 showMessage("L·ªói! Kh√¥ng th·ªÉ x·ª≠ l√Ω y√™u c·∫ßu mua √¥ ƒë·∫•t.", "error");
                 closeLockedPlotPopup();
                 return;
            }

            const plotId = parseInt(plotIdString);
            const cost = parseInt(costString);

            // Ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa plotId v√† cost
            if (isNaN(plotId) || isNaN(cost) || plotId < 0 || cost <= 0) {
                 console.error(`L·ªói d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá: plotId=${plotId}, cost=${cost}`);
                 showMessage("L·ªói! D·ªØ li·ªáu mua √¥ ƒë·∫•t kh√¥ng h·ª£p l·ªá.", "error");
                 closeLockedPlotPopup();
                 return;
            }

            // Ki·ªÉm tra xem c√≥ ƒë√∫ng l√† mua √¥ ti·∫øp theo kh√¥ng
            if (plotId !== gameState.maxUnlockedPlots) {
                console.error(`L·ªói logic: ƒêang c·ªë mua √¥ ${plotId} nh∆∞ng √¥ ti·∫øp theo ph·∫£i l√† ${gameState.maxUnlockedPlots}`);
                showMessage(`L·ªói! Ch·ªâ c√≥ th·ªÉ m·ªü kh√≥a √¥ s·ªë ${gameState.maxUnlockedPlots + 1} ti·∫øp theo.`, "error");
                closeLockedPlotPopup();
                return;
            }

            // Ki·ªÉm tra ti·ªÅn
            if (gameState.currency >= cost) {
                // --- Th·ª±c hi·ªán mua ---
                gameState.currency -= cost;
                gameState.maxUnlockedPlots++;
                initializePlotsData(); // Quan tr·ªçng: Kh·ªüi t·∫°o d·ªØ li·ªáu cho √¥ m·ªõi m·ªü kh√≥a
                renderUI();           // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ti·ªÅn v√† s·ªë √¥
                renderGarden();       // V·∫Ω l·∫°i v∆∞·ªùn v·ªõi √¥ m·ªõi
                updateShopButtons(); // C·∫≠p nh·∫≠t n√∫t shop v√¨ ti·ªÅn thay ƒë·ªïi
                showMessage(`Ch√∫c m·ª´ng! ƒê√£ m·ªü kh√≥a √¥ ƒë·∫•t s·ªë ${plotId + 1}!`, "success");
                saveGame(); // L∆∞u game sau khi mua th√†nh c√¥ng

                // <<< TH√äM LOG ACTION >>>
                logAction('buy_plot', plotId, `ƒê√£ m·ªü kh√≥a √¥ ƒë·∫•t ${plotId + 1} (-${cost}üí∞).`, 'üèûÔ∏è', null);
                // <<< K·∫æT TH√öC LOG ACTION >>>

            } else {
                // Th√¥ng b√°o kh√¥ng ƒë·ªß ti·ªÅn (ki·ªÉm tra l·∫°i l·∫ßn n·ªØa)
                showMessage(`Kh√¥ng ƒë·ªß ti·ªÅn! C·∫ßn ${cost}üí∞, b·∫°n ch·ªâ c√≥ ${gameState.currency}üí∞.`, "error");
            }
            closeLockedPlotPopup(); // Lu√¥n ƒë√≥ng popup sau khi x·ª≠ l√Ω
        }
	function handleEscapeKey(event) {
            if (event.key === 'Escape') {
                // ∆Øu ti√™n ƒë√≥ng c√°c popup/modal c·ª• th·ªÉ tr∆∞·ªõc
                if (confirmSellAllModal && confirmSellAllModal.style.display !== 'none') {
                     closeConfirmSellAllModal();
                }
                else if (menuPopup && menuPopup.style.display !== 'none') {
                    closeMenuPopup();
                }
                else if (lockedPlotPopup && lockedPlotPopup.style.display !== 'none') {
                    closeLockedPlotPopup();
                }
                // Cu·ªëi c√πng l√† c√°c modal kh√°c
                else {
                    closeAllModals(); // H√†m n√†y ƒë√≥ng t·∫•t c·∫£ c√°c modal c√≥ class .modal
                }
            }
        }

    // --- C·∫≠p nh·∫≠t Listener click n·ªÅn ---
     /** X·ª≠ l√Ω click b√™n ngo√†i n·ªôi dung modal/popup ƒë·ªÉ ƒë√≥ng */
    function handleModalBackgroundClick(event) {
        // ƒê√≥ng popup menu n·∫øu click n·ªÅn c·ªßa n√≥
        if (event.target === menuPopup) {
            closeMenuPopup();
        }
        // ƒê√≥ng popup √¥ kh√≥a n·∫øu click n·ªÅn c·ªßa n√≥
        else if (event.target === lockedPlotPopup) {
            closeLockedPlotPopup();
        }
        // ƒê√≥ng c√°c modal kh√°c n·∫øu click n·ªÅn c·ªßa ch√∫ng (class .modal nh∆∞ng kh√¥ng ph·∫£i 2 popup tr√™n)
        else if (event.target.classList.contains('modal') && event.target !== menuPopup && event.target !== lockedPlotPopup) {
            const modalId = event.target.id;
            closeModal(modalId); // D√πng h√†m closeModal g·ªëc
            // Reset ID n·∫øu c·∫ßn khi ƒë√≥ng b·∫±ng click n·ªÅn
            if (modalId === 'seed-selection-modal') currentPlantingPlotId = null;
            if (modalId === 'fertilizer-selection-modal' || modalId === 'plant-action-modal' || modalId === 'empty-plot-action-modal') currentActionPlotId = null;
        }
    }
		
		
		
		
		
        // ==================================

        /** L∆∞u tr·∫°ng th√°i game hi·ªán t·∫°i v√†o localStorage. */
         function saveGame() {
    try {
         const now = Date.now();
         // T√≠nh v√† c·ªông d·ªìn th·ªùi gian ch∆°i k·ªÉ t·ª´ l·∫ßn c·∫≠p nh·∫≠t cu·ªëi
         if(gameState.lastUpdateTimestamp && now > gameState.lastUpdateTimestamp) {
             if (tickCounter > 0 || gameState.totalPlayTime === 0) { // ƒê·∫£m b·∫£o kh√¥ng c·ªông d·ªìn n·∫øu game v·ª´a load
                 gameState.totalPlayTime += (now - gameState.lastUpdateTimestamp);
             }
         }
         // C·∫≠p nh·∫≠t timestamp cu·ªëi c√πng *tr∆∞·ªõc* khi l∆∞u
         gameState.lastUpdateTimestamp = now;

         // === Validate c·∫•u tr√∫c gameState c∆° b·∫£n (gi·ªØ nguy√™n) ===
         if (!gameState || typeof gameState !== 'object' || !Array.isArray(gameState.plots)) throw new Error("C·∫•u tr√∫c gameState c∆° b·∫£n kh√¥ng h·ª£p l·ªá.");
         if (typeof gameState.currency !== 'number' || gameState.currency < 0) throw new Error("Gi√° tr·ªã ti·ªÅn t·ªá kh√¥ng h·ª£p l·ªá.");
         if (typeof gameState.maxUnlockedPlots !== 'number' || gameState.maxUnlockedPlots < INITIAL_PLOT_COUNT) throw new Error(`S·ªë √¥ m·ªü kh√≥a (${gameState.maxUnlockedPlots}) kh√¥ng h·ª£p l·ªá.`);
         if (typeof gameState.inventory !== 'object' || gameState.inventory === null) throw new Error("C·∫•u tr√∫c inventory kh√¥ng h·ª£p l·ªá.");
         if (typeof gameState.harvestedItems !== 'object' || gameState.harvestedItems === null) throw new Error("C·∫•u tr√∫c harvestedItems kh√¥ng h·ª£p l·ªá.");
         if (!Array.isArray(gameState.actionHistory)) throw new Error("C·∫•u tr√∫c actionHistory kh√¥ng h·ª£p l·ªá.");
         // Validate d·ªØ li·ªáu plot c∆° b·∫£n (gi·ªØ nguy√™n)
         for (let i = 0; i < gameState.plots.length; i++) { /* ... */ }

         // **[C·∫¨P NH·∫¨T] Validate tr·∫°ng th√°i th·ªùi ti·∫øt (ki·ªÉm tra object currentWeather)**
         let isValidWeather = false;
         if (typeof gameState.currentWeather === 'object' && gameState.currentWeather !== null && gameState.currentWeather.id) {
              // Ki·ªÉm tra xem ID c√≥ t·ªìn t·∫°i trong WEATHER_DATA kh√¥ng
              isValidWeather = WEATHER_DATA.some(data => data.id === gameState.currentWeather.id);
         }

         if (!isValidWeather) {
             console.warn("Tr·∫°ng th√°i th·ªùi ti·∫øt (gameState.currentWeather) kh√¥ng h·ª£p l·ªá khi l∆∞u, ƒë·∫∑t l·∫°i v·ªÅ m·∫∑c ƒë·ªãnh.");
             // ƒê·∫∑t l·∫°i v·ªÅ tr·∫°ng th√°i m·∫∑c ƒë·ªãnh (v√≠ d·ª•: n·∫Øng) ƒë·ªÉ tr√°nh l·ªói nghi√™m tr·ªçng
             gameState.currentWeather = WEATHER_DATA[0];
             // Kh√¥ng n√™n throw error ·ªü ƒë√¢y ƒë·ªÉ game v·∫´n c√≥ th·ªÉ l∆∞u c√°c ph·∫ßn kh√°c
         }

         // Validation cho timestamps th·ªùi ti·∫øt (gi·ªØ nguy√™n logic)
         if (typeof gameState.nextWeatherChangeTimestamp !== 'number' || gameState.nextWeatherChangeTimestamp <= 0) {
              console.warn("Timestamp ƒë·ªïi th·ªùi ti·∫øt kh√¥ng h·ª£p l·ªá khi l∆∞u.");
              // C·ªë g·∫Øng s·ª≠a l·ªói b·∫±ng c√°ch t√≠nh l·∫°i d·ª±a tr√™n th·ªùi gian hi·ªán t·∫°i
              gameState.nextWeatherChangeTimestamp = now + WEATHER_CHANGE_INTERVAL_MS;
         }
         if (typeof gameState.currentWeatherStartTime !== 'number' || gameState.currentWeatherStartTime <= 0 || gameState.currentWeatherStartTime > gameState.nextWeatherChangeTimestamp) {
             console.warn("Timestamp b·∫Øt ƒë·∫ßu th·ªùi ti·∫øt kh√¥ng h·ª£p l·ªá khi l∆∞u.");
             // T√≠nh l·∫°i d·ª±a tr√™n next timestamp ƒë√£ ƒë∆∞·ª£c validate/s·ª≠a l·ªói
             gameState.currentWeatherStartTime = gameState.nextWeatherChangeTimestamp - WEATHER_CHANGE_INTERVAL_MS;
              // D·ª± ph√≤ng n·∫øu nextWeatherChangeTimestamp qu√° c≈©
              if(gameState.currentWeatherStartTime <= 0) gameState.currentWeatherStartTime = now;
         }
         // ===========================================

        // Chuy·ªÉn ƒë·ªïi to√†n b·ªô gameState (ƒë√£ bao g·ªìm currentWeather l√† object) th√†nh chu·ªói JSON
        const saveData = JSON.stringify(gameState);

        // L∆∞u v√†o localStorage
        localStorage.setItem(GAME_SAVE_KEY, saveData);

        // L∆∞u l·ªãch s·ª≠ h√†nh ƒë·ªông (v·∫´n gi·ªØ ri√™ng bi·ªát) - Logic kh√¥ng ƒë·ªïi
        try {
            const historyData = JSON.stringify(gameState.actionHistory);
            localStorage.setItem(HISTORY_SAVE_KEY, historyData);
        } catch (historyError) { /* ... */ }

        // console.log("Tr·∫°ng th√°i game (bao g·ªìm th·ªùi ti·∫øt object) ƒë√£ l∆∞u."); // B·∫≠t n·∫øu c·∫ßn debug

    } catch (error) {
        // X·ª≠ l√Ω l·ªói nghi√™m tr·ªçng trong qu√° tr√¨nh chu·∫©n b·ªã ho·∫∑c l∆∞u d·ªØ li·ªáu
        console.error("L·ªói nghi√™m tr·ªçng khi l∆∞u game:", error);
        showMessage("L·ªói: Kh√¥ng th·ªÉ l∆∞u game! D·ªØ li·ªáu c√≥ th·ªÉ kh√¥ng h·ª£p l·ªá.", "error", MESSAGE_DISPLAY_TIME * 1.5);
    }
}


        /** T·∫£i tr·∫°ng th√°i game t·ª´ localStorage v√† th·ª±c hi·ªán m√¥ ph·ªèng offline n·∫øu c·∫ßn. */
          function loadGame() {
            console.log(`ƒêang c·ªë t·∫£i tr·∫°ng th√°i game t·ª´ kh√≥a: ${GAME_SAVE_KEY}`);
            let loadedState = null;
            const nowForLoad = Date.now(); // L∆∞u th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu load

            // --- Tr·∫°ng th√°i m·∫∑c ƒë·ªãnh ƒë·∫ßy ƒë·ªß, bao g·ªìm isDry v√† nextDryCheckTimestamp ---
            const defaultPlotStateForLoad = { // Tr·∫°ng th√°i plot m·∫∑c ƒë·ªãnh ri√™ng cho load
                seedId: null, plantTime: null, hasPest: false,
                health: INITIAL_PLANT_HEALTH, fertility: BASE_FERTILITY,
                causeOfDeath: null, pestDeathClickCount: 0,
                barrenHarvestPenaltyFactor: 1.0, isDry: false // Bao g·ªìm isDry
            };
            const defaultState = {
                currency: INITIAL_CURRENCY,
                plots: [], // S·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·ªüi initializePlotsData sau
                maxUnlockedPlots: INITIAL_PLOT_COUNT,
                inventory: { pesticide: INITIAL_PESTICIDE },
                harvestedItems: {},
                lastUpdateTimestamp: nowForLoad, // M·∫∑c ƒë·ªãnh l√† b√¢y gi·ªù
                gameStartTime: nowForLoad,       // M·∫∑c ƒë·ªãnh l√† b√¢y gi·ªù
                totalPlayTime: 0,
                actionHistory: [],
                currentWeather: WEATHER_DATA[0], // D√πng object ƒë·∫ßu ti√™n l√†m m·∫∑c ƒë·ªãnh
                nextWeatherChangeTimestamp: nowForLoad + WEATHER_CHANGE_INTERVAL_MS,
                currentWeatherStartTime: nowForLoad,
                nextDryCheckTimestamp: nowForLoad + (15 + Math.random() * 30) * 1000 // L√™n l·ªãch check kh√¥ h·∫°n ƒë·∫ßu ti√™n
            };

            try {
                const savedDataString = localStorage.getItem(GAME_SAVE_KEY);
                if (savedDataString) {
                    loadedState = JSON.parse(savedDataString);
                    console.log("ƒê√£ t√¨m th·∫•y v√† ph√¢n t√≠ch d·ªØ li·ªáu game ƒë√£ l∆∞u.");

                    // --- H·ª£p nh·∫•t tr·∫°ng th√°i game c∆° b·∫£n ---
                    gameState.currency = (typeof loadedState.currency === 'number' && loadedState.currency >= 0) ? loadedState.currency : defaultState.currency;
                    gameState.maxUnlockedPlots = (typeof loadedState.maxUnlockedPlots === 'number' && loadedState.maxUnlockedPlots >= INITIAL_PLOT_COUNT) ? loadedState.maxUnlockedPlots : defaultState.maxUnlockedPlots;
                    // Quan tr·ªçng: lastUpdateTimestamp v√† gameStartTime c·∫ßn ƒë∆∞·ª£c t·∫£i tr∆∞·ªõc khi t√≠nh offline
                    gameState.lastUpdateTimestamp = (typeof loadedState.lastUpdateTimestamp === 'number' && loadedState.lastUpdateTimestamp > 0) ? loadedState.lastUpdateTimestamp : defaultState.lastUpdateTimestamp;
                    gameState.gameStartTime = (typeof loadedState.gameStartTime === 'number' && loadedState.gameStartTime > 0) ? loadedState.gameStartTime : defaultState.gameStartTime;
                    gameState.totalPlayTime = (typeof loadedState.totalPlayTime === 'number' && loadedState.totalPlayTime >=0) ? loadedState.totalPlayTime : defaultState.totalPlayTime;

                    // T·∫£i inventory (ƒë·∫£m b·∫£o thu·ªëc tr·ª´ s√¢u v√† s·ªë l∆∞·ª£ng h·ª£p l·ªá)
                    const loadedInventory = (typeof loadedState.inventory === 'object' && loadedState.inventory !== null) ? loadedState.inventory : {};
                    gameState.inventory = {}; // Reset tr∆∞·ªõc khi g√°n
                    gameState.inventory.pesticide = Math.max(0, parseInt(loadedInventory.pesticide) || 0);
                    for (const itemId in loadedInventory) {
                        if (itemId !== 'pesticide' && ITEM_DATA[itemId]) {
                            const quantity = parseInt(loadedInventory[itemId]);
                            if (!isNaN(quantity) && quantity > 0) {
                                gameState.inventory[itemId] = quantity;
                            }
                        }
                    }
                    if (Object.keys(loadedInventory).length === 0 && gameState.inventory.pesticide === 0) {
                        gameState.inventory.pesticide = INITIAL_PESTICIDE;
                    }

                    // T·∫£i harvestedItems (ch·ªâ h·∫°t gi·ªëng h·ª£p l·ªá)
                    const loadedHarvested = (typeof loadedState.harvestedItems === 'object' && loadedState.harvestedItems !== null) ? loadedState.harvestedItems : {};
                    gameState.harvestedItems = {}; // Reset tr∆∞·ªõc khi g√°n
                    for (const itemId in loadedHarvested) {
                        if (ITEM_DATA[itemId] && ITEM_DATA[itemId].type === 'seed') {
                            const quantity = parseInt(loadedHarvested[itemId]);
                            if (!isNaN(quantity) && quantity > 0) {
                                gameState.harvestedItems[itemId] = quantity;
                            }
                        }
                    }

                    // T·∫£i plots (s·∫Ω ƒë∆∞·ª£c validate th√™m trong initializePlotsData)
                    // ƒê·∫£m b·∫£o m·ªói plot t·∫£i v·ªÅ c√≥ ƒë·ªß c√°c tr∆∞·ªùng, bao g·ªìm c·∫£ isDry
                    const loadedPlots = Array.isArray(loadedState.plots) ? loadedState.plots : [];
                    gameState.plots = []; // Reset tr∆∞·ªõc khi g√°n
                    for (let i = 0; i < Math.min(loadedPlots.length, gameState.maxUnlockedPlots); i++) {
                        const savedPlot = loadedPlots[i] || {};
                        gameState.plots[i] = {
                            ...JSON.parse(JSON.stringify(defaultPlotStateForLoad)), // B·∫Øt ƒë·∫ßu v·ªõi m·∫∑c ƒë·ªãnh m·ªõi nh·∫•t
                            ...savedPlot, // Ghi ƒë√® b·∫±ng d·ªØ li·ªáu ƒë√£ t·∫£i
                            id: i, // ƒê·∫£m b·∫£o ID ƒë√∫ng
                            isDry: !!savedPlot.isDry // <<< ƒê·∫£m b·∫£o isDry l√† boolean khi t·∫£i >>>
                        };
                    }
                    // initializePlotsData s·∫Ω ch·∫°y sau v√† ho√†n thi·ªán/th√™m c√°c √¥ c√≤n thi·∫øu

                    // T·∫£i l·ªãch s·ª≠ h√†nh ƒë·ªông (t·ª´ localStorage ri√™ng)
                    const savedHistoryString = localStorage.getItem(HISTORY_SAVE_KEY);
                    if (savedHistoryString) {
                        try { gameState.actionHistory = JSON.parse(savedHistoryString); if (!Array.isArray(gameState.actionHistory)) throw new Error("History is not an array");}
                        catch (e) { console.warn("L·ªói parse l·ªãch s·ª≠ h√†nh ƒë·ªông, ƒë·∫∑t l·∫°i v·ªÅ r·ªóng.", e); gameState.actionHistory = []; }
                    } else {
                        console.log("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu l·ªãch s·ª≠ h√†nh ƒë·ªông.");
                        gameState.actionHistory = [];
                    }

                    // --- [C·∫¨P NH·∫¨T] T·∫£i ho·∫∑c Kh·ªüi t·∫°o Tr·∫°ng th√°i Th·ªùi Ti·∫øt (∆∞u ti√™n object) ---
                    let weatherSet = false;
                    if (typeof loadedState.currentWeather === 'object' && loadedState.currentWeather !== null && loadedState.currentWeather.id) {
                        const foundWeather = WEATHER_DATA.find(data => data.id === loadedState.currentWeather.id);
                        if (foundWeather) {
                            gameState.currentWeather = JSON.parse(JSON.stringify(foundWeather));
                            weatherSet = true;
                        } else { console.warn(`ID th·ªùi ti·∫øt '${loadedState.currentWeather.id}' t·ª´ save kh√¥ng t√¨m th·∫•y.`); }
                    }
                    if (!weatherSet && typeof loadedState.currentWeather === 'string') { // T∆∞∆°ng th√≠ch ng∆∞·ª£c ID string
                        const foundWeatherById = WEATHER_DATA.find(data => data.id === loadedState.currentWeather);
                        if (foundWeatherById) {
                            gameState.currentWeather = JSON.parse(JSON.stringify(foundWeatherById));
                            weatherSet = true;
                            console.warn("Ph√°t hi·ªán ƒë·ªãnh d·∫°ng th·ªùi ti·∫øt c≈© (ID string), ƒë√£ chuy·ªÉn ƒë·ªïi.");
                        }
                    }
                     if (!weatherSet && typeof loadedState.currentWeatherIcon === 'string') { // T∆∞∆°ng th√≠ch ng∆∞·ª£c Icon string
                         const foundWeatherByIcon = WEATHER_DATA.find(data => data.icon === loadedState.currentWeatherIcon);
                         if (foundWeatherByIcon) {
                             gameState.currentWeather = JSON.parse(JSON.stringify(foundWeatherByIcon));
                             weatherSet = true;
                             console.warn("Ph√°t hi·ªán ƒë·ªãnh d·∫°ng th·ªùi ti·∫øt c≈© (icon string), ƒë√£ chuy·ªÉn ƒë·ªïi.");
                         }
                     }
                    if (!weatherSet) {
                        console.warn("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt h·ª£p l·ªá trong save, s·ª≠ d·ª•ng m·∫∑c ƒë·ªãnh.");
                        gameState.currentWeather = defaultState.currentWeather;
                    }

                    // T·∫£i timestamps th·ªùi ti·∫øt v√† ƒëi·ªÅu ch·ªânh n·∫øu c·∫ßn
                    gameState.nextWeatherChangeTimestamp = (typeof loadedState.nextWeatherChangeTimestamp === 'number' && loadedState.nextWeatherChangeTimestamp > 0) ? loadedState.nextWeatherChangeTimestamp : defaultState.nextWeatherChangeTimestamp;
                    gameState.currentWeatherStartTime = gameState.nextWeatherChangeTimestamp - WEATHER_CHANGE_INTERVAL_MS;
                    if (gameState.currentWeatherStartTime <= 0 || gameState.currentWeatherStartTime > gameState.nextWeatherChangeTimestamp || gameState.currentWeatherStartTime < gameState.lastUpdateTimestamp - WEATHER_CHANGE_INTERVAL_MS * 2) {
                         console.warn("currentWeatherStartTime kh√¥ng h·ª£p l·ªá sau khi t·∫£i, ƒë·∫∑t l·∫°i d·ª±a tr√™n lastUpdateTimestamp.");
                         gameState.currentWeatherStartTime = gameState.lastUpdateTimestamp;
                    }
                     if(gameState.nextWeatherChangeTimestamp <= gameState.lastUpdateTimestamp){
                         console.warn("nextWeatherChangeTimestamp trong qu√° kh·ª© so v·ªõi lastUpdateTimestamp, ƒëang t√≠nh l·∫°i...");
                         const cyclesPassed = Math.floor((gameState.lastUpdateTimestamp - gameState.nextWeatherChangeTimestamp) / WEATHER_CHANGE_INTERVAL_MS) + 1;
                         gameState.nextWeatherChangeTimestamp += cyclesPassed * WEATHER_CHANGE_INTERVAL_MS;
                         // Vi·ªác thay ƒë·ªïi th·ªùi ti·∫øt do offline s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω trong simulateOfflineProgress
                     }


                    // --- [C·∫¨P NH·∫¨T] T·∫£i ho·∫∑c Kh·ªüi t·∫°o Timer Kh√¥ H·∫°n ---
                    gameState.nextDryCheckTimestamp = (typeof loadedState.nextDryCheckTimestamp === 'number' && loadedState.nextDryCheckTimestamp > gameState.lastUpdateTimestamp) // <<< Ki·ªÉm tra ph·∫£i > l·∫ßn l∆∞u cu·ªëi
                        ? loadedState.nextDryCheckTimestamp
                        : gameState.lastUpdateTimestamp + (15 + Math.random() * 30) * 1000; // L√™n l·ªãch l·∫°i t·ª´ lastUpdate n·∫øu kh√¥ng h·ª£p l·ªá
                    console.log(`Next dry check loaded/reset to: ${new Date(gameState.nextDryCheckTimestamp).toLocaleTimeString()}`);


                    // --- M√¥ ph·ªèng Ti·∫øn tr√¨nh Offline ---
                    // T√≠nh to√°n th·ªùi gian offline d·ª±a tr√™n lastUpdateTimestamp ƒë√£ t·∫£i
                    const timeDiff = nowForLoad - gameState.lastUpdateTimestamp;
                    let stateChangedByOfflineSim = false;

                    if (timeDiff > TICK_INTERVAL * 1.5 && gameState.lastUpdateTimestamp > 0) {
                        console.log(`Ph√°t hi·ªán th·ªùi gian offline: ${formatTime(timeDiff)}. B·∫Øt ƒë·∫ßu m√¥ ph·ªèng.`);
                        // C·ªông d·ªìn th·ªùi gian offline v√†o t·ªïng th·ªùi gian ch∆°i *tr∆∞·ªõc* khi m√¥ ph·ªèng
                        gameState.totalPlayTime += timeDiff;
                        // Ch·∫°y m√¥ ph·ªèng TR∆Ø·ªöC KHI c·∫≠p nh·∫≠t timestamp cu·ªëi
                        stateChangedByOfflineSim = simulateOfflineProgress(gameState.lastUpdateTimestamp, nowForLoad);
                    } else if (timeDiff > 0 && gameState.lastUpdateTimestamp > 0){
                        // Online li√™n t·ª•c ho·∫∑c offline r·∫•t ng·∫Øn, v·∫´n c·ªông d·ªìn th·ªùi gian ch∆°i
                        gameState.totalPlayTime += timeDiff;
                    }
                    // *** C·∫¨P NH·∫¨T TIMESTAMP CU·ªêI C√ôNG V·ªÄ TH·ªúI ƒêI·ªÇM HI·ªÜN T·∫†I SAU KHI M√î PH·ªéNG ***
                    gameState.lastUpdateTimestamp = nowForLoad;


                    // Ki·ªÉm tra v√† l√™n l·ªãch l·∫°i timer kh√¥ h·∫°n n·∫øu n√≥ ƒë√£ qua sau khi m√¥ ph·ªèng/t·∫£i
                    if (gameState.nextDryCheckTimestamp <= nowForLoad) {
                        console.log("Next dry check timestamp ƒë√£ ·ªü qu√° kh·ª© sau khi t·∫£i/m√¥ ph·ªèng, l√™n l·ªãch l·∫°i.");
                        gameState.nextDryCheckTimestamp = nowForLoad + (15 + Math.random() * 30) * 1000;
                    }

                     // ƒê√°nh d·∫•u c·∫ßn render UI th·ªùi ti·∫øt n·∫øu c√≥ thay ƒë·ªïi ho·∫∑c l√† l·∫ßn ƒë·∫ßu
                     if (stateChangedByOfflineSim || weatherUpdateNeeded) {
                         weatherUpdateNeeded = true; // ƒê·∫£m b·∫£o UI th·ªùi ti·∫øt ƒë∆∞·ª£c render trong tick ƒë·∫ßu ti√™n
                     }

                } else { // Kh√¥ng t√¨m th·∫•y save game ch√≠nh
                    console.log("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu game ƒë√£ l∆∞u. B·∫Øt ƒë·∫ßu game m·ªõi.");
                    // Sao ch√©p s√¢u tr·∫°ng th√°i m·∫∑c ƒë·ªãnh v√†o gameState
                    gameState = JSON.parse(JSON.stringify(defaultState));
                    // ƒê·∫£m b·∫£o timestamp l√† hi·ªán t·∫°i cho game m·ªõi
                    gameState.lastUpdateTimestamp = nowForLoad;
                    gameState.gameStartTime = nowForLoad;
                    gameState.nextWeatherChangeTimestamp = nowForLoad + WEATHER_CHANGE_INTERVAL_MS;
                    gameState.currentWeatherStartTime = nowForLoad;
                    gameState.nextDryCheckTimestamp = nowForLoad + (15 + Math.random() * 30) * 1000; // L·ªãch check kh√¥ h·∫°n ƒë·∫ßu ti√™n
                    console.log("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu l·ªãch s·ª≠ (do b·∫Øt ƒë·∫ßu game m·ªõi).");
                    localStorage.removeItem(HISTORY_SAVE_KEY); // X√≥a l·ªãch s·ª≠ c≈© n·∫øu c√≥
                    weatherUpdateNeeded = true; // ƒê√°nh d·∫•u c·∫ßn render UI th·ªùi ti·∫øt l·∫ßn ƒë·∫ßu
                }
            } catch (error) { // L·ªói khi parse ho·∫∑c x·ª≠ l√Ω save game ch√≠nh
                console.error("L·ªói nghi√™m tr·ªçng khi ph√¢n t√≠ch ho·∫∑c x·ª≠ l√Ω tr·∫°ng th√°i game ƒë√£ l∆∞u:", error);
                showMessage("D·ªØ li·ªáu l∆∞u c·ªßa game b·ªã l·ªói ho·∫∑c kh√¥ng t∆∞∆°ng th√≠ch. B·∫Øt ƒë·∫ßu game m·ªõi.", "error", MESSAGE_DISPLAY_TIME * 2);
                // X√≥a save b·ªã l·ªói v√† b·∫Øt ƒë·∫ßu l·∫°i t·ª´ ƒë·∫ßu
                localStorage.removeItem(GAME_SAVE_KEY);
                localStorage.removeItem(HISTORY_SAVE_KEY);
                // Sao ch√©p s√¢u tr·∫°ng th√°i m·∫∑c ƒë·ªãnh v√†o gameState
                gameState = JSON.parse(JSON.stringify(defaultState));
                // ƒê·∫£m b·∫£o timestamp l√† hi·ªán t·∫°i
                gameState.lastUpdateTimestamp = nowForLoad;
                gameState.gameStartTime = nowForLoad;
                gameState.nextWeatherChangeTimestamp = nowForLoad + WEATHER_CHANGE_INTERVAL_MS;
                gameState.currentWeatherStartTime = nowForLoad;
                gameState.nextDryCheckTimestamp = nowForLoad + (15 + Math.random() * 30) * 1000;
                weatherUpdateNeeded = true; // ƒê√°nh d·∫•u c·∫ßn render UI th·ªùi ti·∫øt l·∫ßn ƒë·∫ßu
            }
            console.log("Qu√° tr√¨nh t·∫£i game (bao g·ªìm l·ªãch s·ª≠, th·ªùi ti·∫øt object, v√† timer kh√¥ h·∫°n) ho√†n t·∫•t.");
            // initializePlotsData() s·∫Ω ƒë∆∞·ª£c g·ªçi ngay sau h√†m n√†y trong initGame,
            // n√≥ s·∫Ω ƒë·∫£m b·∫£o c√°c √¥ ƒë·∫•t ƒë∆∞·ª£c kh·ªüi t·∫°o/validate ƒë·∫ßy ƒë·ªß v·ªõi isDry.
        }
		// C·∫≠p nh·∫≠t: M√¥ ph·ªèng th·ªùi ti·∫øt d√πng object (id, icon, name)
/**
 * M√¥ ph·ªèng ti·∫øn tr√¨nh game trong kho·∫£ng th·ªùi gian offline (t·ª´ startTime ƒë·∫øn endTime).
 * C·∫≠p nh·∫≠t tr·∫°ng th√°i th·ªùi ti·∫øt v√† c√°c √¥ ƒë·∫•t.
 * @param {number} startTime - Timestamp (ms) b·∫Øt ƒë·∫ßu kho·∫£ng th·ªùi gian offline.
 * @param {number} endTime - Timestamp (ms) k·∫øt th√∫c kho·∫£ng th·ªùi gian offline (th·ªùi ƒëi·ªÉm load).
 * @returns {boolean} True n·∫øu tr·∫°ng th√°i game (th·ªùi ti·∫øt ho·∫∑c √¥ ƒë·∫•t) c√≥ thay ƒë·ªïi, False n·∫øu kh√¥ng.
 */

        /** [ƒê∆°n Gi·∫£n H√≥a Req 3] M√¥ ph·ªèng ti·∫øn tr√¨nh game trong kho·∫£ng th·ªùi gian offline */
       function simulateOfflineProgress(startTime, endTime) {
            const durationMs = endTime - startTime;
            const missedTicks = Math.floor(durationMs / TICK_INTERVAL);
            if (missedTicks <= 0) return false; // Kh√¥ng c√≥ g√¨ ƒë·ªÉ m√¥ ph·ªèng

            console.log(`ƒêang m√¥ ph·ªèng ${missedTicks} tick (${formatTime(durationMs)}) ƒë√£ b·ªã b·ªè l·ª°.`);
            let stateChanged = false; // C·ªù theo d√µi t·ªïng th·ªÉ thay ƒë·ªïi
            let weatherChangedDuringSim = false; // C·ªù theo d√µi thay ƒë·ªïi th·ªùi ti·∫øt

            // --- 1. M√¥ ph·ªèng TH·ªúI TI·∫æT tr∆∞·ªõc ---
            let simWeatherObject = JSON.parse(JSON.stringify(gameState.currentWeather));
            let simNextWeatherChange = gameState.nextWeatherChangeTimestamp;
            let simWeatherStartTime = gameState.currentWeatherStartTime;

            while (simNextWeatherChange < endTime) {
                const previousWeatherId = simWeatherObject.id;
                let candidateWeather;
                do {
                    candidateWeather = WEATHER_DATA[Math.floor(Math.random() * WEATHER_DATA.length)];
                } while (candidateWeather.id === previousWeatherId && WEATHER_DATA.length > 1);

                simWeatherObject = candidateWeather;
                simWeatherStartTime = simNextWeatherChange;
                simNextWeatherChange += WEATHER_CHANGE_INTERVAL_MS;
                weatherChangedDuringSim = true;
                console.log(`(Sim Offline) Th·ªùi ti·∫øt ƒë·ªïi th√†nh ${simWeatherObject.name || simWeatherObject.icon} (ID: ${simWeatherObject.id}) v√†o l√∫c m√¥ ph·ªèng ${formatTime(simWeatherStartTime - gameState.gameStartTime)}`);
            }
            // C·∫≠p nh·∫≠t gameState v·ªõi th·ªùi ti·∫øt M·ªöI NH·∫§T sau m√¥ ph·ªèng
            gameState.currentWeather = simWeatherObject;
            gameState.nextWeatherChangeTimestamp = simNextWeatherChange;
            gameState.currentWeatherStartTime = simWeatherStartTime;
            if (weatherChangedDuringSim) {
                weatherUpdateNeeded = true; // C·∫ßn render UI th·ªùi ti·∫øt sau m√¥ ph·ªèng
                stateChanged = true;        // ƒê√°nh d·∫•u tr·∫°ng th√°i chung thay ƒë·ªïi
            }

            // --- 2. M√¥ ph·ªèng √î ƒê·∫§T ---
            const p_no_pest_tick = 1 - PEST_APPEARANCE_CHANCE_PER_TICK_PER_PLOT;
            const p_no_pest_total = Math.pow(p_no_pest_tick, missedTicks);
            const p_get_pest_total = 1 - p_no_pest_total;
            let plotStateChanged = false; // C·ªù theo d√µi thay ƒë·ªïi c·ªßa ri√™ng √¥ ƒë·∫•t

            for (let i = 0; i < gameState.maxUnlockedPlots; i++) {
                 let plot = gameState.plots[i];
                 let plotChangedThisSim = false;
                 if (!plot) continue;

                 // >>> [M·ªöI SIM OFFLINE] M√¥ ph·ªèng KH√î H·∫†N tr∆∞·ªõc khi x·ª≠ l√Ω c√¢y tr·ªìng
                 // Gi·∫£ ƒë·ªãnh m·ªôt t·ªâ l·ªá trung b√¨nh b·ªã kh√¥ trong th·ªùi gian offline n·∫øu th·ªùi ti·∫øt cu·ªëi l√† N·∫ÆNG
                 let becameDryOffline = false;
                 if (gameState.currentWeather.id === 'sunny' && !plot.isDry) {
                     // T·ªâ l·ªá b·ªã kh√¥ tƒÉng theo th·ªùi gian offline (v√≠ d·ª• ƒë∆°n gi·∫£n)
                     const dryChanceOffline = Math.min(0.9, 0.0001 * missedTicks); // T·ªëi ƒëa 90%
                     if (Math.random() < dryChanceOffline) {
                         plot.isDry = true;
                         becameDryOffline = true;
                         plotChangedThisSim = true;
                         console.log(`(Sim Offline) Plot ${i} ƒë∆∞·ª£c t√≠nh l√† ƒë√£ b·ªã kh√¥ do n·∫Øng.`);
                     }
                 }
                 // Ng∆∞·ª£c l·∫°i, n·∫øu th·ªùi ti·∫øt cu·ªëi l√† M∆ØA, l√†m h·∫øt kh√¥
                 const rainyWeatherIdsForDrynessSim = ['rainy', 'thunderstorm', 'rainy_sunny'];
                 if (rainyWeatherIdsForDrynessSim.includes(gameState.currentWeather.id) && plot.isDry) {
                     plot.isDry = false;
                     plotChangedThisSim = true;
                     console.log(`(Sim Offline) Plot ${i} ƒë∆∞·ª£c t√≠nh l√† ƒë√£ h·∫øt kh√¥ do m∆∞a.`);
                 }
                 // >>> K·∫æT TH√öC SIM KH√î H·∫†N <<<

                 if (plot.seedId && plot.plantTime) {
                     const seedInfo = ITEM_DATA[plot.seedId];
                     if (!seedInfo) continue;

                     const effectiveGrowthTimeSec = getEffectiveGrowthTime(plot);
                     const totalGrowthTimeMs = effectiveGrowthTimeSec * 1000;
                     const finalElapsedTime = endTime - plot.plantTime;
                     const finalGrowthProgress = totalGrowthTimeMs > 0 ? Math.min(1, finalElapsedTime / totalGrowthTimeMs) : 1;
                     const isMatureEstimate = finalGrowthProgress >= 1.0 - 0.0001;

                     // M√¥ ph·ªèng s√¢u xu·∫•t hi·ªán (ch·ªâ khi th·ªùi ti·∫øt kh√¥ng m∆∞a)
                     let pestAppearedOffline = false;
                     const noPestWeatherIdsSim = ['sunny', 'cloudy', 'windy', 'lightning'];
                     if (noPestWeatherIdsSim.includes(gameState.currentWeather.id) && plot.health > 0 && !plot.hasPest) {
                         if (Math.random() < p_get_pest_total) {
                             plot.hasPest = true; pestAppearedOffline = true;
                             console.log(`(Sim Offline) S√¢u ƒë∆∞·ª£c t√≠nh l√† ƒë√£ xu·∫•t hi·ªán tr√™n √¥ ${i} (${seedInfo.name}).`);
                             plotChangedThisSim = true;
                         }
                     }
                     // M√¥ ph·ªèng s√°t th∆∞∆°ng s√¢u
                     if (plot.hasPest && plot.health > 0) {
                         let damageTicks = pestAppearedOffline ? Math.floor(missedTicks / 2) : missedTicks;
                         let damagePerTickSim = PEST_DAMAGE_PER_TICK * (isMatureEstimate ? PEST_DAMAGE_MATURE_REDUCTION_FACTOR : 1);
                         let totalDamageSim = damagePerTickSim * damageTicks;
                         const oldHealth = plot.health;
                         plot.health = Math.max(0, plot.health - totalDamageSim);
                         if (plot.health === 0 && oldHealth > 0) {
                             plot.causeOfDeath = 'pest'; plot.hasPest = false; plot.pestDeathClickCount = 0; plot.isDry = false; // H·∫øt kh√¥ khi ch·∫øt do s√¢u
                             console.warn(`(Sim Offline) √î ${i} (${seedInfo.name}) ƒë∆∞·ª£c t√≠nh l√† CH·∫æT v√¨ s√¢u.`);
                             plotChangedThisSim = true;
                         } else if (plot.health !== oldHealth) { plotChangedThisSim = true; }
                     }
                     // M√¥ ph·ªèng h·ªìi m√°u (ch·ªâ khi kh√¥ng s√¢u, kh√¥ng kh√¥)
                     if (!plot.hasPest && plot.health > 0 && plot.health < INITIAL_PLANT_HEALTH && !plot.isDry) {
                        const totalRegen = HEALTH_REGEN_PER_TICK * missedTicks;
                        const oldHealth = plot.health;
                        plot.health = Math.min(INITIAL_PLANT_HEALTH, plot.health + totalRegen);
                        if (plot.health !== oldHealth) plotChangedThisSim = true;
                     }
                     // M√¥ ph·ªèng gi·∫£m m√°u/ph√¨ do KH√î H·∫†N (n·∫øu isDry l√† true sau m√¥ ph·ªèng th·ªùi ti·∫øt/n·∫Øng)
                     if (plot.isDry) {
                          let changedByDrynessSim = false;
                          if (plot.seedId && plot.health > 0) { // C√¢y ƒëang s·ªëng b·ªã kh√¥
                             const healthDrainSim = DRY_HEALTH_DRAIN_PER_TICK * missedTicks;
                             const oldHealthSim = plot.health;
                             plot.health = Math.max(0, plot.health - healthDrainSim);
                             if (plot.health === 0 && oldHealthSim > 0) {
                                 plot.causeOfDeath = 'dryness'; plot.hasPest = false; plot.isDry = false; // H·∫øt kh√¥ khi ch·∫øt
                                 console.warn(`(Sim Offline) √î ${i} (${seedInfo.name}) ƒë∆∞·ª£c t√≠nh l√† CH·∫æT v√¨ kh√¥ h·∫°n.`);
                                 changedByDrynessSim = true;
                             } else if (plot.health !== oldHealthSim) { changedByDrynessSim = true; }
                          } else if (!plot.seedId && plot.fertility > 0) { // ƒê·∫•t tr·ªëng b·ªã kh√¥
                             const fertilityDrainSim = DRY_FERTILITY_DRAIN_PER_TICK * missedTicks;
                             const oldFertilitySim = plot.fertility;
                             plot.fertility = Math.max(0, plot.fertility - fertilityDrainSim);
                             if (plot.fertility !== oldFertilitySim) changedByDrynessSim = true;
                          }
                          if(changedByDrynessSim) plotChangedThisSim = true;
                     }
                     // M√¥ ph·ªèng gi·∫£m ƒë·ªô ph√¨ nhi√™u do c√¢y l·ªõn (n·∫øu c√¢y c√≤n s·ªëng v√† ch∆∞a ch√≠n)
                     if (!isMatureEstimate && plot.health > 0 && seedInfo.fertilityCost > 0 && seedInfo.growthTime > 0 && plot.fertility > 0) {
                         const baseGrowthTime = seedInfo.growthTime;
                         const fertilityDecreasePerTick = (seedInfo.fertilityCost * BASE_FERTILITY) / baseGrowthTime;
                         const totalFertilityDecrease = fertilityDecreasePerTick * missedTicks;
                         if (totalFertilityDecrease > 0) {
                             const oldFertility = plot.fertility;
                             plot.fertility = Math.max(0, plot.fertility - totalFertilityDecrease);
                             if (plot.fertility !== oldFertility) plotChangedThisSim = true;
                         }
                     }
                     // Ki·ªÉm tra tr∆∞·ªüng th√†nh (n·∫øu c√¢y s·ªëng v√† kh√¥ng s√¢u)
                     const stageInfoBefore = getPlantStageInfo(plot, startTime);
                     if (plot.health > 0 && !plot.hasPest && stageInfoBefore && !stageInfoBefore.isMature && isMatureEstimate) {
                          console.log(`(Sim Offline) √î ${plot.id} (${seedInfo.name}) ƒë∆∞·ª£c t√≠nh l√† ƒë√£ tr∆∞·ªüng th√†nh.`);
                          plotChangedThisSim = true;
                     }
                 } else if (plot.isDry && !plot.seedId && plot.fertility > 0) {
                    // X·ª≠ l√Ω gi·∫£m ph√¨ cho ƒë·∫•t tr·ªëng B·ªä KH√î trong th·ªùi gian offline
                    const fertilityDrainSim = DRY_FERTILITY_DRAIN_PER_TICK * missedTicks;
                    const oldFertilitySim = plot.fertility;
                    plot.fertility = Math.max(0, plot.fertility - fertilityDrainSim);
                    if (plot.fertility !== oldFertilitySim) {
                         plotChangedThisSim = true;
                         if(plot.fertility === 0) console.log(`(Sim Offline) Plot ${i} (tr·ªëng) tr·ªü n√™n c·∫±n c·ªói do kh√¥ h·∫°n.`);
                    }
                 }

                 if(plotChangedThisSim) plotStateChanged = true; // C·∫≠p nh·∫≠t c·ªù chung n·∫øu plot n√†y thay ƒë·ªïi

            } // K·∫øt th√∫c v√≤ng l·∫∑p for c√°c √¥ ƒë·∫•t

            // --- [C·∫¨P NH·∫¨T] 3. M√¥ ph·ªèng TƒÉng Ph√¨ Nhi√™u Do Th·ªùi Ti·∫øt M∆∞a ---
            const fertilityBoostingWeatherIdsSim = ['rainy', 'thunderstorm', 'rainy_sunny']; // M·∫£ng ID th·ªùi ti·∫øt tƒÉng ph√¨ (d√πng trong sim)
            // S·ª≠ d·ª•ng tr·∫°ng th√°i th·ªùi ti·∫øt cu·ªëi c√πng sau khi m√¥ ph·ªèng th·ªùi ti·∫øt ·ªü b∆∞·ªõc 1
            if (fertilityBoostingWeatherIdsSim.includes(gameState.currentWeather.id)) {
                const totalOfflineDurationMs = endTime - startTime;
                // T√≠nh s·ªë l·∫ßn boost d·ª±a tr√™n kho·∫£ng th·ªùi gian th·ª±c t·∫ø c·ªßa th·ªùi ti·∫øt m∆∞a cu·ªëi c√πng trong offline
                const lastRainStartTime = simWeatherStartTime > startTime ? simWeatherStartTime : startTime; // Th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu c·ªßa chu k·ª≥ m∆∞a cu·ªëi
                const rainDurationMs = endTime - lastRainStartTime;
                const numberOfRainBoosts = Math.floor(rainDurationMs / 15000); // S·ªë l·∫ßn tƒÉng m·ªói 15 gi√¢y TRONG CHU K·ª≤ M∆ØA CU·ªêI

                if (numberOfRainBoosts > 0) {
                    console.log(`(Sim Offline) Applying ${numberOfRainBoosts} fertility boosts due to weather: ${gameState.currentWeather.id}.`);
                    let rainBoostChangedStateSim = false; // C·ªù ri√™ng cho thay ƒë·ªïi do m∆∞a offline
                    for (let i = 0; i < gameState.maxUnlockedPlots; i++) {
                        let plot = gameState.plots[i];
                        if (plot && plot.fertility < BASE_FERTILITY) {
                            const oldFertilitySim = plot.fertility;
                            plot.fertility = Math.min(BASE_FERTILITY, plot.fertility + numberOfRainBoosts * 1); // Boost = s·ªë l·∫ßn * 1%
                            if (plot.fertility !== oldFertilitySim) {
                                rainBoostChangedStateSim = true; // ƒê√°nh d·∫•u c√≥ thay ƒë·ªïi
                                // Reset penalty if recovered from barren
                                if (oldFertilitySim <= 0 && plot.fertility > 0) {
                                    plot.barrenHarvestPenaltyFactor = 1.0;
                                }
                            }
                        }
                    }
                    if (rainBoostChangedStateSim) {
                         plotStateChanged = true; // C·∫≠p nh·∫≠t c·ªù thay ƒë·ªïi plot chung
                    }
                }
            }
            // --- K·∫øt th√∫c m√¥ ph·ªèng tƒÉng ph√¨ nhi√™u do m∆∞a ---

            // C·∫≠p nh·∫≠t l·∫°i stateChanged d·ª±a tr√™n thay ƒë·ªïi th·ªùi ti·∫øt HO·∫∂C thay ƒë·ªïi plot
            stateChanged = weatherChangedDuringSim || plotStateChanged;

            console.log(`M√¥ ph·ªèng offline ho√†n t·∫•t. Tr·∫°ng th√°i ${stateChanged ? 'ƒê√É' : 'KH√îNG'} thay ƒë·ªïi.`);
            return stateChanged; // Tr·∫£ v·ªÅ true n·∫øu c√≥ b·∫•t k·ª≥ thay ƒë·ªïi n√†o
        }


        /** Hi·ªÉn th·ªã m·ªôt tin nh·∫Øn t·∫°m th·ªùi */
        function showMessage(text, type = 'info', duration = MESSAGE_DISPLAY_TIME) {
            if (messageTimeout) clearTimeout(messageTimeout);
            messageArea.textContent = text;
            const isMultiline = text.includes('\n');
            messageArea.className = 'show ' + type + (isMultiline ? ' multiline' : '');
            messageTimeout = setTimeout(() => {
                messageArea.classList.remove('show');
                 // Th√™m delay nh·ªè tr∆∞·ªõc khi x√≥a class type ƒë·ªÉ tr√°nh gi·∫≠t
                 setTimeout(() => { if (!messageArea.classList.contains('show')) { messageArea.className = ''; } }, 500);
            }, duration);
        }

        /** M·ªü m·ªôt h·ªôp tho·∫°i modal b·∫±ng ID */
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) { modal.style.display = 'block';
                // T·ª± ƒë·ªông focus v√†o ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n c√≥ th·ªÉ focus trong modal
                const focusable = modal.querySelector('button:not(:disabled), [href], input:not(:disabled), select:not(:disabled), textarea:not(:disabled), [tabindex]:not([tabindex="-1"]), .close-button');
                if (focusable) { setTimeout(() => focusable.focus(), 50); } // Delay nh·ªè ƒë·ªÉ ƒë·∫£m b·∫£o modal ƒë√£ hi·ªán
            } else { console.error(`Modal ID "${modalId}" kh√¥ng t·ªìn t·∫°i.`); }
        }

        /** ƒê√≥ng m·ªôt h·ªôp tho·∫°i modal b·∫±ng ID */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal && modal.style.display === 'block') { modal.style.display = 'none'; }
        }

        /** ƒê√≥ng t·∫•t c·∫£ c√°c modal ƒëang m·ªü */
        function closeAllModals() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => closeModal(modal.id));
            // Reset c√°c bi·∫øn tr·∫°ng th√°i li√™n quan ƒë·∫øn modal
            currentPlantingPlotId = null;
            currentActionPlotId = null;
        }


        /** X·ª≠ l√Ω click b√™n ngo√†i n·ªôi dung modal ƒë·ªÉ ƒë√≥ng */
       function handleModalBackgroundClick(event) {
            // ƒê√≥ng popup menu n·∫øu click n·ªÅn c·ªßa n√≥
            if (event.target === menuPopup) {
                closeMenuPopup();
            }
            // ƒê√≥ng popup √¥ kh√≥a n·∫øu click n·ªÅn c·ªßa n√≥
            else if (event.target === lockedPlotPopup) {
                closeLockedPlotPopup();
            }
            // [M·ªöI] ƒê√≥ng popup x√°c nh·∫≠n b√°n h·∫øt n·∫øu click n·ªÅn
            else if (event.target === confirmSellAllModal) {
                 closeConfirmSellAllModal();
            }
            // ƒê√≥ng c√°c modal kh√°c n·∫øu click n·ªÅn c·ªßa ch√∫ng (class .modal nh∆∞ng kh√¥ng ph·∫£i c√°c popup tr√™n)
            else if (event.target.classList.contains('modal') && event.target !== menuPopup && event.target !== lockedPlotPopup && event.target !== confirmSellAllModal) {
                const modalId = event.target.id;
                closeModal(modalId); // D√πng h√†m closeModal g·ªëc
                // Reset ID n·∫øu c·∫ßn khi ƒë√≥ng b·∫±ng click n·ªÅn
                if (modalId === 'seed-selection-modal') currentPlantingPlotId = null;
                if (modalId === 'fertilizer-selection-modal' || modalId === 'plant-action-modal' || modalId === 'empty-plot-action-modal') currentActionPlotId = null;
            }
        }

        /** C·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t mua trong c·ª≠a h√†ng d·ª±a tr√™n ti·ªÅn hi·ªán c√≥ */
         function updateShopButtons() {
     if (!shopSeedList || !shopToolList) return;
     // C·∫≠p nh·∫≠t n√∫t mua h·∫°t gi·ªëng (ki·ªÉm tra c·∫£ s·ªë l∆∞·ª£ng)
     shopSeedList.querySelectorAll('.item-card').forEach(card => {
         const itemId = card.dataset.itemId;
         if(itemId && ITEM_DATA[itemId]?.type === 'seed') {
             updateSeedTotalCost(itemId, card); // H√†m n√†y ƒë√£ ki·ªÉm tra ti·ªÅn v√† s·ªë l∆∞·ª£ng
         }
     });
     // [C·∫¨P NH·∫¨T] C·∫≠p nh·∫≠t n√∫t mua C√îNG C·ª§ (d√πng logic t∆∞∆°ng t·ª± h·∫°t gi·ªëng)
     shopToolList.querySelectorAll('.item-card').forEach(card => {
          const itemId = card.dataset.itemId;
          const item = ITEM_DATA[itemId];
          if (!item || item.type !== 'tool') return; // Ch·ªâ x·ª≠ l√Ω tool
          // G·ªçi h√†m c·∫≠p nh·∫≠t t·ªïng chi ph√≠ (d√πng chung v·ªõi h·∫°t gi·ªëng v√¨ c·∫•u tr√∫c HTML gi·ªëng nhau)
          updateSeedTotalCost(itemId, card);
     });
 }

        /** ƒê·ªãnh d·∫°ng mili gi√¢y th√†nh chu·ªói th·ªùi gian ƒë·ªçc ƒë∆∞·ª£c */
        function formatTime(ms, short = false) {
            if (isNaN(ms) || ms <= 0) return short ? "0s" : "0 gi√¢y";
            const totalSeconds = Math.max(0, Math.round(ms / 1000));
            const d = Math.floor(totalSeconds / 86400); const h = Math.floor((totalSeconds % 86400) / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60); const s = totalSeconds % 60;
            const dStr = short ? "ng" : " ng√†y"; const hStr = short ? "g" : " gi·ªù";
            const mStr = short ? "ph" : " ph√∫t"; const sStr = short ? "s" : " gi√¢y"; const sep = short ? "" : " ";
            let parts = [];
            if (d > 0) parts.push(`${d}${dStr}`); if (h > 0) parts.push(`${h}${hStr}`);
            if (m > 0) parts.push(`${m}${mStr}`);
            // Hi·ªÉn th·ªã gi√¢y n·∫øu l√† ƒë·ªãnh d·∫°ng ng·∫Øn, ho·∫∑c n·∫øu t·ªïng th·ªùi gian < 1 ph√∫t, ho·∫∑c n·∫øu kh√¥ng c√≥ ph·∫ßn n√†o kh√°c
            if (s > 0 || parts.length === 0 || totalSeconds < 60 || short) {
                // Tr√°nh hi·ªÉn th·ªã "X ph√∫t 0 gi√¢y" ·ªü ƒë·ªãnh d·∫°ng d√†i
                if (!(!short && parts.length > 0 && s === 0 && totalSeconds >= 60)) {
                    parts.push(`${s}${sStr}`);
                }
            }
            // Gi·ªõi h·∫°n ·ªü 2 ph·∫ßn ch√≠nh cho ƒë·ªãnh d·∫°ng d√†i
            if (!short && parts.length > 2) parts = parts.slice(0, 2);
            return parts.length > 0 ? parts.join(sep) : (short ? "0s" : "0 gi√¢y");
        }


        // --- X·ª≠ L√Ω Tab ---
        // =================

        /** Chuy·ªÉn tab c·ª≠a h√†ng */
        function switchShopTab(tabToShow) {
            if (!shopTabsContainer || !shopSeedList || !shopToolList) return;
            shopTabsContainer.querySelectorAll('.shop-tab-button').forEach(btn => { btn.classList.toggle('active', btn.dataset.tab === tabToShow); });
            const seedsActive = tabToShow === 'seeds';
            shopSeedList.classList.toggle('active-list', seedsActive); shopToolList.classList.toggle('active-list', !seedsActive);
            // D√πng display grid/none ƒë·ªÉ ƒë·∫£m b·∫£o ·∫©n/hi·ªán ƒë√∫ng c√°ch
            shopSeedList.style.display = seedsActive ? 'grid' : 'none';
            shopToolList.style.display = !seedsActive ? 'grid' : 'none';
        }
        /** X·ª≠ l√Ω click tab c·ª≠a h√†ng */
        function handleShopTabClick(event) {
            const tabButton = event.target.closest('.shop-tab-button[data-tab]');
            if (tabButton) { const selectedTab = tabButton.dataset.tab; if (selectedTab) switchShopTab(selectedTab); }
        }

        /** Chuy·ªÉn tab kho ƒë·ªì */
        function switchInventoryTab(tabToShow) {
             if (!inventoryTabsContainer || !inventoryHarvestedList || !inventoryPurchasedList) return;
             inventoryTabsContainer.querySelectorAll('.inventory-tab-button').forEach(btn => {
                 btn.classList.toggle('active', btn.dataset.tab === tabToShow);
             });
             const harvestedActive = tabToShow === 'harvested';
             inventoryHarvestedList.classList.toggle('active-list', harvestedActive);
             inventoryPurchasedList.classList.toggle('active-list', !harvestedActive);
             // Ki·ªÉm tra xem list c√≥ r·ªóng kh√¥ng tr∆∞·ªõc khi quy·∫øt ƒë·ªãnh display
             const harvestedHasItems = inventoryHarvestedList.querySelector('.item-card');
             const purchasedHasItems = inventoryPurchasedList.querySelector('.item-card');
             inventoryHarvestedList.style.display = (harvestedActive && harvestedHasItems) ? 'grid' : 'none';
             inventoryPurchasedList.style.display = (!harvestedActive && purchasedHasItems) ? 'grid' : 'none';
             // Hi·ªÉn th·ªã th√¥ng b√°o tr·ªëng n·∫øu tab active kh√¥ng c√≥ item
             inventoryHarvestedEmptyMessage.style.display = (harvestedActive && !harvestedHasItems) ? 'block' : 'none';
             inventoryPurchasedEmptyMessage.style.display = (!harvestedActive && !purchasedHasItems) ? 'block' : 'none';
        }
        /** X·ª≠ l√Ω click tab kho ƒë·ªì */
        function handleInventoryTabClick(event) {
             const tabButton = event.target.closest('.inventory-tab-button[data-tab]');
             if (tabButton) {
                 const selectedTab = tabButton.dataset.tab;
                 if (selectedTab) switchInventoryTab(selectedTab);
             }
        }


        // --- C√°c H√†m Tooltip ---
        // =======================
        function showTooltip(text, targetElement) {
            if (!text || !targetElement) return; clearTimeout(tooltipTimeout); clearTimeout(tooltipHideTimeout);
            tooltipTimeout = setTimeout(() => { tooltipElement.innerHTML = text.replace(/\n/g, '<br>'); currentTooltipTarget = targetElement; positionTooltip(); tooltipElement.classList.add('visible'); }, TOOLTIP_DELAY);
        }
        function hideTooltip(delay = 0) {
             clearTimeout(tooltipTimeout); clearTimeout(tooltipHideTimeout);
             tooltipHideTimeout = setTimeout(() => { tooltipElement.classList.remove('visible'); currentTooltipTarget = null; setTimeout(() => { if (!tooltipElement.classList.contains('visible')) { tooltipElement.style.left = '-9999px'; tooltipElement.style.top = '-9999px'; } }, 200); }, delay);
        }
        function positionTooltip() {
            if (!tooltipElement.classList.contains('visible') || !currentTooltipTarget) return;
            const targetRect = currentTooltipTarget.getBoundingClientRect();
            // T·∫°m ·∫©n ƒë·ªÉ l·∫•y k√≠ch th∆∞·ªõc ƒë√∫ng
            tooltipElement.style.visibility = 'hidden';
            tooltipElement.style.display = 'block';
            const tooltipRect = tooltipElement.getBoundingClientRect();
            // Hi·ªán l·∫°i
            tooltipElement.style.visibility = '';
            tooltipElement.style.display = '';

            const vpWidth = window.innerWidth; const vpHeight = window.innerHeight; const offset = 8;
            let x = targetRect.left + targetRect.width / 2 - tooltipRect.width / 2;
            let y = targetRect.top - tooltipRect.height - offset; // M·∫∑c ƒë·ªãnh ·ªü tr√™n

            // N·∫øu kh√¥ng ƒë·ªß ch·ªó ·ªü tr√™n, th·ª≠ ·ªü d∆∞·ªõi
            if (y < offset) {
                y = targetRect.bottom + offset;
                // N·∫øu ·ªü d∆∞·ªõi c≈©ng kh√¥ng ƒë·ªß, ƒë·∫∑t ·ªü v·ªã tr√≠ cao nh·∫•t c√≥ th·ªÉ trong viewport
                if (y + tooltipRect.height > vpHeight - offset) {
                    y = vpHeight - tooltipRect.height - offset;
                }
            }
            // ƒê·∫£m b·∫£o kh√¥ng tr√†n tr√°i/ph·∫£i
            if (x < offset) { x = offset; }
            else if (x + tooltipRect.width > vpWidth - offset) { x = vpWidth - tooltipRect.width - offset; }

            tooltipElement.style.left = `${Math.round(x)}px`;
            tooltipElement.style.top = `${Math.round(y)}px`;
        }
        /** X·ª≠ l√Ω hover √¥ v∆∞·ªùn -> hi·ªÉn th·ªã tooltip */
        function handlePlotMouseover(event) {
            const plotElement = event.target.closest('.plot');
            if (!plotElement) return;
            const plotId = parseInt(plotElement.dataset.plotId);
            if (isNaN(plotId)) return;

            let tooltipText = '';
            const isLocked = plotElement.classList.contains('locked');

            if (isLocked) {
                 const cost = calculatePlotCost(plotId);
                 tooltipText = `üîí √î ƒê·∫•t B·ªã Kh√≥a\nClick ƒë·ªÉ mua (Gi√°: ${cost}üí∞)`;
            } else {
                 const plotData = gameState.plots[plotId];
                 if (!plotData) return;

                 const now = Date.now();
                 const stageInfo = getPlantStageInfo(plotData, now);
                 const seedInfo = plotData.seedId ? ITEM_DATA[plotData.seedId] : null;
                 const isBarren = plotData.fertility <= 0;
                 const penaltyFactor = plotData.barrenHarvestPenaltyFactor || 1.0;

                 const fertilityInfo = isBarren ? `ƒê·∫•t: C·∫∞N 0%` : `ƒê·∫•t: ${Math.round(plotData.fertility)}%`;
                 let barrenPenaltyText = '';
                 if (isBarren && penaltyFactor > 1.0) {
                      barrenPenaltyText = `\n(M·ªçc ch·∫≠m x${penaltyFactor.toFixed(2)})`;
                 }
                 // B·ªè resistanceInfo, pestCountInfo

                 if (plotData.seedId && stageInfo.isDead) {
                      const plantNameDead = seedInfo?.name || 'C√¢y';
                      if(plotData.causeOfDeath === 'pest') {
                          const hasEnoughMoney = gameState.currency >= DEAD_PEST_CLEANUP_COST;
                          if (hasEnoughMoney) tooltipText = `üíÄ ${plantNameDead} ch·∫øt (Do S√¢u)!\n(${fertilityInfo})${barrenPenaltyText}\nClick ƒë·ªÉ d·ªçn (${DEAD_PEST_CLEANUP_COST}üí∞).`;
                          else tooltipText = `üíÄ ${plantNameDead} ch·∫øt (Do S√¢u)!\n(${fertilityInfo})${barrenPenaltyText}\nClick ${DEAD_PEST_FREE_CLEANUP_CLICKS - (plotData.pestDeathClickCount||0)} l·∫ßn ƒë·ªÉ d·ªçn mi·ªÖn ph√≠.`;
                      } else {
                           tooltipText = `üíÄ ${plantNameDead} ch·∫øt.\n(${fertilityInfo})${barrenPenaltyText}\nClick ƒë·ªÉ d·ªçn (Mi·ªÖn ph√≠).`;
                      }
                 } else if (plotData.hasPest) {
                      const plantNamePest = seedInfo?.name || 'C√¢y';
                      tooltipText = `üêõ S√ÇU B·ªÜNH!\n(${plantNamePest} - HP: ${Math.round(plotData.health)}%)\n(${fertilityInfo})${barrenPenaltyText}\nClick M·ªü H√†nh ƒê·ªông.`;
                 } else if (plotData.seedId && seedInfo && !stageInfo.isError) {
                      if (stageInfo.isMature) {
                           const sellValue = Math.round(1 * (plotData.health / 100)) * (seedInfo.harvestYield || 0);
                           tooltipText = `‚úÖ ${seedInfo.name} ƒë√£ ch√≠n!\n(HP ${Math.round(plotData.health)}% - B√°n: ${sellValue}üí∞)\n(${fertilityInfo})${barrenPenaltyText}\nClick M·ªü H√†nh ƒê·ªông.`;
                      } else {
                         const effectiveGrowthTimeMs = stageInfo.effectiveGrowthTimeSec * 1000;
                         const timeRemainingMs = Math.max(0, effectiveGrowthTimeMs - (now - plotData.plantTime));
                         tooltipText = `${seedInfo.name}: ${Math.round(stageInfo.growthProgress * 100)}% l·ªõn\n(HP ${Math.round(plotData.health)}% - C√≤n ${formatTime(timeRemainingMs, true)})\n(${fertilityInfo})${barrenPenaltyText}\nClick M·ªü H√†nh ƒê·ªông.`;
                      }
                 } else { // √î tr·ªëng
                      tooltipText = `√î ƒë·∫•t tr·ªëng\n(${fertilityInfo})${barrenPenaltyText}\nClick M·ªü H√†nh ƒê·ªông.`;
                 }
            }
            showTooltip(tooltipText, plotElement);
        }
        function handlePlotMousemove(event) { if (tooltipElement.classList.contains('visible')) { positionTooltip(); } }
        function handlePlotMouseout(event) { hideTooltip(50); } // ·∫®n nhanh khi r·ªùi chu·ªôt

        // --- C√°c B·ªô X·ª≠ L√Ω S·ª± Ki·ªán To√†n C·ª•c & V√≤ng ƒê·ªùi Game ---
        // ======================================================
        function handlePageUnload(event) { console.log("S·ª± ki·ªán 'beforeunload': L∆∞u game l·∫ßn cu·ªëi..."); if (gameLoopInterval) stopGameLoop(); saveGame(); }
        function handleVisibilityChange() {
            const now = Date.now();
            if (document.hidden) { console.log("Tr·∫°ng th√°i trang: ·∫®n. L∆∞u game, d·ª´ng v√≤ng l·∫∑p."); if (gameLoopInterval) stopGameLoop(); saveGame(); }
            else {
                console.log("Tr·∫°ng th√°i trang: Hi·ªÉn th·ªã. M√¥ ph·ªèng offline (n·∫øu c·∫ßn), kh·ªüi ƒë·ªông l·∫°i.");
                 const timeWasHidden = now - gameState.lastUpdateTimestamp;
                 let stateChangedSim = false;
                 if (timeWasHidden > TICK_INTERVAL * 1.5 && gameState.lastUpdateTimestamp > 0) {
                    stateChangedSim = simulateOfflineProgress(gameState.lastUpdateTimestamp, now);
                    // C·∫≠p nh·∫≠t t·ªïng th·ªùi gian ch∆°i SAU khi m√¥ ph·ªèng xong
                    gameState.totalPlayTime += timeWasHidden;
                    // C·∫≠p nh·∫≠t timestamp cu·ªëi c√πng SAU khi m√¥ ph·ªèng
                    gameState.lastUpdateTimestamp = now;
                 } else if (timeWasHidden > 0 && gameState.lastUpdateTimestamp > 0){
                    // N·∫øu ch·ªâ ·∫©n trong th·ªùi gian ng·∫Øn, v·∫´n c·∫≠p nh·∫≠t th·ªùi gian ch∆°i v√† timestamp
                    gameState.totalPlayTime += timeWasHidden;
                    gameState.lastUpdateTimestamp = now;
                 } else {
                    // N·∫øu kh√¥ng c√≥ timestamp c≈© ho·∫∑c timeDiff <= 0, ch·ªâ c·∫≠p nh·∫≠t timestamp
                    gameState.lastUpdateTimestamp = now;
                 }

                 // [M·ªöI Req 3] Ki·ªÉm tra v√† x·ª≠ l√Ω tr·∫°ng th√°i Pest Event sau khi quay l·∫°i
                  if (gameState.isPestEventActive) {
                      if (now - gameState.pestEventStartTime >= PEST_EVENT_DURATION_MS) {
                           console.log("(Visibility) S·ª± ki·ªán s√¢u b·ªánh ƒë√£ k·∫øt th√∫c khi tab ·∫©n.");
                           gameState.isPestEventActive = false;
                           gameState.pestEventStartTime = 0;
                           stateChangedSim = true; // ƒê√°nh d·∫•u c·∫ßn render l·∫°i
                      } else {
                           console.log("(Visibility) S·ª± ki·ªán s√¢u b·ªánh v·∫´n ƒëang di·ªÖn ra.");
                           setTimeout(() => showMessage(`üêõ M√πa d·ªãch s√¢u b·ªánh ƒëang di·ªÖn ra!`, "pest-event"), 500);
                      }
                  }

                 // Render l·∫°i n·∫øu c√≥ thay ƒë·ªïi t·ª´ m√¥ ph·ªèng offline ho·∫∑c event k·∫øt th√∫c
                  if (stateChangedSim) {
                     renderGarden(); renderUI(); updateShopButtons(); if(inventoryModal.style.display === 'block') renderInventory();
                 }
                 startGameLoop(); // Kh·ªüi ƒë·ªông l·∫°i v√≤ng l·∫∑p
            }
        }
		function openMenuPopup() {
         if (menuPopup) {
            menuPopup.style.display = 'block'; // Ho·∫∑c 'flex' n·∫øu CSS d√πng flex ƒë·ªÉ cƒÉn gi·ªØa
            // T√πy ch·ªçn: Focus v√†o n√∫t l·ªãch s·ª≠ (n√∫t c√≤n l·∫°i) ho·∫∑c n√∫t ƒë√≥ng
            const focusTarget = plantingHistoryBtn || closeMenuPopupBtn; // <<< C·∫¨P NH·∫¨T D√íNG N√ÄY
            if (focusTarget) {
                setTimeout(() => focusTarget.focus(), 50);
            }
        } else {
            console.error("Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ DOM c·ªßa menu popup!");
        }
    }

    /** ƒê√≥ng Popup Menu Ch√≠nh */
    function closeMenuPopup() {
        if (menuPopup) {
            menuPopup.style.display = 'none';
        }
    }
	

    /** X·ª≠ l√Ω click n√∫t L·ªãch s·ª≠ tr·ªìng c√¢y */
function handlePlantingHistoryClick() {
            console.log("Chuy·ªÉn ƒë·∫øn trang L·ªãch s·ª≠ tr·ªìng c√¢y...");
            // Chuy·ªÉn h∆∞·ªõng ng∆∞·ªùi d√πng ƒë·∫øn trang history-menu.html
            window.location.href = 'history-menu.html';
            // Kh√¥ng c·∫ßn ƒë√≥ng menu ·ªü ƒë√¢y v√¨ trang s·∫Ω chuy·ªÉn ƒëi
            // closeMenuPopup(); // D√≤ng n√†y kh√¥ng c·∫ßn thi·∫øt n·ªØa
        }




        // --- B·∫Øt ƒê·∫ßu Game ---
        // =====================
        document.addEventListener('DOMContentLoaded', initGame);
        console.log("Script V∆∞·ªùn C√¢y (v9.2) ƒë√£ ƒë∆∞·ª£c t·∫£i. ƒêang ch·ªù DOMContentLoaded...");

    </script>

</body>
</html>
