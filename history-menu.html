<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch S·ª≠ Ho·∫°t ƒê·ªông - V∆∞·ªùn C√¢y H·∫°nh Ph√∫c</title>
    <link rel="stylesheet" href="style-history-menu.css"> <!-- Li√™n k·∫øt t·ªõi CSS -->
</head>
<body>

    <div class="history-container">
        <h1>üìú L·ªãch S·ª≠ Ho·∫°t ƒê·ªông üìú</h1>

        <div class="history-controls">
            <button id="back-button">‚¨ÖÔ∏è Quay l·∫°i V∆∞·ªùn</button>
            <button id="clear-history-button">üóëÔ∏è X√≥a L·ªãch s·ª≠</button>
        </div>

        <ul id="history-list">
            <!-- C√°c m·ª•c l·ªãch s·ª≠ s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
        </ul>
        <p id="empty-history-message" class="empty-message" style="display: none;">
            L·ªãch s·ª≠ ho·∫°t ƒë·ªông c·ªßa b·∫°n hi·ªán ƒëang tr·ªëng. <br>
            H√£y quay l·∫°i v∆∞·ªùn v√† b·∫Øt ƒë·∫ßu tr·ªìng tr·ªçt nh√©!
        </p>
    </div>

    <!-- [M·ªöI] Th·∫ª audio gi·ªëng h·ªát b√™n Farm.html -->
    <audio id="background-music" loop preload="auto">
        <source src="nhacnen.mp3" type="audio/mpeg">
        Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph√°t √¢m thanh.
    </audio>
    <!-- K·∫øt th√∫c th·∫ª Audio -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const historyList = document.getElementById('history-list');
            const emptyMessage = document.getElementById('empty-history-message');
            const backButton = document.getElementById('back-button');
            const clearButton = document.getElementById('clear-history-button');
            const backgroundMusicHistory = document.getElementById('background-music'); // [M·ªöI] Tham chi·∫øu ƒë·∫øn audio

            // Kh√≥a localStorage d√πng chung v·ªõi Farm.html
            const HISTORY_SAVE_KEY = 'vuonCayHanhPhuc_v9.2_History';
            // [M·ªöI] Kh√≥a sessionStorage cho tr·∫°ng th√°i nh·∫°c
            const MUSIC_SHOULD_PLAY_KEY = 'musicShouldPlay';
            const MUSIC_CURRENT_TIME_KEY = 'musicCurrentTime';

            // H√†m ƒë·ªãnh d·∫°ng th·ªùi gian (gi·ªØ nguy√™n)
            function formatTimestamp(timestamp) {
                // ... (code ƒë·ªãnh d·∫°ng th·ªùi gian nh∆∞ c≈©) ...
                 if (!timestamp) return 'Kh√¥ng r√µ';
                try {
                    const options = {
                         year: 'numeric', month: 'numeric', day: 'numeric',
                         hour: '2-digit', minute: '2-digit', second: '2-digit',
                         hour12: false
                    };
                   return new Intl.DateTimeFormat('vi-VN', options).format(new Date(timestamp));
                } catch (e) {
                     console.error("L·ªói ƒë·ªãnh d·∫°ng timestamp:", timestamp, e);
                     return new Date(timestamp).toLocaleString('vi-VN'); // Fallback
                }
            }

            // H√†m hi·ªÉn th·ªã l·ªãch s·ª≠ (gi·ªØ nguy√™n)
            function displayHistory() {
                // ... (code hi·ªÉn th·ªã l·ªãch s·ª≠ nh∆∞ c≈©) ...
                historyList.innerHTML = '';
                let historyData = [];
                try {
                    const rawData = localStorage.getItem(HISTORY_SAVE_KEY);
                    if (rawData) {
                        historyData = JSON.parse(rawData);
                        if (!Array.isArray(historyData)) {
                             console.warn("D·ªØ li·ªáu l·ªãch s·ª≠ kh√¥ng ph·∫£i m·∫£ng, ƒë·∫∑t l·∫°i th√†nh m·∫£ng r·ªóng.");
                             historyData = [];
                        }
                    }
                } catch (error) {
                    console.error("L·ªói ph√¢n t√≠ch d·ªØ li·ªáu l·ªãch s·ª≠ t·ª´ localStorage:", error);
                    historyData = [];
                }

                if (historyData.length === 0) {
                    emptyMessage.style.display = 'block';
                    historyList.style.display = 'none';
                } else {
                    emptyMessage.style.display = 'none';
                    historyList.style.display = 'block';
                    historyData.forEach(entry => {
                        const listItem = document.createElement('li');
                        listItem.classList.add('history-entry');
                        listItem.classList.add(`type-${entry.type || 'unknown'}`);

                        const iconSpan = document.createElement('span');
                        iconSpan.classList.add('entry-icon');
                        iconSpan.textContent = entry.icon || '‚ùì';

                        const timeSpan = document.createElement('span');
                        timeSpan.classList.add('entry-time');
                        timeSpan.textContent = formatTimestamp(entry.timestamp);

                        const detailsSpan = document.createElement('span');
                        detailsSpan.classList.add('entry-details');
                        detailsSpan.textContent = entry.details || 'Kh√¥ng c√≥ chi ti·∫øt.';
                        if (entry.plotId !== null && entry.plotId !== undefined) {
                             detailsSpan.textContent += ` (√î ${entry.plotId + 1})`;
                        }

                        listItem.appendChild(iconSpan);
                        listItem.appendChild(timeSpan);
                        listItem.appendChild(detailsSpan);

                        historyList.appendChild(listItem);
                    });
                }
            }

            // --- [C·∫¨P NH·∫¨T] G·∫Øn s·ª± ki·ªán cho n√∫t Quay l·∫°i ---
            if (backButton) {
                backButton.addEventListener('click', () => {
                    console.log("Chu·∫©n b·ªã quay l·∫°i V∆∞·ªùn...");
                    // --- [M·ªöI] L∆∞u tr·∫°ng th√°i nh·∫°c tr∆∞·ªõc khi quay l·∫°i ---
                    if (backgroundMusicHistory && !backgroundMusicHistory.paused) {
                         try {
                             sessionStorage.setItem(MUSIC_SHOULD_PLAY_KEY, 'true');
                             sessionStorage.setItem(MUSIC_CURRENT_TIME_KEY, backgroundMusicHistory.currentTime.toString());
                             console.log(`(History) ƒê√£ l∆∞u tr·∫°ng th√°i nh·∫°c: currentTime=${backgroundMusicHistory.currentTime}`);
                         } catch (e) {
                             console.warn("(History) Kh√¥ng th·ªÉ l∆∞u tr·∫°ng th√°i nh·∫°c:", e);
                             sessionStorage.removeItem(MUSIC_SHOULD_PLAY_KEY);
                             sessionStorage.removeItem(MUSIC_CURRENT_TIME_KEY);
                         }
                    } else {
                         // N·∫øu nh·∫°c kh√¥ng ph√°t, x√≥a c·ªù ƒë·ªÉ Farm.html kh√¥ng t·ª± b·∫≠t nh·∫°c
                         sessionStorage.removeItem(MUSIC_SHOULD_PLAY_KEY);
                         sessionStorage.removeItem(MUSIC_CURRENT_TIME_KEY);
                         console.log("(History) Nh·∫°c kh√¥ng ph√°t, kh√¥ng l∆∞u tr·∫°ng th√°i.");
                    }
                    // -----------------------------------------------------
                    window.location.href = 'Farm.html'; // Chuy·ªÉn v·ªÅ trang Farm
                });
            } else { console.warn("Kh√¥ng t√¨m th·∫•y n√∫t #back-button"); }

            // G·∫Øn s·ª± ki·ªán cho n√∫t X√≥a L·ªãch s·ª≠ (gi·ªØ nguy√™n)
            if (clearButton) {
                clearButton.addEventListener('click', () => {
                    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ ho·∫°t ƒë·ªông kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
                        localStorage.removeItem(HISTORY_SAVE_KEY);
                        displayHistory(); // C·∫≠p nh·∫≠t l·∫°i giao di·ªán
                        alert('L·ªãch s·ª≠ ho·∫°t ƒë·ªông ƒë√£ ƒë∆∞·ª£c x√≥a.');
                    }
                });
            } else { console.warn("Kh√¥ng t√¨m th·∫•y n√∫t #clear-history-button"); }

            // --- [M·ªöI] X·ª≠ l√Ω ph√°t l·∫°i nh·∫°c khi trang t·∫£i ---
            function tryResumeMusic() {
                if (backgroundMusicHistory) {
                    try {
                        const shouldPlay = sessionStorage.getItem(MUSIC_SHOULD_PLAY_KEY);
                        const savedTimeStr = sessionStorage.getItem(MUSIC_CURRENT_TIME_KEY);

                        if (shouldPlay === 'true') {
                            console.log("T√¨m th·∫•y c·ªù musicShouldPlay. Th·ª≠ ph√°t l·∫°i nh·∫°c...");
                            const savedTime = parseFloat(savedTimeStr);

                            if (!isNaN(savedTime) && savedTime >= 0) {
                                // R·∫•t quan tr·ªçng: Ph·∫£i ƒë·ª£i s·ª± ki·ªán 'canplay' ho·∫∑c 'loadedmetadata'
                                // ƒë·ªÉ ƒë·∫£m b·∫£o audio ƒë√£ s·∫µn s√†ng nh·∫≠n l·ªánh seek (thay ƒë·ªïi currentTime)
                                // Tuy nhi√™n, ƒë·ªÉ ƒë∆°n gi·∫£n, ta th·ª≠ ƒë·∫∑t ngay v√† d·ª±a v√†o tr√¨nh duy·ªát x·ª≠ l√Ω.
                                // M·ªôt c√°ch an to√†n h∆°n l√† th√™m listener 'canplay'.
                                try {
                                    backgroundMusicHistory.currentTime = savedTime;
                                    console.log(`ƒê√£ ƒë·∫∑t currentTime th√†nh: ${savedTime}`);
                                } catch (seekError) {
                                    console.warn("L·ªói khi ƒë·∫∑t currentTime (c√≥ th·ªÉ audio ch∆∞a s·∫µn s√†ng):", seekError);
                                    // N·∫øu l·ªói, c√≥ th·ªÉ nh·∫°c s·∫Ω b·∫Øt ƒë·∫ßu t·ª´ ƒë·∫ßu khi play() ƒë∆∞·ª£c g·ªçi
                                }
                            } else {
                                console.log("Th·ªùi gian l∆∞u kh√¥ng h·ª£p l·ªá, nh·∫°c s·∫Ω b·∫Øt ƒë·∫ßu t·ª´ ƒë·∫ßu.");
                            }

                            // Th·ª≠ ph√°t nh·∫°c
                            const playPromise = backgroundMusicHistory.play();

                            if (playPromise !== undefined) {
                                playPromise.then(_ => {
                                    console.log("Nh·∫°c n·ªÅn ƒë√£ t·ª± ƒë·ªông ph√°t l·∫°i.");
                                    // X√≥a c·ªù sau khi ph√°t th√†nh c√¥ng ƒë·ªÉ tr√°nh l·∫∑p l·∫°i khi refresh
                                    sessionStorage.removeItem(MUSIC_SHOULD_PLAY_KEY);
                                    sessionStorage.removeItem(MUSIC_CURRENT_TIME_KEY);
                                })
                                .catch(error => {
                                    console.warn("T·ª± ƒë·ªông ph√°t l·∫°i nh·∫°c n·ªÅn th·∫•t b·∫°i (c·∫ßn t∆∞∆°ng t√°c ng∆∞·ªùi d√πng).", error);
                                    // Kh√¥ng x√≥a c·ªù ·ªü ƒë√¢y, c√≥ th·ªÉ th·ª≠ l·∫°i sau
                                    // C√¢n nh·∫Øc th√™m n√∫t ƒë·ªÉ ng∆∞·ªùi d√πng b·∫•m ph√°t nh·∫°c th·ªß c√¥ng
                                });
                            } else {
                                // Tr√¨nh duy·ªát c≈© kh√¥ng h·ªó tr·ª£ promise, gi·∫£ ƒë·ªãnh l√† ƒë√£ play (ho·∫∑c kh√¥ng th·ªÉ bi·∫øt)
                                sessionStorage.removeItem(MUSIC_SHOULD_PLAY_KEY); // X√≥a c·ªù
                                sessionStorage.removeItem(MUSIC_CURRENT_TIME_KEY);
                            }
                        } else {
                            console.log("Kh√¥ng c√≥ y√™u c·∫ßu ph√°t l·∫°i nh·∫°c (kh√¥ng t√¨m th·∫•y c·ªù ho·∫∑c gi√° tr·ªã sai).");
                            // D·ªçn d·∫πp c·ªù n·∫øu ch√∫ng t·ªìn t·∫°i nh∆∞ng kh√¥ng h·ª£p l·ªá
                            sessionStorage.removeItem(MUSIC_SHOULD_PLAY_KEY);
                            sessionStorage.removeItem(MUSIC_CURRENT_TIME_KEY);
                        }
                    } catch (e) {
                        console.error("L·ªói khi x·ª≠ l√Ω tr·∫°ng th√°i nh·∫°c t·ª´ sessionStorage:", e);
                        sessionStorage.removeItem(MUSIC_SHOULD_PLAY_KEY); // D·ªçn d·∫πp khi c√≥ l·ªói
                        sessionStorage.removeItem(MUSIC_CURRENT_TIME_KEY);
                    }
                } else {
                    console.warn("Kh√¥ng t√¨m th·∫•y th·∫ª audio#background-music tr√™n trang l·ªãch s·ª≠.");
                    sessionStorage.removeItem(MUSIC_SHOULD_PLAY_KEY); // D·ªçn d·∫πp
                    sessionStorage.removeItem(MUSIC_CURRENT_TIME_KEY);
                }
            }
            // --- K·∫øt th√∫c x·ª≠ l√Ω ph√°t l·∫°i nh·∫°c ---

            // Hi·ªÉn th·ªã l·ªãch s·ª≠ khi trang t·∫£i xong
            displayHistory();
            // Th·ª≠ ph√°t l·∫°i nh·∫°c sau khi hi·ªÉn th·ªã l·ªãch s·ª≠
            tryResumeMusic();

        });
    </script>

</body>
</html>